<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Report Analyzer - Enterprise v5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg-dark: #1e1e2f; 
            --sidebar-width: 260px;
            --code-bg: #2d2d3b;
        }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        /* Layout */
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px 20px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-link.active { border-left-color: #0d6efd; background: rgba(255,255,255,0.1); }
        
        .main-content { flex: 1; overflow-y: auto; padding: 25px; position: relative; }
        
        /* Components */
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; }
        .console-box { background: var(--code-bg); color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        /* Upload */
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; }
        .upload-box { border: 2px dashed #ccc; padding: 50px; border-radius: 12px; background: #fff; text-align: center; cursor: pointer; transition: 0.2s; }
        .upload-box:hover { border-color: #0d6efd; background: #f8fbff; }

        /* Log Explorer Specifics */
        .log-container { display: flex; height: calc(100vh - 100px); gap: 20px; }
        .log-list { width: 300px; background: #fff; border-radius: 8px; overflow-y: auto; flex-shrink: 0; border: 1px solid #ddd; }
        .log-viewer-pane { flex: 1; display: flex; flex-direction: column; background: #fff; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; }
        .log-group-title { padding: 8px 15px; background: #f8f9fa; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; color: #666; border-bottom: 1px solid #eee; border-top: 1px solid #eee; }
        .log-item { padding: 8px 20px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f1f1f1; }
        .log-item:hover { background: #f0f8ff; color: #0d6efd; }
        .log-item.active { background: #0d6efd; color: #fff; }
        .log-content { flex: 1; padding: 15px; overflow: auto; background: #1e1e1e; color: #ccc; font-family: monospace; font-size: 0.85rem; white-space: pre; }
        
        .hidden { display: none !important; }
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">RHEL SOS Analyzer v5</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ“Š ç¸½è¦½ (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">ğŸ–¥ï¸ ç³»çµ±æ·±åº¦è©•ä¼°</a>
            <a class="nav-link" onclick="switchTab('logs')">ğŸ“ æ—¥èªŒç€è¦½å™¨ (Logs)</a>
            <a class="nav-link" onclick="switchTab('network')">ğŸŒ ç¶²è·¯ç‹€æ…‹ (Network)</a>
        </nav>
    </div>

    <div class="main-content">
        
        <div id="loader" class="loading-overlay hidden">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="mt-2 fw-bold" id="loader-msg">Processing...</div>
        </div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="fs-1 mb-2">ğŸ“‚</div>
                <h4>ä¸Šå‚³ SOS Report ç›®éŒ„</h4>
                <p class="text-muted small">é¸æ“‡è§£å£“ç¸®å¾Œçš„è³‡æ–™å¤¾<br>æ”¯æ´æ‰€æœ‰ RHEL ç‰ˆæœ¬çµæ§‹</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ¦‚è§€</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header">Top Memory Processes</div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" id="mem-table" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>COMMAND</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card h-100">
                        <div class="card-header">Last Boot Messages (dmesg tail)</div>
                        <div class="card-body bg-dark text-light p-2" style="font-family:monospace; font-size:0.8rem; overflow:hidden;">
                            <div id="dash-dmesg-preview">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ·±åº¦è©•ä¼°</h4>
            <div class="card">
                <div class="card-header">1. ç¡¬é«”èˆ‡ BIOS (dmidecode)</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between"><span>Model:</span> <strong id="info-model">-</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>Vendor:</span> <strong id="info-vendor">-</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>BIOS:</span> <strong id="info-bios">-</strong></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                             <h6>PCI Devices (Storage/Net/VGA)</h6>
                             <div class="console-box" id="info-pci" style="height:150px">Pending...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">2. æ ¸å¿ƒèˆ‡å®‰å…¨æ€§ (Kernel & Security)</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>SELinux:</strong> <span id="info-selinux">-</span><br>
                            <strong>Tainted:</strong> <span id="info-tainted">-</span>
                        </div>
                        <div class="col-md-8">
                            <h6>Sysctl Parameters (Key Values)</h6>
                            <div id="sysctl-box" class="small text-muted">Scanning...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">3. ä¸­ä»‹è»Ÿé«” (Middleware)</div>
                <div class="card-body">
                    <div class="console-box" id="info-middleware">Scanning processes...</div>
                </div>
            </div>
        </div>

        <div id="view-logs" class="content-view hidden">
            <h4 class="mb-3">æ—¥èªŒç€è¦½å™¨ (Log Explorer)</h4>
            <div class="log-container">
                <div class="log-list" id="log-list-container">
                    <div class="p-3 text-center text-muted">è«‹å…ˆä¸Šå‚³æª”æ¡ˆ</div>
                </div>
                
                <div class="log-viewer-pane">
                    <div class="p-2 border-bottom bg-light d-flex justify-content-between align-items-center">
                        <strong id="current-log-name">No file selected</strong>
                        <input type="text" id="log-search" class="form-control form-control-sm w-25" placeholder="Search in file..." onkeyup="filterLogView()">
                    </div>
                    <div class="log-content" id="log-content-area"></div>
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
            <h4 class="mb-3">ç¶²è·¯åˆ†æ</h4>
            <div class="card">
                <div class="card-header">Listening Ports (ss -tulpn)</div>
                <div class="card-body">
                    <div class="console-box" id="net-ss">Searching for ss output...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">IP Addresses (ip addr)</div>
                <div class="card-body">
                    <div class="console-box" id="net-ip">Searching...</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Core State ---
        const AppState = {
            filesMap: new Map(),  // Map<PathString, FileObject>
            filesList: [],        // Array of PathStrings for searching
            rootPrefix: '',
            cache: {},
            currentLogText: ''
        };

        // --- File Handling ---
        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length === 0) return;

            toggleLoader(true, "å»ºç«‹æª”æ¡ˆç´¢å¼•...");
            
            // Reset
            AppState.filesMap.clear();
            AppState.filesList = [];
            AppState.cache = {};

            // Indexing
            for (let f of files) {
                // Remove the top-level folder name to normalize searching
                // e.g. "sosreport-x/etc/hosts" -> "etc/hosts"
                const pathParts = f.webkitRelativePath.split('/');
                const relativePath = pathParts.slice(1).join('/'); 
                
                AppState.filesMap.set(relativePath, f);
                AppState.filesList.push(relativePath);
            }

            console.log(`Indexed ${AppState.filesList.length} files.`);

            try {
                await analyzeDashboard();
                await analyzeHostInfo();
                await analyzeNetwork();
                populateLogExplorer(); // Build the tree
                
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("è§£æç™¼ç”ŸéŒ¯èª¤: " + err.message);
            } finally {
                toggleLoader(false);
            }
        });

        // --- Smart File Search Engine ---
        // è§£æ±ºè·¯å¾‘ä¸ä¸€è‡´å•é¡Œçš„æ ¸å¿ƒ
        async function getFileContent(searchPattern) {
            // 1. Try Exact Match
            if (AppState.filesMap.has(searchPattern)) {
                return await readFileText(AppState.filesMap.get(searchPattern));
            }

            // 2. Try Fuzzy Path Match (e.g. "ss_-tulpn" inside "sos_commands/networking/")
            // We search for files that END with the searchPattern or contain it significantly
            const foundKey = AppState.filesList.find(path => {
                return path.includes(searchPattern) || path.endsWith('/' + searchPattern);
            });

            if (foundKey) {
                console.log(`Found [${searchPattern}] at [${foundKey}]`);
                return await readFileText(AppState.filesMap.get(foundKey));
            }

            console.warn(`File pattern not found: ${searchPattern}`);
            return null;
        }

        async function readFileText(fileObj) {
            if (!fileObj) return null;
            if (AppState.cache[fileObj.name]) return AppState.cache[fileObj.name];
            const text = await fileObj.text();
            AppState.cache[fileObj.name] = text;
            return text;
        }

        // --- Modules ---

        async function analyzeDashboard() {
            // Hostname
            const hostname = await getFileContent('hostname') || "Unknown";
            setText('dash-hostname', hostname.trim());

            // Release
            const release = await getFileContent('etc/redhat-release') || await getFileContent('redhat-release');
            setText('dash-release', release ? release.trim() : "Unknown");

            // Uptime
            const uptime = await getFileContent('uptime');
            setText('dash-uptime', uptime ? uptime.trim() : "-");

            // Kernel
            const uname = await getFileContent('uname_-a');
            setText('dash-kernel', uname ? uname.trim() : "-");
        }

        async function analyzeHostInfo() {
            // DMI
            const dmi = await getFileContent('dmidecode');
            if (dmi) {
                setText('info-model', (dmi.match(/Product Name:\s*(.+)/) || [])[1] || '-');
                setText('info-vendor', (dmi.match(/Manufacturer:\s*(.+)/) || [])[1] || '-');
                setText('info-bios', (dmi.match(/Version:\s*(.+)/) || [])[1] || '-');
            }

            // SELinux
            const sestatus = await getFileContent('sestatus');
            const selinuxMode = sestatus ? (sestatus.match(/Current mode:\s*(.+)/) || [])[1] : 'Unknown';
            setText('info-selinux', selinuxMode);

            // Tainted
            const tainted = await getFileContent('kernel.tainted') || await getFileContent('sysctl_-a');
            let taintedVal = "0";
            if (tainted) {
                 const m = tainted.match(/kernel.tainted\s*=\s*(\d+)/);
                 if (m) taintedVal = m[1];
                 else if (tainted.trim().match(/^\d+$/)) taintedVal = tainted.trim();
            }
            setText('info-tainted', taintedVal === "0" ? "0 (Not Tainted)" : `${taintedVal} (Tainted)`);

            // Middleware
            const ps = await getFileContent('ps_auxww') || await getFileContent('ps_aux');
            if (ps) {
                const lines = ps.split('\n');
                // Dashboard Memory Table
                const sorted = lines.slice(1)
                    .map(l => {
                        const p = l.trim().split(/\s+/);
                        if (p.length < 10) return null;
                        return { pid: p[1], user: p[0], mem: parseFloat(p[3]), cmd: p.slice(10).join(' ') };
                    })
                    .filter(x => x && !isNaN(x.mem))
                    .sort((a,b) => b.mem - a.mem)
                    .slice(0, 5);
                
                const tbody = document.querySelector('#mem-table tbody');
                tbody.innerHTML = sorted.map(r => `<tr><td>${r.pid}</td><td>${r.user}</td><td>${r.mem}%</td><td class="text-truncate" style="max-width:150px">${r.cmd}</td></tr>`).join('');

                // Middleware List
                const apps = lines.filter(l => l.match(/java|python|node|postgres|mysql|httpd|nginx|docker|kube/i)).slice(0, 50).join('\n');
                setText('info-middleware', apps || "No standard middleware processes found.");
            }

            // Sysctl
            const sysctl = await getFileContent('sysctl_-a');
            if (sysctl) {
                const interest = ['net.ipv4.ip_forward', 'vm.swappiness', 'fs.file-max', 'kernel.pid_max'];
                let html = '';
                interest.forEach(k => {
                    const m = sysctl.match(new RegExp(`${k.replace(/\./g, '\\.')}\\s*=\s*(.+)`));
                    if (m) html += `<div>${k} = <strong>${m[1]}</strong></div>`;
                });
                document.getElementById('sysctl-box').innerHTML = html || "Not found";
            }

            // PCI
            const lspci = await getFileContent('lspci_-nnvv');
            if (lspci) {
                const short = lspci.split('\n').filter(l => l.match(/Host bridge|VGA|Ethernet|RAID/)).join('\n');
                setText('info-pci', short);
            }
        }

        async function analyzeNetwork() {
            // Fix for SS -tulpn
            // Search specifically for the command name in the filename
            const ss = await getFileContent('ss_-tulpn');
            if (ss) {
                setText('net-ss', ss);
            } else {
                setText('net-ss', "Command output 'ss -tulpn' not found in report.");
            }

            const ip = await getFileContent('ip_-o_addr') || await getFileContent('ip_addr');
            setText('net-ip', ip || "IP info not found");
        }

        // --- Enhanced Log Explorer ---
        function populateLogExplorer() {
            const listContainer = document.getElementById('log-list-container');
            listContainer.innerHTML = '';

            // Categorization Rules
            const categories = {
                "System": [/var\/log\/messages.*/, /var\/log\/boot.*/, /dmesg/],
                "Security": [/var\/log\/secure.*/, /var\/log\/audit\/audit.*/],
                "Package": [/var\/log\/dnf.*/, /var\/log\/yum.*/],
                "Cron": [/var\/log\/cron.*/],
                "Others": [] // Fallback
            };

            const foundFiles = { "System": [], "Security": [], "Package": [], "Cron": [], "Others": [] };

            // Scan files
            AppState.filesList.forEach(path => {
                // We only care about var/log or sos_commands/logs
                if (!path.includes('var/log') && !path.includes('sos_commands/logs')) return;
                
                // Skip binaries usually found in logs dir (wtmp, etc)
                if (path.endsWith('.gz') || path.endsWith('wtmp') || path.endsWith('lastlog')) return;

                let assigned = false;
                for (let cat in categories) {
                    if (cat === "Others") continue;
                    if (categories[cat].some(regex => regex.test(path))) {
                        foundFiles[cat].push(path);
                        assigned = true;
                        break;
                    }
                }
                if (!assigned && path.includes('var/log')) foundFiles["Others"].push(path);
            });

            // Render List
            for (let cat in foundFiles) {
                if (foundFiles[cat].length === 0) continue;
                
                // Group Title
                const title = document.createElement('div');
                title.className = 'log-group-title';
                title.textContent = cat;
                listContainer.appendChild(title);

                // Sort files (so messages comes before messages-2024...)
                foundFiles[cat].sort();

                foundFiles[cat].forEach(path => {
                    const item = document.createElement('div');
                    item.className = 'log-item';
                    item.textContent = path.split('/').pop(); // Show just filename
                    item.title = path; // Tooltip full path
                    item.onclick = () => loadLogFile(path, item);
                    listContainer.appendChild(item);
                });
            }
        }

        async function loadLogFile(path, clickedElement) {
            // UI Active State
            document.querySelectorAll('.log-item').forEach(el => el.classList.remove('active'));
            if (clickedElement) clickedElement.classList.add('active');

            document.getElementById('current-log-name').textContent = path;
            const viewer = document.getElementById('log-content-area');
            viewer.textContent = "Loading large file...";

            // Load Content
            const file = AppState.filesMap.get(path);
            let text = await readFileText(file);
            
            // Safety limit for browser
            const maxLines = 10000;
            const lines = text.split('\n');
            if (lines.length > maxLines) {
                text = `[Warning: File too large, showing last ${maxLines} lines]\n...\n` + lines.slice(-maxLines).join('\n');
            }

            AppState.currentLogText = text;
            viewer.textContent = text;
            // Scroll to bottom typically for logs
            viewer.scrollTop = viewer.scrollHeight;
        }

        function filterLogView() {
            const term = document.getElementById('log-search').value.toLowerCase();
            const viewer = document.getElementById('log-content-area');
            
            if (!term) {
                viewer.textContent = AppState.currentLogText;
                return;
            }

            // Simple line filtering
            const lines = AppState.currentLogText.split('\n');
            const filtered = lines.filter(l => l.toLowerCase().includes(term));
            viewer.textContent = filtered.join('\n');
        }

        // --- Utils ---
        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            // Find nav item by partial match of onclick string
            Array.from(document.querySelectorAll('.nav-link')).find(e => e.getAttribute('onclick').includes(id)).classList.add('active');
        }

        function toggleLoader(show, msg) {
            const l = document.getElementById('loader');
            if (show) {
                l.classList.remove('hidden');
                if(msg) document.getElementById('loader-msg').textContent = msg;
            } else {
                l.classList.add('hidden');
            }
        }

        function setText(id, txt) {
            const el = document.getElementById(id);
            if (el) el.textContent = txt;
        }

    </script>
</body>
</html>