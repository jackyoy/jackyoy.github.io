<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Report Analyzer (Light Mode)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        
        /* å€å¡Šæ¨£å¼å„ªåŒ– */
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 2px solid #f0f0f0; font-weight: 700; color: #2c3e50; }
        
        /* ä¸Šå‚³å€å¡Šå„ªåŒ– */
        .upload-area { border: 2px dashed #adb5bd; border-radius: 12px; padding: 40px; text-align: center; background: #fff; cursor: pointer; transition: all 0.3s ease; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f8fbff; transform: translateY(-2px); }
        
        /* è¡¨æ ¼å„ªåŒ– */
        .table thead th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; color: #555; font-size: 0.85rem; text-transform: uppercase; }
        .table tbody td { vertical-align: middle; }
        
        /* Debug Console å„ªåŒ– (ä¿æŒæ·±è‰²ä»¥å€åˆ†) */
        .debug-console { background: #212529; color: #00ff00; font-family: 'Consolas', monospace; font-size: 0.85rem; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; margin-top: 20px; }
        .log-warn { color: #ffc107; } .log-err { color: #ff6b6b; } .log-info { color: #81d4fa; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0">RHEL SOS Analyzer</h2>
            <small class="text-muted">æœ¬æ©Ÿè§£æå·¥å…· v4.0 (Fix: PS Parsing & UI Contrast)</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">é‡ç½®</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">ğŸ“‚</div>
                <h4>é»æ“Šé¸æ“‡ sosreport è³‡æ–™å¤¾</h4>
                <p class="text-muted">æ”¯æ´ RHEL 7/8/9 æ ¼å¼ (è³‡æ–™åƒ…åœ¨æœ¬æ©Ÿé‹ç®—ï¼Œä¸æœƒä¸Šå‚³)</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1 mb-0">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2 mb-0">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 mb-0">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2 mb-0">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px; position: relative;">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top Processes (CPU)</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>PID</th>
                                        <th>User</th>
                                        <th>CPU%</th>
                                        <th>Command</th>
                                    </tr>
                                </thead>
                                <tbody id="ps-tbody">
                                    <tr><td colspan="4" class="text-center text-muted py-3">ç­‰å¾…è§£æ...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h6 class="fw-bold text-secondary">ç³»çµ±æ—¥èªŒ (Debug Console)</h6>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];

    // --- Logging Helper ---
    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        d.innerHTML = `<span style="opacity:0.6">[${time}]</span> ${msg}`;
        if (type === 'warn') d.className = 'log-warn';
        if (type === 'err') d.className = 'log-err';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    // --- File Handling ---
    async function handleFiles(files) {
        if (files.length === 0) return;

        // UI Reset
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        
        log(`æ¥æ”¶åˆ° ${files.length} å€‹æª”æ¡ˆï¼Œæ­£åœ¨å»ºç«‹ç´¢å¼•...`);

        // Indexing
        fileMap.clear();
        filePaths = [];
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }
        log("ç´¢å¼•å»ºç«‹å®Œæˆã€‚", "info");

        // Execution
        try {
            await parseOS();
            await parseMemory();
            await parseProcess(); // é‡é»ä¿®å¾©
            await parseNetwork();
            log("ğŸ‰ æ‰€æœ‰åˆ†æå·¥ä½œå·²å®Œæˆã€‚", "info");
        } catch (e) {
            log(`âŒ å…¨åŸŸéŒ¯èª¤: ${e.message}`, "err");
            console.error(e);
        }
    }

    // --- Universal Finder ---
    function findFileAndRead(filenameKeywords) {
        return new Promise((resolve) => {
            const keywords = Array.isArray(filenameKeywords) ? filenameKeywords : [filenameKeywords];
            let targetPath = null;

            // 1. Endswith Match (ç²¾ç¢º)
            for (const kw of keywords) {
                targetPath = filePaths.find(p => p.endsWith(`/${kw}`));
                if (targetPath) break;
            }
            // 2. Includes Match (å¯¬é¬†ï¼Œæ’é™¤ .xz)
            if (!targetPath) {
                for (const kw of keywords) {
                    targetPath = filePaths.find(p => p.includes(kw) && !p.endsWith('.xz'));
                    if (targetPath) break;
                }
            }

            if (!targetPath) {
                log(`âš ï¸ æ‰¾ä¸åˆ°æª”æ¡ˆé—œéµå­—: [${keywords.join(', ')}]`, "warn");
                resolve(null);
                return;
            }

            log(`è®€å–æª”æ¡ˆ: ...${targetPath.slice(-40)}`); // åªé¡¯ç¤ºè·¯å¾‘å¾Œæ®µ
            const file = fileMap.get(targetPath);
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Parsers ---

    async function parseOS() {
        const hostname = await findFileAndRead('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        const release = await findFileAndRead(['os-release', 'redhat-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        const uname = await findFileAndRead('uname');
        if (uname) {
            const p = uname.split(' ');
            if (p.length > 2) document.getElementById('os-kernel').textContent = p[2];
        }

        const uptime = await findFileAndRead('uptime');
        if (uptime) {
             const m = uptime.match(/up\s+([^,]+)/);
             if (m) document.getElementById('os-uptime').textContent = m[1];
        }
    }

    async function parseMemory() {
        const data = await findFileAndRead('meminfo');
        if (!data) return;

        const getVal = (k) => {
            const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm'));
            return m ? parseInt(m[1]) : 0;
        };

        const total = getVal('MemTotal');
        const free = getVal('MemFree');
        const buffers = getVal('Buffers');
        const cached = getVal('Cached');
        const slab = getVal('Slab');
        
        // ç°¡å–®è¨ˆç®—
        const used = total - free - buffers - cached - slab;
        const totalGB = (total/1024/1024).toFixed(1);

        document.getElementById('mem-total-badge').textContent = `${totalGB} GB`;

        const ctx = document.getElementById('memChart').getContext('2d');
        if (window.memChartInstance) window.memChartInstance.destroy();

        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buffer/Cache', 'Free'],
                datasets: [{
                    data: [used, buffers+cached+slab, free],
                    backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // é‡ç‚¹ä¿®å¾©ï¼šProcess Parser
    async function parseProcess() {
        // åŠ å…¥ ps_auxwwwm (å¸¸è¦‹æ–¼ RHEL sosreport), ps_auxww, ps_aux, ä»¥åŠå–®ç´” ps
        const data = await findFileAndRead(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps']);
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = '';

        if (!data) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ç„¡ PS è³‡æ–™</td></tr>';
            return;
        }

        const lines = data.split('\n');
        let procs = [];
        let headersFound = false;
        let cpuIdx = -1, memIdx = -1, userIdx = -1, pidIdx = -1, cmdIdx = -1;

        // 1. å‹•æ…‹å°‹æ‰¾ Header è¡Œ (å› ç‚º ps è¼¸å‡ºæœ‰æ™‚æœƒåŒ…å«è¨»è§£)
        // Header é€šå¸¸åŒ…å« "USER" "PID" "%CPU"
        for (let i = 0; i < Math.min(lines.length, 20); i++) {
            const line = lines[i].trim();
            if (line.includes('USER') && line.includes('PID')) {
                const parts = line.split(/\s+/);
                userIdx = parts.indexOf('USER');
                pidIdx = parts.indexOf('PID');
                // æœ‰äº›ç‰ˆæœ¬æ˜¯ %CPU, æœ‰äº›æ˜¯ CPU
                cpuIdx = parts.findIndex(p => p.includes('CPU')); 
                memIdx = parts.findIndex(p => p.includes('MEM'));
                cmdIdx = parts.indexOf('COMMAND'); // æˆ–è€…æ˜¯ CMD
                if (cmdIdx === -1) cmdIdx = parts.indexOf('CMD');
                
                // å¦‚æœæ‰¾ä¸åˆ°æ˜ç¢ºçš„ COMMAND æ¬„ä½ï¼Œé€šå¸¸å‡è¨­æ˜¯æœ€å¾Œä¸€æ¬„ (é€šå¸¸æ˜¯ç¬¬ 10 æˆ– 11 æ¬„)
                if (cmdIdx === -1) cmdIdx = 10; 

                headersFound = true;
                log(`æ‰¾åˆ° PS Header æ–¼ç¬¬ ${i+1} è¡Œ: CPUåœ¨æ¬„ä½ ${cpuIdx}`, 'info');
                break;
            }
        }

        // å¦‚æœæ²’æ‰¾åˆ° Headerï¼Œä½¿ç”¨é è¨­å€¼ (æ¨™æº– ps aux)
        if (!headersFound) {
            log("æœªæ‰¾åˆ° PS Headerï¼Œä½¿ç”¨é è¨­æ¬„ä½ç´¢å¼•", 'warn');
            userIdx = 0; pidIdx = 1; cpuIdx = 2; memIdx = 3; cmdIdx = 10;
        }

        // 2. è§£æè³‡æ–™
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.includes('USER') && line.includes('PID')) continue;

            const parts = line.split(/\s+/);
            // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
            if (parts.length < 10) continue;

            // è™•ç† Command å¯èƒ½è¢« split åˆ‡é–‹çš„å•é¡Œ
            const cmdParts = parts.slice(cmdIdx);
            const cmdFull = cmdParts.join(' ');

            procs.push({
                user: parts[userIdx],
                pid: parts[pidIdx],
                cpu: parseFloat(parts[cpuIdx]) || 0,
                cmd: cmdFull
            });
        }

        if (procs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">ç„¡æ³•è§£æ PS å…§å®¹æ ¼å¼</td></tr>';
            return;
        }

        // 3. æ’åºèˆ‡é¡¯ç¤º
        procs.sort((a, b) => b.cpu - a.cpu);
        
        // é¡¯ç¤ºå‰ 5 å
        procs.slice(0, 5).forEach(p => {
            // å° command é€²è¡Œæˆªæ–·è™•ç†ï¼Œé¿å…å¤ªé•·
            const shortCmd = p.cmd.length > 50 ? p.cmd.substring(0, 50) + '...' : p.cmd;
            const row = `
                <tr>
                    <td><span class="badge bg-light text-dark border">${p.pid}</span></td>
                    <td>${p.user}</td>
                    <td class="fw-bold text-danger">${p.cpu}%</td>
                    <td title="${p.cmd}"><small class="text-muted">${shortCmd}</small></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        
        log(`æˆåŠŸè§£æ ${procs.length} å€‹è¡Œç¨‹ï¼Œé¡¯ç¤º Top 5ã€‚`, 'info');
    }

    async function parseNetwork() {
        const data = await findFileAndRead(['ip_address', 'ip_addr', 'ip_-d_address']);
        const list = document.getElementById('net-list');
        list.innerHTML = '';

        if (!data) {
            list.innerHTML = '<div class="p-3 text-muted text-center">ç„¡ç¶²è·¯è³‡æ–™</div>';
            return;
        }

        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const name = match[1];
            const state = match[2];
            const isUp = state === 'UP';
            
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-dark">${name}</span>
                    <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${state}</span>
                </div>`;
        }
    }

</script>
</body>
</html>