<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v9 (Multi-Log & Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: #333; }
        
        /* ä»‹é¢å„ªåŒ– */
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 24px; border-radius: 8px; }
        .card-header { background-color: #fff; border-bottom: 2px solid #f1f3f5; font-weight: 700; color: #495057; padding: 16px; }
        .card-body { padding: 20px; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area { border: 2px dashed #ced4da; border-radius: 12px; padding: 40px; text-align: center; background: #fff; cursor: pointer; transition: all 0.2s; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f8fbff; transform: scale(1.01); }
        
        /* Log Viewer */
        .log-container { background: #212529; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; height: 500px; }
        .log-viewer { flex: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 0.85rem; color: #e9ecef; white-space: pre-wrap; }
        .log-line { border-bottom: 1px solid #343a40; padding: 2px 0; }
        .log-line:hover { background-color: #343a40; }
        .log-err { color: #ff6b6b; font-weight: bold; background: rgba(255, 107, 107, 0.1); }
        .log-warn { color: #fcc419; font-weight: bold; }
        .log-date { color: #4dabf7; margin-right: 8px; }

        /* Debug Console */
        .debug-console { background: #000; color: #2ecc71; font-family: monospace; font-size: 0.75rem; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; margin-top: 20px; }
        .dbg-err { color: #fa5252; } .dbg-warn { color: #fab005; } .dbg-info { color: #adb5bd; }

        /* Chart */
        .chart-wrapper { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-0">RHEL SOS Analyzer</h3>
            <small class="text-muted">v9.0 (æ”¯æ´å¤šé‡ Log èˆ‡ Process è§£æä¿®å¾©)</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">ğŸ“‚</div>
                <h4>é¸æ“‡ sosreport è³‡æ–™å¤¾</h4>
                <p class="text-muted">å°‡è‡ªå‹•æƒææ‰€æœ‰æ­·å² Log (messages-*, dmesg...)</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 text-break">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top CPU Processes</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 small align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 20%">PID</th>
                                        <th style="width: 25%">User</th>
                                        <th style="width: 20%">CPU%</th>
                                        <th>Command</th>
                                    </tr>
                                </thead>
                                <tbody id="ps-tbody">
                                    <tr><td colspan="4" class="text-center text-muted py-3">ç­‰å¾…åˆ†æ...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 290px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <span>System Logs Analysis</span>
                        <div class="d-flex gap-2">
                            <select id="log-selector" class="form-select form-select-sm" style="min-width: 250px;" onchange="renderLog()">
                                <option value="" disabled selected>æƒæä¸­...</option>
                            </select>
                            <input type="text" id="log-search" class="form-control form-control-sm" placeholder="é—œéµå­—éæ¿¾ (Enter)" style="width: 150px;" onkeyup="filterLog()">
                        </div>
                    </div>
                    <div class="card-body p-0 bg-dark">
                        <div class="log-container">
                            <div id="log-viewer" class="log-viewer"></div>
                        </div>
                        <div class="bg-secondary text-white px-3 py-1 small d-flex justify-content-between">
                            <span id="log-status">Ready</span>
                            <span>é¡¯ç¤ºæœ€å¾Œ 2000 è¡Œ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <div class="d-flex justify-content-between">
            <h6 class="fw-bold text-secondary">ç³»çµ±æ—¥èªŒ (Debug)</h6>
            <small class="text-muted" style="cursor:pointer" onclick="document.getElementById('console').innerHTML=''">Clear</small>
        </div>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];
    let logCache = {}; // Cache for log contents

    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.textContent = `> ${msg}`;
        if (type === 'err') d.className = 'dbg-err';
        if (type === 'warn') d.className = 'dbg-warn';
        if (type === 'debug') d.className = 'dbg-info';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        // UI Reset
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        logCache = {};

        log(`è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆç‰©ä»¶...`);
        
        fileMap.clear();
        filePaths = [];
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }

        log("ç´¢å¼•å»ºç«‹å®Œæˆï¼Œé–‹å§‹éåŒæ­¥åˆ†æ...", "debug");

        try {
            await Promise.all([
                parseOS(),
                parseMemory(),
                parseProcess(),
                parseNetwork(),
                initLogSystem() // æ–°çš„ Log ç³»çµ±
            ]);
            log("ğŸ‰ æ‰€æœ‰æ¨¡çµ„åŸ·è¡Œå®Œç•¢", "info");
        } catch (e) {
            log(`âŒ ä¸»æµç¨‹éŒ¯èª¤: ${e.message}`, "err");
            console.error(e);
        }
    }

    // --- Helpers ---
    async function findFile(keywords, checkFn = null) {
        const kwList = Array.isArray(keywords) ? keywords : [keywords];
        // Priority 1: sos_commands
        let candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`) || p.endsWith(kw)) && p.includes('sos_commands'));
        // Priority 2: endsWith
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`)));
        // Priority 3: includes (fuzzy)
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.includes(kw) && !p.endsWith('.xz')));

        for (const path of candidates) {
            const content = await readFileText(fileMap.get(path));
            if (!content) continue;
            if (checkFn && !checkFn(content)) continue;
            log(`è®€å–: ...${path.slice(-40)}`, 'debug');
            return content;
        }
        return null;
    }

    // æ–°å¢ï¼šæœå°‹æ‰€æœ‰ç¬¦åˆç‰¹å¾µçš„æª”æ¡ˆ (ç”¨æ–¼ Logs)
    function findFilesByRegex(regex) {
        return filePaths.filter(p => regex.test(p) && !p.endsWith('.xz') && !p.endsWith('.gz'));
    }

    function readFileText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Parsers ---

    async function parseOS() {
        const hostname = await findFile('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        const release = await findFile(['redhat-release', 'os-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        const uname = await findFile(['uname_-a', 'uname']);
        if (uname) {
            const m = uname.match(/(\d+\.\d+\.\d+-\S+)/); 
            document.getElementById('os-kernel').textContent = m ? m[1] : (uname.split(/\s+/)[2] || uname);
        }

        const uptime = await findFile(['uptime', 'date'], c => c.includes('up'));
        if (uptime) {
            const m = uptime.match(/up\s+([^,]+)/);
            if (m) document.getElementById('os-uptime').textContent = m[1];
        }
    }

    async function parseMemory() {
        const data = await findFile('meminfo');
        if (!data) return;
        const val = (k) => { const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm')); return m ? parseInt(m[1]) : 0; };
        const total = val('MemTotal'), free = val('MemFree'), buff = val('Buffers'), cached = val('Cached'), slab = val('Slab');
        const used = total - free - buff - cached - slab;
        
        document.getElementById('mem-total-badge').textContent = (total/1024/1024).toFixed(1) + " GB";

        if (window.memChartInstance) window.memChartInstance.destroy();
        const ctx = document.getElementById('memChart').getContext('2d');
        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buff/Cache', 'Free'],
                datasets: [{ data: [used, buff+cached+slab, free], backgroundColor: ['#dc3545', '#ffc107', '#198754'], borderWidth: 1 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    async function parseProcess() {
        // é‡å¤§ä¿®æ­£ï¼šå¯¬å®¹æ¨¡å¼è§£æ PS
        const data = await findFile(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps'], c => c.includes('PID'));
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = '';

        if (!data) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ç„¡ PS è³‡æ–™</td></tr>';
            return;
        }

        const lines = data.split('\n');
        log(`PS Parser: è®€å–åˆ° ${lines.length} è¡Œ`, 'debug');

        let procs = [];
        // é è¨­æ¬„ä½ (PID usually 1, CPU usually 2, Command usually last)
        // ps aux: USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND
        
        let validCount = 0;
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.startsWith('USER') || line.includes('PID')) continue;

            const parts = line.split(/\s+/);
            
            // å¯¬å®¹æª¢æŸ¥ï¼šåªè¦å¤§æ–¼ 7 å€‹æ¬„ä½å°±å˜—è©¦è§£æ (æŸäº› Kernel Thread æ¬„ä½å¾ˆå°‘)
            if (parts.length < 7) continue;

            // ç°¡å–®æ¨æ–·
            const user = parts[0];
            const pid = parts[1];
            const cpu = parseFloat(parts[2]);
            
            // æŠ“å– Command (å¾ç¬¬ 10 æ¬„é–‹å§‹å¾€å¾Œæ‰€æœ‰å…§å®¹)
            // å¦‚æœ parts é•·åº¦ä¸å¤  11ï¼Œå°±æŠ“æœ€å¾Œä¸€å€‹
            const cmdStartIdx = 10; 
            const cmd = parts.length > cmdStartIdx ? parts.slice(cmdStartIdx).join(' ') : parts[parts.length-1];

            // æ’é™¤ Kernel Threads (é€šå¸¸ä»¥ [ é–‹é ­) ä»¥èšç„¦åœ¨ User Space
            // if (cmd.startsWith('[')) continue; 

            if (!isNaN(cpu)) {
                procs.push({ user, pid, cpu, cmd });
                validCount++;
            }
        }

        log(`PS Parser: æˆåŠŸè§£æ ${validCount} å€‹è¡Œç¨‹`, 'debug');

        if (procs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-warning">è§£æå¤±æ•— (æ ¼å¼ä¸ç¬¦)</td></tr>';
            return;
        }

        procs.sort((a,b) => b.cpu - a.cpu).slice(0, 5).forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-light text-dark border">${p.pid}</span></td>
                <td>${p.user}</td>
                <td class="fw-bold text-danger">${p.cpu}%</td>
                <td class="text-truncate" style="max-width: 180px;" title=""></td>
            `;
            // å®‰å…¨æ’å…¥ Command
            row.querySelector('.text-truncate').textContent = p.cmd; 
            row.querySelector('.text-truncate').title = p.cmd;
            tbody.appendChild(row);
        });
    }

    async function parseNetwork() {
        const data = await findFile(['ip_address', 'ip_addr', 'ip_-d_address'], c => c.includes('state'));
        const list = document.getElementById('net-list');
        list.innerHTML = '';
        if (!data) return;

        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const isUp = match[2] === 'UP';
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span class="fw-bold">${match[1]}</span>
                    <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${match[2]}</span>
                </div>`;
        }
    }

    // --- Log System (Fix: Multiple Logs) ---
    async function initLogSystem() {
        const selector = document.getElementById('log-selector');
        selector.innerHTML = '<option value="" disabled selected>é¸æ“‡ Log æª”æ¡ˆ...</option>';

        // Regex: åŒ¹é… messages, dmesg, secure, cron åŠå…¶è¼ªæ›¿æª” (å¦‚ messages-20231201)
        // æ’é™¤ .xz å£“ç¸®æª”
        const logPaths = findFilesByRegex(/.*\/(messages|dmesg|secure|cron|boot\.log|yum\.log|dnf\.log)([-\.]\d+)?$/);
        
        if (logPaths.length === 0) {
            log("æœªæ‰¾åˆ°ç³»çµ±æ—¥èªŒæª”", "warn");
            document.getElementById('log-viewer').innerHTML = '<div class="text-center text-muted mt-5">ç„¡æ—¥èªŒè³‡æ–™</div>';
            return;
        }

        // æ’åºï¼šè®“æœ€æ–°çš„æª”æ¡ˆ (é€šå¸¸æ²’æœ‰æ—¥æœŸå¾Œç¶´ï¼Œæˆ–æ—¥æœŸæœ€æ–°) æ’å‰é¢
        logPaths.sort((a, b) => {
            // ç°¡å–®é‚è¼¯ï¼šè¶ŠçŸ­çš„åå­—é€šå¸¸æ˜¯ç•¶å‰ log (messages vs messages-2023...)
            if (a.length !== b.length) return a.length - b.length;
            return a.localeCompare(b);
        });

        log(`æƒæåˆ° ${logPaths.length} å€‹æ—¥èªŒæª”`, "info");

        logPaths.forEach(path => {
            const fileName = path.split('/').pop(); // åªé¡¯ç¤ºæª”å
            const opt = document.createElement('option');
            opt.value = path;
            opt.textContent = fileName;
            selector.appendChild(opt);
        });
    }

    async function renderLog() {
        const path = document.getElementById('log-selector').value;
        if (!path) return;

        document.getElementById('log-status').textContent = "Loading...";
        const viewer = document.getElementById('log-viewer');
        viewer.innerHTML = '';

        // Check Cache
        let content = logCache[path];
        if (!content) {
            const file = fileMap.get(path);
            content = await readFileText(file);
            logCache[path] = content; // Cache it
        }

        if (!content) {
            viewer.textContent = "ç„¡æ³•è®€å–æª”æ¡ˆå…§å®¹";
            return;
        }

        const lines = content.split('\n');
        // åªå–æœ€å¾Œ 2000 è¡Œ
        const tail = lines.slice(-2000);
        
        // Render
        let html = '';
        tail.forEach(line => {
            if (!line.trim()) return;
            let cls = 'log-line';
            // Highlight keywords
            if (line.match(/error|fail|panic|critical|denied/i)) cls += ' log-err';
            else if (line.match(/warn|alert/i)) cls += ' log-warn';
            
            // ç°¡æ˜“çš„æ™‚é–“æˆ³é«˜äº® (å‡è¨­å‰å¹¾ç¢¼æ˜¯æ—¥æœŸ)
            // å°‡ HTML ç‰¹æ®Šå­—å…ƒè½‰ç¾©ä»¥é˜² XSS
            const safeLine = line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            html += `<div class="${cls}">${safeLine}</div>`;
        });

        viewer.innerHTML = html;
        viewer.scrollTop = viewer.scrollHeight; // Scroll to bottom
        document.getElementById('log-status').textContent = `å·²è¼‰å…¥ ${path.split('/').pop()} (Last ${tail.length} lines)`;
    }

    function filterLog() {
        const keyword = document.getElementById('log-search').value.toLowerCase();
        const lines = document.querySelectorAll('.log-line');
        lines.forEach(div => {
            if (div.textContent.toLowerCase().includes(keyword)) {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        });
    }

</script>
</body>
</html>