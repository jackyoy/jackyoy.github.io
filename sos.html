<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v11 (Kernel + DragDrop)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --bg-dark: #1e1e2f; --accent: #0d6efd; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        /* Layout */
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: var(--accent); }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        
        /* Components */
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .source-badge { font-size: 0.75rem; color: #fff; background-color: #6c757d; padding: 2px 8px; border-radius: 4px; font-weight: normal; font-family: monospace; }
        .console-box { background: #2d2d3b; color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        /* Upload & Drag Drop */
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .upload-box { border: 2px dashed #ccc; padding: 60px; border-radius: 16px; background: #fff; text-align: center; cursor: pointer; width: 600px; transition: all 0.2s; }
        .upload-box:hover, .upload-box.drag-over { border-color: var(--accent); background: #f0f8ff; transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; color: #6c757d; }
        
        /* Log Explorer */
        .log-container { display: flex; height: calc(100vh - 120px); gap: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; overflow: hidden; }
        .log-tree { width: 30%; background: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; font-size: 0.9rem; }
        .log-viewer { width: 70%; background: #1e1e1e; color: #ccc; font-family: monospace; padding: 15px; overflow-y: auto; white-space: pre; font-size: 0.85rem; display: flex; flex-direction: column; }
        .log-group { padding: 8px 15px; font-weight: bold; background: #e9ecef; border-bottom: 1px solid #dee2e6; font-size: 0.8rem; text-transform: uppercase; color: #555; }
        .log-item { padding: 6px 20px; cursor: pointer; border-bottom: 1px solid #f1f1f1; word-break: break-all; }
        .log-item:hover { background: #e2e6ea; color: #0d6efd; }
        .log-item.active { background: #0d6efd; color: #fff; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-3 fw-bold border-bottom border-secondary">RHEL SOS Analyzer v11</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ“Š ç¸½è¦½ (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">ğŸ–¥ï¸ ç³»çµ±è³‡è¨Š (Host)</a>
            <a class="nav-link" onclick="switchTab('kernel')">âš™ï¸ æ ¸å¿ƒèˆ‡æ¨¡çµ„ (Kernel)</a>
            <a class="nav-link" onclick="switchTab('network')">ğŸŒ ç¶²è·¯ç‹€æ…‹ (Network)</a>
            <a class="nav-link" onclick="switchTab('logs')">ğŸ“ æ—¥èªŒç€è¦½å™¨ (Logs)</a>
            <a class="nav-link" onclick="switchTab('debug')">ğŸ æª”æ¡ˆæª¢æ¸¬ (Debug)</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="loader" class="alert alert-info hidden">æ­£åœ¨è§£ææª”æ¡ˆèˆ‡å»ºç«‹ç´¢å¼•...</div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" id="drop-zone" onclick="document.getElementById('dir-input').click()">
                <div class="upload-icon">ğŸ“‚</div>
                <h4>ä¸Šå‚³ SOS Report</h4>
                <p class="text-muted">é»æ“Šé¸æ“‡æˆ–æ˜¯<b>æ‹–æ›³è³‡æ–™å¤¾</b>åˆ°æ­¤è™•</p>
                <div class="small text-secondary mt-2">æ”¯æ´éè¿´ç›®éŒ„è§£æ (Recursive Scan)</div>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ¦‚è§€</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold text-primary" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">Top Memory Processes <span class="source-badge" id="src-ps-dash">Pending</span></div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>CPU%</th><th>COMMAND</th></tr></thead>
                                <tbody id="mem-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">ç¡¬é«”èˆ‡ä¸­ä»‹è»Ÿé«”</h4>
            <div class="card">
                <div class="card-header">Middleware Processes <span class="source-badge" id="src-ps-mid">Pending</span></div>
                <div class="card-body"><div class="console-box" id="info-middleware">Scanning...</div></div>
            </div>
            <div class="card">
                <div class="card-header">Hardware & BIOS <span class="source-badge" id="src-dmi">Pending</span></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4"><strong>Model:</strong> <span id="info-model">-</span></div>
                        <div class="col-md-4"><strong>Vendor:</strong> <span id="info-vendor">-</span></div>
                        <div class="col-md-4"><strong>BIOS:</strong> <span id="info-bios">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-kernel" class="content-view hidden">
            <h4 class="mb-3">æ ¸å¿ƒèˆ‡æ¨¡çµ„è³‡è¨Š</h4>
            
            <div class="card">
                <div class="card-header">
                    Loaded Kernel Modules (lsmod)
                    <span class="source-badge" id="src-lsmod">Pending</span>
                </div>
                <div class="card-body">
                    <div class="mb-2"><strong>Total Modules:</strong> <span id="lsmod-count">0</span></div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped" style="font-size: 0.85rem;">
                            <thead><tr><th>Module</th><th>Size (KB)</th><th>Used By</th></tr></thead>
                            <tbody id="lsmod-body"><tr><td colspan="3">Scanning...</td></tr></tbody>
                        </table>
                    </div>
                    <small class="text-muted">* Showing Top 10 by size</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>Kernel Parameters (sysctl -a) <span class="source-badge" id="src-sysctl">Pending</span></div>
                    <input type="text" class="form-control form-control-sm w-25" placeholder="Search parameters..." onkeyup="filterSysctl()" id="sysctl-search">
                </div>
                <div class="card-body p-0">
                    <div class="console-box" id="sysctl-box" style="background: #fff; color: #333; max-height: 500px; border-radius: 0;">Scanning...</div>
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
             <h4 class="mb-3">ç¶²è·¯åˆ†æ</h4>
             <div class="card">
                <div class="card-header">Listening Ports <span class="source-badge" id="src-ss">Pending</span></div>
                <div class="card-body"><div class="console-box" id="net-ss">Searching...</div></div>
            </div>
            <div class="card">
                <div class="card-header">IP Address <span class="source-badge" id="src-ip">Pending</span></div>
                <div class="card-body"><div class="console-box" id="net-ip">Searching...</div></div>
            </div>
        </div>

        <div id="view-logs" class="content-view hidden">
            <h4 class="mb-3">æ—¥èªŒç€è¦½å™¨</h4>
            <div class="log-container">
                <div class="log-tree" id="log-tree"><div class="p-3 text-muted">No files</div></div>
                <div class="log-viewer">
                    <div class="border-bottom pb-2 mb-2 d-flex justify-content-between">
                        <strong id="log-current-file">-</strong>
                        <input type="text" id="log-search-input" class="form-control form-control-sm w-25 bg-dark text-light border-secondary" placeholder="Search..." onkeyup="filterLogContent()">
                    </div>
                    <div class="log-content" id="log-content-area"></div>
                </div>
            </div>
        </div>

        <div id="view-debug" class="content-view hidden">
            <h4>File Index Debugger</h4>
            <div class="console-box" id="debug-list"></div>
        </div>
    </div>

    <script>
        const App = {
            files: new Map(),
            filePaths: [],
            cache: {},
            currentLogText: "",
            fullSysctlText: "",
            
            rules: {
                ps: [/ps_aux.*$/, /ps_auxwwwm$/], 
                netstat: [/netstat.*neopa$/, /netstat.*-W.*$/, /netstat$/],
                ss: [/ss_-tulpn$/],
                hostname: [/hostname$/],
                release: [/redhat-release$/],
                uptime: [/uptime$/],
                uname: [/uname_-a$/],
                dmidecode: [/dmidecode$/],
                ip: [/ip_.*addr$/],
                // New Kernel rules
                lsmod: [/lsmod$/],
                sysctl: [/sysctl_-a$/]
            }
        };

        // --- Drag and Drop Logic ---
        const dropZone = document.getElementById('drop-zone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const items = e.dataTransfer.items;
            if (!items) return;

            toggleLoader(true);
            App.files.clear();
            App.filePaths = [];
            App.cache = {};

            let debugLog = "--- Drag & Drop Import ---\n";
            
            // ä½¿ç”¨ webkitGetAsEntry é€²è¡Œéè¿´ç›®éŒ„è®€å–
            const queue = [];
            for (let i = 0; i < items.length; i++) {
                const entry = items[i].webkitGetAsEntry();
                if (entry) queue.push(traverseFileTree(entry));
            }

            await Promise.all(queue);
            
            // Generate debug log from map
            for(let [path, f] of App.files) {
                debugLog += `[DROP] ${path} (${f.size} B)\n`;
            }
            document.getElementById('debug-list').textContent = debugLog;

            startAnalysis();
        });

        async function traverseFileTree(item, path = "") {
            if (item.isFile) {
                return new Promise((resolve) => {
                    item.file((file) => {
                        // ç•¶æ‹–æ›³è³‡æ–™å¤¾æ™‚ï¼Œitem.fullPath æœƒåƒ "/sosreport-xxx/etc/hosts"
                        // æˆ‘å€‘å¸Œæœ›ç§»é™¤ç¬¬ä¸€å±¤ï¼Œé¡ä¼¼ input directory çš„è¡Œç‚º
                        let relPath = item.fullPath;
                        if (relPath.startsWith('/')) relPath = relPath.substring(1); // remove leading /
                        
                        const parts = relPath.split('/');
                        const cleanPath = parts.slice(1).join('/'); // Remove root folder

                        if (cleanPath && file.size > 0) {
                            App.files.set(cleanPath, file);
                            App.filePaths.push(cleanPath);
                        }
                        resolve();
                    });
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                const entries = await readAllEntries(dirReader);
                const promises = entries.map(entry => traverseFileTree(entry, path + item.name + "/"));
                await Promise.all(promises);
            }
        }

        function readAllEntries(dirReader) {
            return new Promise((resolve, reject) => {
                let entries = [];
                function read() {
                    dirReader.readEntries((result) => {
                        if (result.length === 0) resolve(entries);
                        else {
                            entries = entries.concat(result);
                            read();
                        }
                    }, reject);
                }
                read();
            });
        }

        // --- Standard Input Handling ---
        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;
            toggleLoader(true);
            App.files.clear();
            App.filePaths = [];
            App.cache = {};
            
            let debugLog = "--- Input Select Import ---\n";
            for (let f of fileList) {
                const parts = f.webkitRelativePath.split('/');
                const relPath = parts.slice(1).join('/');
                if (f.size > 0) {
                    App.files.set(relPath, f);
                    App.filePaths.push(relPath);
                    debugLog += `[FILE] ${relPath}\n`;
                }
            }
            document.getElementById('debug-list').textContent = debugLog;
            startAnalysis();
        });

        async function startAnalysis() {
            try {
                await Promise.all([
                    runDashboard(), 
                    runHostInfo(), 
                    runKernel(), // New
                    runNetwork(),
                    buildLogTree()
                ]);
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                toggleLoader(false);
            }
        }

        // --- Core ---
        async function findAndRead(ruleKey) {
            const regexList = App.rules[ruleKey];
            if (!regexList) return { content: null, path: null };
            
            const matches = App.filePaths.filter(p => regexList.some(r => r.test(p)));
            if (matches.length === 0) return { content: null, path: null };

            matches.sort((a, b) => b.length - a.length);
            const foundPath = matches.find(m => m.includes('sos_commands')) || matches[0];
            
            if (!App.cache[foundPath]) {
                App.cache[foundPath] = await App.files.get(foundPath).text();
            }
            return { content: App.cache[foundPath], path: foundPath };
        }

        // --- New Kernel Logic ---
        async function runKernel() {
            // 1. LSMOD
            const ls = await findAndRead('lsmod');
            showSrc('src-lsmod', ls.path);
            if (ls.content) {
                const lines = ls.content.split('\n');
                let modules = [];
                // Format: Module Size Used by
                lines.forEach(line => {
                    const p = line.split(/\s+/);
                    if (p.length >= 2 && p[0] !== 'Module') {
                        const size = parseInt(p[1]);
                        if (!isNaN(size)) {
                            modules.push({ name: p[0], size: size, used: p[2] || '-' });
                        }
                    }
                });
                
                document.getElementById('lsmod-count').textContent = modules.length;
                
                // Top 10 by size
                const top10 = modules.sort((a, b) => b.size - a.size).slice(0, 10);
                document.getElementById('lsmod-body').innerHTML = top10.map(m => 
                    `<tr><td>${m.name}</td><td>${(m.size/1024).toFixed(2)} KB (${m.size})</td><td>${m.used}</td></tr>`
                ).join('');
            } else {
                document.getElementById('lsmod-body').innerHTML = `<tr><td colspan="3" class="text-danger">lsmod not found</td></tr>`;
            }

            // 2. SYSCTL
            const sys = await findAndRead('sysctl');
            showSrc('src-sysctl', sys.path);
            if (sys.content) {
                App.fullSysctlText = sys.content;
                renderSysctl(sys.content);
            } else {
                document.getElementById('sysctl-box').textContent = "sysctl -a not found";
            }
        }

        function renderSysctl(text) {
            // Default View: Show some important keys first?
            // Actually, just showing the list is fine, user can search.
            const lines = text.split('\n');
            // Show first 100 lines initially to avoid lag
            document.getElementById('sysctl-box').textContent = lines.slice(0, 100).join('\n') + (lines.length > 100 ? `\n... (${lines.length - 100} more lines, use search)` : '');
        }

        function filterSysctl() {
            const term = document.getElementById('sysctl-search').value.toLowerCase();
            if (!term) {
                renderSysctl(App.fullSysctlText);
                return;
            }
            const lines = App.fullSysctlText.split('\n');
            const filtered = lines.filter(l => l.toLowerCase().includes(term));
            document.getElementById('sysctl-box').textContent = filtered.join('\n');
        }

        // --- Other Modules (Same as v10) ---
        async function runDashboard() {
            const h = await findAndRead('hostname');
            if(h.content) document.getElementById('dash-hostname').textContent = h.content.trim();
            const r = await findAndRead('release');
            if(r.content) document.getElementById('dash-release').textContent = r.content.split('\n')[0];
            const u = await findAndRead('uptime');
            if(u.content) document.getElementById('dash-uptime').textContent = u.content.trim();
            const k = await findAndRead('uname');
            if (k.content) {
                const p = k.content.split(' ');
                document.getElementById('dash-kernel').textContent = p.length >= 3 ? p[2] : k.content;
            }
        }

        async function runHostInfo() {
            const ps = await findAndRead('ps');
            showSrc('src-ps-dash', ps.path);
            showSrc('src-ps-mid', ps.path);
            if (ps.content) {
                const lines = ps.content.split('\n');
                let hIdx = -1;
                for(let i=0; i<Math.min(50, lines.length); i++) {
                    if (lines[i].includes('PID') && lines[i].includes('%MEM')) { hIdx = i; break; }
                }
                if (hIdx !== -1) {
                    const parsed = [];
                    for (let i = hIdx + 1; i < lines.length; i++) {
                        const l = lines[i].trim();
                        if (!l) continue;
                        const p = l.split(/\s+/);
                        if (p[1] === '-' || isNaN(parseInt(p[1]))) continue;
                        if (p.length < 10) continue;
                        const mem = parseFloat(p[3]);
                        if (!isNaN(mem)) parsed.push({ user: p[0], pid: p[1], mem, cpu: p[2], cmd: p.slice(10).join(' ') });
                    }
                    const top5 = parsed.sort((a,b)=>b.mem-a.mem).slice(0,5);
                    document.getElementById('mem-table-body').innerHTML = top5.map(p=>`<tr><td>${p.pid}</td><td>${p.user}</td><td>${p.mem}%</td><td>${p.cpu}%</td><td class="text-truncate" style="max-width:200px" title="${p.cmd}">${p.cmd}</td></tr>`).join('');
                    
                    const mwRegex = /java|python|node|httpd|nginx|mysql|postgres|docker|kube/i;
                    const mw = parsed.filter(p => mwRegex.test(p.cmd) && !p.cmd.includes(' grep '));
                    document.getElementById('info-middleware').textContent = mw.length ? mw.map(p=>`${p.user} (${p.pid}): ${p.cmd}`).join('\n') : "No common middleware found.";
                }
            }
            const dmi = await findAndRead('dmidecode');
            showSrc('src-dmi', dmi.path);
            if(dmi.content) {
                const prod = (dmi.content.match(/Product Name:\s*(.+)/)||[])[1];
                const vend = (dmi.content.match(/Manufacturer:\s*(.+)/)||[])[1];
                const bios = (dmi.content.match(/Version:\s*(.+)/)||[])[1];
                if(prod) document.getElementById('info-model').textContent = prod;
                if(vend) document.getElementById('info-vendor').textContent = vend;
                if(bios) document.getElementById('info-bios').textContent = bios;
            }
        }

        async function runNetwork() {
            let net = await findAndRead('netstat');
            let type = 'netstat';
            if(!net.content) { net = await findAndRead('ss'); type='ss'; }
            showSrc('src-ss', net.path);
            if(net.content) {
                const lines = net.content.split('\n');
                const filter = type==='netstat' ? ['Proto','LISTEN'] : ['State','LISTEN'];
                const out = lines.filter(l => filter.some(k=>l.includes(k))).join('\n');
                document.getElementById('net-ss').textContent = out || "No LISTEN ports";
            }
            const ip = await findAndRead('ip');
            showSrc('src-ip', ip.path);
            if(ip.content) document.getElementById('net-ip').textContent = ip.content;
        }

        // --- Log Tree (Same as v10) ---
        function buildLogTree() {
            const tree = document.getElementById('log-tree');
            tree.innerHTML = '';
            const cats = { "System": [/messages/, /dmesg/, /boot/], "Security": [/secure/, /audit/], "Package": [/dnf/, /yum/], "Cron": [/cron/], "Others": [] };
            const found = { "System": [], "Security": [], "Package": [], "Cron": [], "Others": [] };
            
            App.filePaths.forEach(p => {
                if (!p.match(/var\/log|sos_commands\/logs|dmesg/)) return;
                if (p.match(/\.gz$|wtmp|lastlog/)) return;
                let m = false;
                for(let c in cats) {
                    if (c==='Others') continue;
                    if(cats[c].some(r=>r.test(p))) { found[c].push(p); m=true; break; }
                }
                if(!m && p.includes('var/log')) found['Others'].push(p);
            });

            for(let c in found) {
                if(!found[c].length) continue;
                const g = document.createElement('div');
                g.className = 'log-group';
                g.textContent = c;
                tree.appendChild(g);
                found[c].sort().forEach(p => {
                    const i = document.createElement('div');
                    i.className = 'log-item';
                    i.textContent = p.split('/').pop();
                    i.onclick = () => loadLog(p, i);
                    tree.appendChild(i);
                });
            }
        }

        async function loadLog(path, el) {
            document.querySelectorAll('.log-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('log-current-file').textContent = path;
            const v = document.getElementById('log-content-area');
            v.textContent = "Loading...";
            
            let txt = await App.files.get(path).text();
            if(txt.length > 50000) txt = `[Truncated last 50k]\n` + txt.slice(-50000);
            App.currentLogText = txt;
            v.textContent = txt;
            v.scrollTop = v.scrollHeight;
        }

        function filterLogContent() {
            const t = document.getElementById('log-search-input').value.toLowerCase();
            const v = document.getElementById('log-content-area');
            if(!t) { v.textContent = App.currentLogText; return; }
            v.textContent = App.currentLogText.split('\n').filter(l=>l.toLowerCase().includes(t)).join('\n');
        }

        // --- Utils ---
        function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }
        function showSrc(id, p) { const el=document.getElementById(id); if(el) el.textContent = p?`SRC: .../${p.split('/').pop()}`:'Not Found'; }
        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(e=>e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
            const nav = Array.from(document.querySelectorAll('.nav-link')).find(n=>n.getAttribute('onclick').includes(id));
            if(nav) nav.classList.add('active');
        }
    </script>
</body>
</html>