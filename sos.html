<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Report Analyzer (Deep Search)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-bg: #1a1d20; --text-color: #e9ecef; }
        body { background-color: var(--primary-bg); color: var(--text-color); font-family: 'Consolas', 'Segoe UI', monospace; }
        .card { background-color: #2c3034; border: 1px solid #495057; color: #fff; }
        .card-header { background-color: #212529; border-bottom: 1px solid #495057; font-weight: bold; }
        .upload-area { border: 2px dashed #6c757d; border-radius: 10px; padding: 30px; text-align: center; background: #2c3034; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: #0d6efd; background-color: #343a40; }
        .list-group-item { background-color: #2c3034; color: #fff; border-color: #495057; }
        .debug-console { background: #000; color: #0f0; font-size: 0.8rem; padding: 15px; border: 1px solid #333; height: 250px; overflow-y: auto; font-family: 'Courier New', monospace; }
        .log-warn { color: #ffc107; } .log-err { color: #ff6b6b; } .log-success { color: #00ff00; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold m-0">RHEL SOS Analyzer <small class="text-muted fs-6">v3.0 (Local Parse)</small></h3>
        <span class="badge bg-info text-dark">Client-Side Only</span>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-12">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <h4>ğŸ“‚ è¼‰å…¥ sosreport è³‡æ–™å¤¾</h4>
                <p class="text-muted mb-0">ç´”å‰ç«¯è§£æï¼Œä¸æœƒä¸Šå‚³ä»»ä½•è³‡æ–™åˆ°ç¶²è·¯</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        <div class="card mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end border-secondary">
                        <small class="text-muted">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-info fw-bold">--</h4>
                    </div>
                    <div class="col-md-3 border-end border-secondary">
                        <small class="text-muted">RELEASE</small>
                        <h5 id="os-release">--</h5>
                    </div>
                    <div class="col-md-3 border-end border-secondary">
                        <small class="text-muted">KERNEL</small>
                        <h5 id="os-kernel">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">UPTIME</small>
                        <h5 id="os-uptime">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-primary">-- GB</span>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div style="width: 250px;">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Top Processes (CPU)</div>
                    <div class="card-body p-0">
                        <table class="table table-dark table-sm table-hover mb-0" style="font-size: 0.85rem;">
                            <thead><tr><th>USER</th><th>PID</th><th>CPU%</th><th>CMD</th></tr></thead>
                            <tbody id="ps-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h6 class="text-muted">Analysis Log</h6>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<script>
    let fileMap = new Map(); // ä½¿ç”¨ Map åŠ é€ŸæŸ¥æ‰¾
    let filePaths = [];      // å­˜å„²ç´”è·¯å¾‘å­—ä¸²ä»¥ä¾›æœå°‹

    function log(msg, type = '') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        if (type === 'warn') d.className = 'log-warn';
        if (type === 'err') d.className = 'log-err';
        if (type === 'success') d.className = 'log-success';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;

        document.getElementById('console').innerHTML = '';
        document.getElementById('dashboard').style.display = 'none';
        
        log(`ç³»çµ±è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆæ§åˆ¶ä»£ç¢¼...`);
        
        // 1. å»ºç«‹ç´¢å¼• (Indexing) - é€™æ˜¯æœ€è€—æ™‚çš„æ­¥é©Ÿï¼Œä½†åœ¨æœ¬æ©Ÿä¾ç„¶å¾ˆå¿«
        fileMap.clear();
        filePaths = [];
        
        let rootDir = "";
        
        // æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ for loop æ¯” forEach å¿«
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);

            // å˜—è©¦åµæ¸¬æ ¹ç›®éŒ„åç¨± (é€šå¸¸æ˜¯ç¬¬ä¸€å±¤)
            if (i === 0) rootDir = path.split('/')[0];
        }

        log(`ç´¢å¼•å»ºç«‹å®Œæˆã€‚åµæ¸¬åˆ°çš„æ ¹ç›®éŒ„åç¨±: "${rootDir}"`, 'success');

        // 2. åŸ·è¡Œè§£æ
        try {
            await parseOS();
            await parseMemory();
            await parseNetwork();
            await parseProcess();
            
            document.getElementById('dashboard').style.display = 'block';
            log("æ‰€æœ‰æ¨¡çµ„è§£æå®Œç•¢ã€‚", 'success');
        } catch (e) {
            log(`è§£æç™¼ç”Ÿä¾‹å¤–ç‹€æ³: ${e.message}`, 'err');
            console.error(e);
        }
    }

    // --- æ ¸å¿ƒæ”¹é€²ï¼šå…¨åŸŸæ¨¡ç³Šæœå°‹ ---
    // ä¸å†ä¾è³´å›ºå®šè·¯å¾‘ï¼Œè€Œæ˜¯æœå°‹ "æª”åçµå°¾"
    function findFileAndRead(filenameKeywords) {
        return new Promise((resolve) => {
            // keywords å¯ä»¥æ˜¯å­—ä¸²æˆ–é™£åˆ—ï¼Œä¾‹å¦‚ "meminfo" æˆ– ["ps_aux", "ps"]
            const keywords = Array.isArray(filenameKeywords) ? filenameKeywords : [filenameKeywords];
            
            // åœ¨æ‰€æœ‰è·¯å¾‘ä¸­æœå°‹ç¬¦åˆçµå°¾çš„æª”æ¡ˆ
            // å„ªå…ˆé †åºï¼šå®Œå…¨ç¬¦åˆæª”å > çµå°¾ç¬¦åˆ
            let targetPath = null;

            for (const keyword of keywords) {
                // 1. å˜—è©¦ç²¾ç¢ºçµå°¾åŒ¹é… (ä¾‹å¦‚ /proc/meminfo)
                targetPath = filePaths.find(p => p.endsWith(`/${keyword}`));
                if (targetPath) break;
            }

            // å¦‚æœé‚„æ²’æ‰¾åˆ°ï¼Œå˜—è©¦æ›´å¯¬é¬†çš„åŒ¹é… (åªè¦åŒ…å«è©²å­—ä¸²ä¸”åœ¨ sos_commands ä¸‹)
            if (!targetPath) {
                for (const keyword of keywords) {
                    targetPath = filePaths.find(p => p.includes(keyword) && !p.includes('xz')); // æ’é™¤å£“ç¸®æª”
                    if (targetPath) break;
                }
            }

            if (!targetPath) {
                log(`[æœå°‹å¤±æ•—] ç„¡æ³•æ‰¾åˆ°åŒ…å«é—œéµå­— "${keywords.join(' OR ')}" çš„æª”æ¡ˆ`, 'warn');
                resolve(null);
                return;
            }

            log(`[è®€å–æª”æ¡ˆ] ${targetPath}`);
            const file = fileMap.get(targetPath);
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- è§£æé‚è¼¯ ---

    async function parseOS() {
        const hostname = await findFileAndRead('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        // RHEL ç™¼è¡Œç‰ˆè³‡è¨Š
        const release = await findFileAndRead(['os-release', 'redhat-release']);
        if (release) {
            // å˜—è©¦è§£æ PRETTY_NAME
            const match = release.match(/PRETTY_NAME="([^"]+)"/);
            if (match) document.getElementById('os-release').textContent = match[1];
            else document.getElementById('os-release').textContent = release.split('\n')[0]; // fallback
        }

        const uptime = await findFileAndRead('uptime');
        if (uptime) {
             const m = uptime.match(/up\s+([^,]+)/);
             if (m) document.getElementById('os-uptime').textContent = m[1];
        }

        const uname = await findFileAndRead('uname');
        if (uname) {
            const parts = uname.split(' ');
            if (parts.length > 2) document.getElementById('os-kernel').textContent = parts[2];
        }
    }

    async function parseMemory() {
        const data = await findFileAndRead('meminfo');
        if (!data) return;

        const getVal = (k) => {
            const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm'));
            return m ? parseInt(m[1]) : 0;
        };

        const total = getVal('MemTotal');
        const free = getVal('MemFree');
        const buffers = getVal('Buffers');
        const cached = getVal('Cached');
        const slab = getVal('Slab');
        const used = total - free - buffers - cached - slab;
        const totalGB = (total/1024/1024).toFixed(1);

        document.getElementById('mem-total-badge').textContent = `${totalGB} GB`;

        const ctx = document.getElementById('memChart').getContext('2d');
        if (window.memChartInstance) window.memChartInstance.destroy();
        
        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Used (App)', 'Cache/Buff', 'Free'],
                datasets: [{
                    data: [used, buffers+cached+slab, free],
                    backgroundColor: ['#e74c3c', '#f1c40f', '#2ecc71'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
            }
        });
    }

    async function parseNetwork() {
        // æœå°‹å¤šç¨®å¯èƒ½çš„ IP æŒ‡ä»¤æª”åè®Šé«”
        const data = await findFileAndRead(['ip_address', 'ip_-d_address', 'ip_addr']);
        const list = document.getElementById('net-list');
        list.innerHTML = '';

        if (!data) {
            list.innerHTML = '<div class="p-3 text-muted">æŸ¥ç„¡ ip address ç›¸é—œè¼¸å‡º</div>';
            return;
        }

        // è§£æ ip addr
        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const name = match[1];
            const state = match[2];
            const color = state === 'UP' ? 'text-success' : 'text-danger';
            
            // å˜—è©¦æ‰¾ IP
            // é€™è£¡åšçš„æ¯”è¼ƒç°¡å–®ï¼ŒåªæŠ“è©²ä»‹é¢å¾Œé¢çš„ inet
            const blockStart = match.index;
            const nextMatch = regex.lastIndex; // é€™å…¶å¯¦ä¸æº–ç¢ºï¼Œæ‡‰è©²è¦æ‰¾ä¸‹ä¸€å€‹ ^\d+:
            // ç°¡åŒ–ç‰ˆï¼šåªé¡¯ç¤ºç‹€æ…‹ï¼ŒIP è§£æéœ€è¦æ›´è¤‡é›œçš„ state machine
            
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-3">
                    <span class="fw-bold">${name}</span>
                    <span class="fw-bold ${color}">${state}</span>
                </div>`;
        }
    }

    async function parseProcess() {
        // æœå°‹ ps è¼¸å‡º
        const data = await findFileAndRead(['ps_aux', 'ps_auxww', 'ps']); 
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = '';

        if (!data) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æŸ¥ç„¡ ps è¼¸å‡º</td></tr>';
            return;
        }

        const lines = data.split('\n');
        let procs = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const parts = line.split(/\s+/);
            if (parts.length < 10) continue;
            
            // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœæ˜¯ ps aux æ ¼å¼
            // USER PID %CPU %MEM ... COMMAND
            procs.push({
                user: parts[0],
                pid: parts[1],
                cpu: parseFloat(parts[2]) || 0,
                cmd: parts.slice(10).join(' ')
            });
        }

        // Sort by CPU
        procs.sort((a, b) => b.cpu - a.cpu);
        
        procs.slice(0, 5).forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.user}</td>
                    <td>${p.pid}</td>
                    <td class="text-warning">${p.cpu}%</td>
                    <td class="text-truncate" style="max-width: 150px;">${p.cmd}</td>
                </tr>`;
        });
    }

</script>
</body>
</html>