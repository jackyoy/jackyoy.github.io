<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v10 (Process & Logs Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #212529; --accent: #0d6efd; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, monospace; color: #333; }
        
        /* å„€è¡¨æ¿å¡ç‰‡ */
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 24px; }
        .card-header { background: #fff; border-bottom: 2px solid #f1f3f5; font-weight: 700; color: #495057; padding: 15px; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area { border: 2px dashed #adb5bd; border-radius: 12px; padding: 50px; text-align: center; background: #fff; cursor: pointer; transition: 0.2s; }
        .upload-area:hover { border-color: var(--accent); background-color: #f8fbff; }
        
        /* Log Viewer */
        .log-wrapper { background: var(--bg-dark); border-radius: 6px; height: 500px; display: flex; flex-direction: column; }
        .log-viewer { flex: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 0.85rem; color: #ced4da; white-space: pre-wrap; }
        .log-line { border-bottom: 1px solid #343a40; padding: 2px 0; }
        .log-err { color: #ff8787; font-weight: bold; background: rgba(255,0,0,0.1); }
        .log-warn { color: #ffd43b; font-weight: bold; }
        
        /* è¡¨æ ¼å„ªåŒ– */
        .table-proc th { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .table-proc td { vertical-align: middle; }
        .cmd-col { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Debug Console */
        .debug-console { background: #000; color: #20c997; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 6px; height: 150px; overflow-y: auto; margin-top: 20px; }
        .log-d-err { color: #fa5252; } .log-d-warn { color: #fab005; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-0">RHEL SOS Analyzer <span class="badge bg-secondary fs-6 align-middle">v10.0</span></h3>
            <small class="text-muted">æ”¯æ´ ps_auxwwwm è§£æèˆ‡æ­·å² Log è¼ªæ›¿æª”</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">é‡ç½®</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">ğŸ“‚</div>
                <h4>é¸æ“‡ sosreport è³‡æ–™å¤¾</h4>
                <p class="text-muted">è‡ªå‹•éæ¿¾ Kernel Threads ä¸¦åµæ¸¬æ‰€æœ‰ Log æª”æ¡ˆ</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 text-break">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px; position: relative;">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Top CPU Processes</span>
                        <span class="badge bg-info text-dark">Exclude Threads</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-proc mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="10%">PID</th>
                                        <th width="15%">User</th>
                                        <th width="10%">CPU%</th>
                                        <th width="10%">MEM%</th>
                                        <th width="10%">RSS (MB)</th>
                                        <th width="45%">Command</th>
                                    </tr>
                                </thead>
                                <tbody id="ps-tbody">
                                    <tr><td colspan="6" class="text-center text-muted py-4">ç­‰å¾…è³‡æ–™è§£æ...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
                        <span>System Logs</span>
                        <div class="d-flex gap-2">
                            <select id="log-selector" class="form-select form-select-sm" style="width: 250px;" onchange="renderLog()">
                                <option value="" disabled selected>æƒæä¸­...</option>
                            </select>
                            <input type="text" id="log-search" class="form-control form-control-sm" placeholder="éæ¿¾é—œéµå­—..." style="width: 150px;" onkeyup="filterLog()">
                        </div>
                    </div>
                    <div class="card-body p-0 bg-dark">
                        <div class="log-wrapper">
                            <div id="log-viewer" class="log-viewer">
                                <div class="text-center text-muted mt-5 pt-5">è«‹å¾ä¸Šæ–¹é¸å–®é¸æ“‡ Log æª”æ¡ˆ</div>
                            </div>
                            <div class="bg-secondary text-white px-3 py-1 small d-flex justify-content-between">
                                <span id="log-status">Ready</span>
                                <span>Displaying Last 2000 Lines</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <h6 class="fw-bold text-secondary" style="cursor:pointer" onclick="document.getElementById('console').classList.toggle('d-none')">Debug Console (Click to toggle)</h6>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];
    let logCache = {};

    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.textContent = `> ${msg}`;
        if (type === 'err') d.className = 'log-d-err';
        if (type === 'warn') d.className = 'log-d-warn';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        logCache = {};

        log(`Indexing ${files.length} files...`);
        fileMap.clear(); filePaths = [];
        
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }

        try {
            await parseOS();
            await parseMemory();
            await parseProcess(); // é‡é»å„ªåŒ–
            await parseNetwork();
            await initLogSystem(); // é‡é»å„ªåŒ–
            log("ğŸ‰ æ‰€æœ‰æ¨¡çµ„è§£æå®Œç•¢", "info");
        } catch (e) {
            log(`âŒ å…¨åŸŸéŒ¯èª¤: ${e.message}`, "err");
            console.error(e);
        }
    }

    // --- Core Finder ---
    async function findFile(keywords, checkFn = null, returnPath = false) {
        const kwList = Array.isArray(keywords) ? keywords : [keywords];
        // å„ªå…ˆæœå°‹ sos_commands ç›®éŒ„
        let candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`) || p.endsWith(kw)) && p.includes('sos_commands'));
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`)));
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.includes(kw) && !p.endsWith('.xz')));

        for (const path of candidates) {
            const content = await readFileText(fileMap.get(path));
            if (!content) continue;
            if (checkFn && !checkFn(content)) continue;
            return returnPath ? { content, path } : content;
        }
        return null;
    }

    // Log å°ˆç”¨æœå°‹å™¨ (æ”¯æ´ Regex)
    function findFilesByRegex(regex) {
        return filePaths.filter(p => regex.test(p) && !p.endsWith('.xz') && !p.endsWith('.gz'));
    }

    function readFileText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Parsers ---

    async function parseOS() {
        const hostname = await findFile('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        const release = await findFile(['redhat-release', 'os-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        const uname = await findFile(['uname_-a', 'uname']);
        if (uname) {
            const m = uname.match(/(\d+\.\d+\.\d+-\S+)/); 
            document.getElementById('os-kernel').textContent = m ? m[1] : (uname.split(/\s+/)[2] || uname);
        }

        const uptime = await findFile(['uptime', 'date'], c => c.includes('up'));
        if (uptime) {
            const m = uptime.match(/up\s+([^,]+)/);
            if (m) document.getElementById('os-uptime').textContent = m[1];
        }
    }

    async function parseMemory() {
        const data = await findFile('meminfo');
        if (!data) return;
        const val = (k) => { const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm')); return m ? parseInt(m[1]) : 0; };
        const total = val('MemTotal'), free = val('MemFree'), buff = val('Buffers'), cached = val('Cached'), slab = val('Slab');
        const used = total - free - buff - cached - slab;
        
        document.getElementById('mem-total-badge').textContent = (total/1024/1024).toFixed(1) + " GB";

        if (window.memChartInstance) window.memChartInstance.destroy();
        const ctx = document.getElementById('memChart').getContext('2d');
        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buff/Cache', 'Free'],
                datasets: [{ data: [used, buff+cached+slab, free], backgroundColor: ['#dc3545', '#ffc107', '#198754'], borderWidth: 1 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // --- æ ¸å¿ƒä¿®æ­£ï¼šPS è§£æå™¨ ---
    async function parseProcess() {
        const data = await findFile(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps'], c => c.includes('PID'));
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = '';

        if (!data) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ç„¡ PS è³‡æ–™</td></tr>';
            return;
        }

        const lines = data.split('\n');
        let procs = [];
        let map = { user:0, pid:1, cpu:2, mem:3, rss:5, cmd:10 }; 
        
        // 1. å‹•æ…‹åµæ¸¬ Header ä½ç½®
        for(let i=0; i<Math.min(lines.length, 50); i++) {
            const line = lines[i].trim();
            if(line.includes('PID') && line.includes('CPU')) {
                const parts = line.split(/\s+/);
                map.user = parts.indexOf('USER');
                map.pid = parts.indexOf('PID');
                map.cpu = parts.findIndex(c => c.includes('CPU'));
                map.mem = parts.findIndex(c => c.includes('MEM'));
                map.rss = parts.indexOf('RSS');
                map.cmd = parts.indexOf('COMMAND');
                if (map.cmd === -1) map.cmd = parts.indexOf('CMD');
                if (map.cmd === -1) map.cmd = 10; // Fallback
                break;
            }
        }

        // 2. è§£æå…§å®¹ (éæ¿¾ PID ç‚º - çš„ Thread)
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.startsWith('USER') || line.includes('PID')) continue;

            const parts = line.split(/\s+/);
            if (parts.length < 8) continue; // å¯¬å®¹åº¦æª¢æŸ¥

            const pid = parts[map.pid];
            
            // **é—œéµä¿®æ­£**ï¼šå¦‚æœ PID æ˜¯ '-'ï¼Œä»£è¡¨å®ƒæ˜¯ Threadï¼Œæˆ‘å€‘å°‡å…¶å¿½ç•¥ï¼Œä»¥é¡¯ç¤º Top Processes
            if (pid === '-') continue;

            const cpu = parseFloat(parts[map.cpu]);
            const mem = parseFloat(parts[map.mem]);
            const rss = parseInt(parts[map.rss]); // in KB usually

            // æŠ“å–å®Œæ•´ Command (åŒ…å«åƒæ•¸)
            const cmd = parts.slice(map.cmd).join(' ');

            if (!isNaN(cpu)) {
                procs.push({ user: parts[map.user], pid, cpu, mem, rss, cmd });
            }
        }

        // 3. æ’åºèˆ‡é¡¯ç¤º (Top 8)
        procs.sort((a,b) => b.cpu - a.cpu).slice(0, 8).forEach(p => {
            const row = document.createElement('tr');
            // RSS KB -> MB
            const rssMB = (p.rss / 1024).toFixed(1);
            
            row.innerHTML = `
                <td><span class="badge bg-light text-dark border">${p.pid}</span></td>
                <td>${p.user}</td>
                <td class="fw-bold text-danger">${p.cpu}%</td>
                <td>${p.mem}%</td>
                <td>${rssMB}</td>
                <td class="cmd-col" title="${p.cmd}">${p.cmd}</td>
            `;
            tbody.appendChild(row);
        });
        
        log(`è§£æå‡º ${procs.length} å€‹ä¸»ç¨‹åº (å·²éæ¿¾ Threads)`, 'info');
    }

    async function parseNetwork() {
        const data = await findFile(['ip_address', 'ip_addr', 'ip_-d_address'], c => c.includes('state'));
        const list = document.getElementById('net-list');
        list.innerHTML = '';
        if (!data) return;

        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const isUp = match[2] === 'UP';
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span class="fw-bold">${match[1]}</span>
                    <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${match[2]}</span>
                </div>`;
        }
    }

    // --- æ ¸å¿ƒä¿®æ­£ï¼šLog System (Log Rotation) ---
    async function initLogSystem() {
        const selector = document.getElementById('log-selector');
        selector.innerHTML = '<option value="" disabled selected>é¸æ“‡ Log æª”æ¡ˆ...</option>';

        // Regex: åŒ¹é… messages, dmesg, secure, cron, ä»¥åŠå®ƒå€‘çš„æ­·å²æª” (ä¾‹å¦‚ messages-20251228)
        // æ’é™¤ .xz, .gz å£“ç¸®æª” (ç´”å‰ç«¯ç„¡æ³•ç›´æ¥è§£å£“)
        const logPaths = findFilesByRegex(/.*\/(messages|dmesg|secure|cron|boot\.log|yum\.log|dnf\.log)([-\.]\d+)?$/);
        
        if (logPaths.length === 0) {
            log("æœªæ‰¾åˆ°ç³»çµ±æ—¥èªŒæª”", "warn");
            return;
        }

        // æ’åºï¼šè®“æª”åçŸ­çš„ (ç•¶å‰ log) æ’å‰é¢ï¼Œæ—¥æœŸè¿‘çš„æ’å‰é¢
        logPaths.sort(); // ç°¡å–®å­—æ¯æ’åºå³å¯æŠŠç›¸åŒé¡å‹çš„æ’åœ¨ä¸€èµ·

        logPaths.forEach(path => {
            const fileName = path.split('/').pop();
            const opt = document.createElement('option');
            opt.value = path;
            opt.textContent = fileName;
            selector.appendChild(opt);
        });
        
        log(`Log æƒæå®Œæˆ: æ‰¾åˆ° ${logPaths.length} å€‹æª”æ¡ˆ`, 'info');
    }

    async function renderLog() {
        const path = document.getElementById('log-selector').value;
        if (!path) return;

        document.getElementById('log-status').textContent = "è®€å–ä¸­...";
        const viewer = document.getElementById('log-viewer');
        viewer.innerHTML = '';

        let content = logCache[path];
        if (!content) {
            const file = fileMap.get(path);
            content = await readFileText(file);
            logCache[path] = content;
        }

        const lines = content.split('\n');
        const tail = lines.slice(-2000); // é¡¯ç¤ºæœ€å¾Œ 2000 è¡Œ
        
        let html = '';
        tail.forEach(line => {
            if (!line.trim()) return;
            let cls = 'log-line';
            if (line.match(/error|fail|panic|critical|denied/i)) cls += ' log-err';
            else if (line.match(/warn|alert/i)) cls += ' log-warn';
            
            // å®‰å…¨è½‰ç¾© HTML
            const safeLine = line.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            html += `<div class="${cls}">${safeLine}</div>`;
        });

        viewer.innerHTML = html;
        viewer.scrollTop = viewer.scrollHeight;
        document.getElementById('log-status').textContent = `å·²è¼‰å…¥ ${path.split('/').pop()} (å…± ${lines.length} è¡Œï¼Œé¡¯ç¤ºæœ€å¾Œ ${tail.length} è¡Œ)`;
    }

    function filterLog() {
        const keyword = document.getElementById('log-search').value.toLowerCase();
        const lines = document.querySelectorAll('.log-line');
        lines.forEach(div => {
            div.style.display = div.textContent.toLowerCase().includes(keyword) ? 'block' : 'none';
        });
    }

</script>
</body>
</html>