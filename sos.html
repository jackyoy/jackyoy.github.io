<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v10 (Complete)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --bg-dark: #1e1e2f; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: #0d6efd; }
        
        /* Main */
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        
        /* Cards & Boxes */
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .source-badge { font-size: 0.75rem; color: #fff; background-color: #6c757d; padding: 2px 8px; border-radius: 4px; font-weight: normal; font-family: monospace; }
        .console-box { background: #2d2d3b; color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        /* Upload */
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .upload-box { border: 2px dashed #ccc; padding: 40px; border-radius: 12px; background: #fff; text-align: center; cursor: pointer; width: 500px; }
        
        /* Log Explorer Layout */
        .log-container { display: flex; height: calc(100vh - 120px); gap: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; overflow: hidden; }
        .log-tree { width: 30%; background: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; font-size: 0.9rem; }
        .log-viewer { width: 70%; background: #1e1e1e; color: #ccc; font-family: monospace; padding: 15px; overflow-y: auto; white-space: pre; font-size: 0.85rem; display: flex; flex-direction: column; }
        .log-content { flex: 1; overflow-y: auto; white-space: pre; }
        
        .log-group { padding: 8px 15px; font-weight: bold; background: #e9ecef; border-bottom: 1px solid #dee2e6; font-size: 0.8rem; text-transform: uppercase; color: #555; }
        .log-item { padding: 6px 20px; cursor: pointer; border-bottom: 1px solid #f1f1f1; word-break: break-all; }
        .log-item:hover { background: #e2e6ea; color: #0d6efd; }
        .log-item.active { background: #0d6efd; color: #fff; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-3 fw-bold border-bottom border-secondary">RHEL SOS Analyzer v10</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ“Š ç¸½è¦½ (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">ğŸ–¥ï¸ ç³»çµ±æ·±åº¦è©•ä¼°</a>
            <a class="nav-link" onclick="switchTab('network')">ğŸŒ ç¶²è·¯ç‹€æ…‹</a>
            <a class="nav-link" onclick="switchTab('logs')">ğŸ“ æ—¥èªŒç€è¦½å™¨</a>
            <a class="nav-link" onclick="switchTab('debug')">ğŸ æª”æ¡ˆæª¢æ¸¬</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="loader" class="alert alert-info hidden">æ­£åœ¨å»ºç«‹ç´¢å¼•èˆ‡è§£æ...</div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="fs-1 mb-2">ğŸ“‚</div>
                <h4>ä¸Šå‚³ SOS Report è³‡æ–™å¤¾</h4>
                <p class="text-muted small">æ”¯æ´å®Œæ•´ç›®éŒ„è§£æ</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ¦‚è§€</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold text-primary" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            Top Memory Processes
                            <span class="source-badge" id="src-ps-dash">Pending</span>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>CPU%</th><th>COMMAND</th></tr></thead>
                                <tbody id="mem-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">ç¡¬é«”èˆ‡ç³»çµ±æ·±åº¦è³‡è¨Š</h4>
            
            <div class="card">
                <div class="card-header">Middleware Processes <span class="source-badge" id="src-ps-mid">Pending</span></div>
                <div class="card-body">
                    <div class="console-box" id="info-middleware">Scanning...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Hardware & BIOS <span class="source-badge" id="src-dmi">Pending</span></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4"><strong>Model:</strong> <span id="info-model">-</span></div>
                        <div class="col-md-4"><strong>Vendor:</strong> <span id="info-vendor">-</span></div>
                        <div class="col-md-4"><strong>BIOS:</strong> <span id="info-bios">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
             <h4 class="mb-3">ç¶²è·¯åˆ†æ</h4>
             <div class="card">
                <div class="card-header">Listening Ports (Netstat/SS) <span class="source-badge" id="src-ss">Pending</span></div>
                <div class="card-body">
                    <div class="console-box" id="net-ss">Searching...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">IP Address <span class="source-badge" id="src-ip">Pending</span></div>
                <div class="card-body"><div class="console-box" id="net-ip">Searching...</div></div>
            </div>
        </div>

        <div id="view-logs" class="content-view hidden">
            <h4 class="mb-3">æ—¥èªŒç€è¦½å™¨ (Log Explorer)</h4>
            <div class="log-container">
                <div class="log-tree" id="log-tree">
                    <div class="p-3 text-muted">è«‹å…ˆä¸Šå‚³æª”æ¡ˆ</div>
                </div>
                <div class="log-viewer">
                    <div class="border-bottom pb-2 mb-2 d-flex justify-content-between">
                        <strong id="log-current-file">No file selected</strong>
                        <input type="text" id="log-search-input" class="form-control form-control-sm w-25 bg-dark text-light border-secondary" placeholder="Search..." onkeyup="filterLogContent()">
                    </div>
                    <div class="log-content" id="log-content-area"></div>
                </div>
            </div>
        </div>

        <div id="view-debug" class="content-view hidden">
            <h4>æª”æ¡ˆç´¢å¼•æª¢æ¸¬ (Debug)</h4>
            <div class="console-box" id="debug-list"></div>
        </div>

    </div>

    <script>
        const App = {
            files: new Map(),
            filePaths: [],
            cache: {},
            currentLogText: "", // For log search
            
            // Rules from v9
            rules: {
                ps: [/ps_aux.*$/, /ps_auxwwwm$/], 
                netstat: [/netstat.*neopa$/, /netstat.*-W.*$/, /netstat$/],
                ss: [/ss_-tulpn$/],
                hostname: [/hostname$/],
                release: [/redhat-release$/],
                uptime: [/uptime$/],
                uname: [/uname_-a$/],
                dmidecode: [/dmidecode$/],
                ip: [/ip_.*addr$/]
            }
        };

        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;

            document.getElementById('loader').classList.remove('hidden');
            
            App.files.clear();
            App.filePaths = [];
            App.cache = {};

            let debugLog = "";
            for (let f of fileList) {
                const parts = f.webkitRelativePath.split('/');
                const relPath = parts.slice(1).join('/'); 
                if (f.size > 0) {
                    App.files.set(relPath, f);
                    App.filePaths.push(relPath);
                    debugLog += `${relPath} (${f.size} B)\n`;
                }
            }
            document.getElementById('debug-list').textContent = debugLog;

            try {
                // Parallel Execution
                await Promise.all([
                    runDashboard(), 
                    runHostInfo(), 
                    runNetwork(),
                    buildLogTree() // Build the tree UI
                ]);
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("è§£æéŒ¯èª¤: " + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // --- Core Helpers ---
        async function findAndRead(ruleKey) {
            const regexList = App.rules[ruleKey];
            if (!regexList) return { content: null, path: null };

            let foundPath = null;
            const matches = App.filePaths.filter(p => regexList.some(r => r.test(p)));
            if (matches.length > 0) {
                matches.sort((a, b) => b.length - a.length); 
                const best = matches.find(m => m.includes('sos_commands')) || matches[0];
                foundPath = best;
            }

            if (foundPath) {
                if (!App.cache[foundPath]) {
                    App.cache[foundPath] = await App.files.get(foundPath).text();
                }
                return { content: App.cache[foundPath], path: foundPath };
            }
            return { content: null, path: null };
        }

        async function readFileByPath(path) {
            if (!App.files.has(path)) return null;
            if (App.cache[path]) return App.cache[path];
            const text = await App.files.get(path).text();
            App.cache[path] = text;
            return text;
        }

        function showSrc(id, path) {
            const el = document.getElementById(id);
            if (el) el.textContent = path ? `SRC: .../${path.split('/').pop()}` : 'Not Found';
        }

        // --- Modules ---

        async function runDashboard() {
            const h = await findAndRead('hostname');
            if(h.content) document.getElementById('dash-hostname').textContent = h.content.trim();

            const r = await findAndRead('release');
            if(r.content) document.getElementById('dash-release').textContent = r.content.split('\n')[0];

            const u = await findAndRead('uptime');
            if(u.content) document.getElementById('dash-uptime').textContent = u.content.trim();

            const k = await findAndRead('uname');
            if (k.content) {
                const parts = k.content.split(' ');
                if (parts.length >= 3) document.getElementById('dash-kernel').textContent = parts[2];
                else document.getElementById('dash-kernel').textContent = k.content;
            }
        }

        async function runHostInfo() {
            const ps = await findAndRead('ps');
            showSrc('src-ps-dash', ps.path);
            showSrc('src-ps-mid', ps.path);

            if (ps.content) {
                const lines = ps.content.split('\n');
                let headerIndex = -1;
                for(let i=0; i<Math.min(50, lines.length); i++) {
                    if (lines[i].includes('PID') && lines[i].includes('%MEM') && lines[i].includes('COMMAND')) {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex !== -1) {
                    const parsed = [];
                    for (let i = headerIndex + 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const parts = line.split(/\s+/);
                        const pidStr = parts[1];
                        if (pidStr === '-' || isNaN(parseInt(pidStr))) continue; // Fix: Skip kernel threads
                        if (parts.length < 10) continue;

                        const mem = parseFloat(parts[3]);
                        const cpu = parseFloat(parts[2]);
                        const cmd = parts.slice(10).join(' ');

                        if (!isNaN(mem)) parsed.push({ user: parts[0], pid: pidStr, mem, cpu, cmd });
                    }

                    const top5 = parsed.sort((a, b) => b.mem - a.mem).slice(0, 5);
                    document.getElementById('mem-table-body').innerHTML = top5.map(p => 
                        `<tr><td>${p.pid}</td><td>${p.user}</td><td>${p.mem}%</td><td>${p.cpu}%</td><td class="text-truncate" style="max-width:200px" title="${p.cmd}">${p.cmd}</td></tr>`
                    ).join('');

                    const mwRegex = /java|python|node|httpd|nginx|mysql|postgres|docker|kube/i;
                    const mw = parsed.filter(p => mwRegex.test(p.cmd) && !p.cmd.includes(' grep '));
                    document.getElementById('info-middleware').textContent = mw.length ? mw.map(p => `${p.user} (${p.pid}): ${p.cmd}`).join('\n') : "No common middleware found.";
                }
            }

            const dmi = await findAndRead('dmidecode');
            showSrc('src-dmi', dmi.path);
            if(dmi.content) {
                const prod = (dmi.content.match(/Product Name:\s*(.+)/) || [])[1];
                const vend = (dmi.content.match(/Manufacturer:\s*(.+)/) || [])[1];
                const bios = (dmi.content.match(/Version:\s*(.+)/) || [])[1];
                if(prod) document.getElementById('info-model').textContent = prod;
                if(vend) document.getElementById('info-vendor').textContent = vend;
                if(bios) document.getElementById('info-bios').textContent = bios;
            }
        }

        async function runNetwork() {
            let net = await findAndRead('netstat');
            let source = "netstat";
            if (!net.content) {
                net = await findAndRead('ss');
                source = "ss";
            }
            showSrc('src-ss', net.path);

            if (net.content) {
                const lines = net.content.split('\n');
                let output = "";
                if (source === 'netstat') output = lines.filter(l => l.includes('Proto') || l.includes('LISTEN')).join('\n');
                else output = lines.filter(l => l.includes('State') || l.includes('LISTEN')).join('\n');
                document.getElementById('net-ss').textContent = output || "No LISTEN ports found.";
            }

            const ip = await findAndRead('ip');
            showSrc('src-ip', ip.path);
            if(ip.content) document.getElementById('net-ip').textContent = ip.content;
        }

        // --- Log Explorer (Restored) ---
        function buildLogTree() {
            const tree = document.getElementById('log-tree');
            tree.innerHTML = '';
            
            // Filters
            const categories = {
                "System": [/var\/log\/messages/, /dmesg/, /var\/log\/boot/],
                "Security": [/var\/log\/secure/, /audit\/audit.log/],
                "Package": [/var\/log\/dnf/, /var\/log\/yum/],
                "Cron": [/var\/log\/cron/],
                "Others": []
            };

            const found = { "System": [], "Security": [], "Package": [], "Cron": [], "Others": [] };

            // Scan all paths
            App.filePaths.forEach(p => {
                // Must look like a log file
                if (!p.includes('var/log') && !p.includes('sos_commands/logs') && !p.includes('dmesg')) return;
                if (p.endsWith('.gz') || p.endsWith('wtmp') || p.endsWith('lastlog')) return; // Skip binaries

                let matched = false;
                for (let cat in categories) {
                    if (cat === "Others") continue;
                    if (categories[cat].some(r => r.test(p))) {
                        found[cat].push(p);
                        matched = true;
                        break;
                    }
                }
                if (!matched && p.includes('var/log')) found['Others'].push(p);
            });

            // Render
            for (let cat in found) {
                if (found[cat].length === 0) continue;
                
                const title = document.createElement('div');
                title.className = 'log-group';
                title.textContent = cat;
                tree.appendChild(title);

                found[cat].sort(); // Alphabetical
                found[cat].forEach(path => {
                    const item = document.createElement('div');
                    item.className = 'log-item';
                    item.textContent = path.split('/').pop();
                    item.onclick = () => loadLogContent(path, item);
                    tree.appendChild(item);
                });
            }
        }

        async function loadLogContent(path, el) {
            document.querySelectorAll('.log-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            
            document.getElementById('log-current-file').textContent = path;
            const viewer = document.getElementById('log-content-area');
            viewer.textContent = "Loading...";

            let text = await readFileByPath(path);
            if (!text) {
                viewer.textContent = "Error loading file.";
                return;
            }

            // Truncate if too big
            if (text.length > 50000) {
                text = `[File too large. Showing last 50,000 characters]\n...\n` + text.slice(-50000);
            }

            App.currentLogText = text;
            viewer.textContent = text;
            // Auto scroll to bottom
            viewer.scrollTop = viewer.scrollHeight;
        }

        function filterLogContent() {
            const term = document.getElementById('log-search-input').value.toLowerCase();
            const viewer = document.getElementById('log-content-area');
            
            if (!term) {
                viewer.textContent = App.currentLogText;
                return;
            }

            // Simple line filter
            const lines = App.currentLogText.split('\n');
            const filtered = lines.filter(l => l.toLowerCase().includes(term));
            viewer.textContent = filtered.join('\n');
        }

        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            const navs = document.querySelectorAll('.nav-link');
            for(let n of navs) {
                if(n.getAttribute('onclick').includes(id)) n.classList.add('active');
            }
        }
    </script>
</body>
</html>