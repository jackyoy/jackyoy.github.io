<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v8 (Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --bg-dark: #1e1e2f; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: #0d6efd; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .source-badge { font-size: 0.75rem; color: #666; font-weight: normal; font-family: monospace; background: #eee; padding: 2px 6px; border-radius: 4px; }
        
        .console-box { background: #2d2d3b; color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .upload-box { border: 2px dashed #ccc; padding: 40px; border-radius: 12px; background: #fff; text-align: center; cursor: pointer; width: 500px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-3 fw-bold border-bottom border-secondary">RHEL SOS Analyzer v8</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ“Š ç¸½è¦½ (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">ğŸ–¥ï¸ ç³»çµ±æ·±åº¦è©•ä¼°</a>
            <a class="nav-link" onclick="switchTab('network')">ğŸŒ ç¶²è·¯ç‹€æ…‹</a>
            <a class="nav-link" onclick="switchTab('debug')">ğŸ æª”æ¡ˆæª¢æ¸¬</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="loader" class="alert alert-info hidden">æ­£åœ¨è§£ææª”æ¡ˆçµæ§‹...</div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="fs-1 mb-2">ğŸ“‚</div>
                <h4>ä¸Šå‚³ SOS Report è³‡æ–™å¤¾</h4>
                <p class="text-muted small">æ”¯æ´ webkitdirectory (è«‹é¸æ“‡è§£å£“å¾Œçš„ç›®éŒ„)</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ¦‚è§€</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold text-primary" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            Top Memory Processes
                            <span class="source-badge" id="src-ps-dash">Pending</span>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>CPU%</th><th>COMMAND</th></tr></thead>
                                <tbody id="mem-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">ç¡¬é«”èˆ‡ç³»çµ±æ·±åº¦è³‡è¨Š</h4>
            
            <div class="card">
                <div class="card-header">Hardware & BIOS <span class="source-badge" id="src-dmi">Pending</span></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4"><strong>Model:</strong> <span id="info-model">-</span></div>
                        <div class="col-md-4"><strong>Vendor:</strong> <span id="info-vendor">-</span></div>
                        <div class="col-md-4"><strong>BIOS:</strong> <span id="info-bios">-</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Middleware Processes <span class="source-badge" id="src-ps-mid">Pending</span></div>
                <div class="card-body">
                    <div class="console-box" id="info-middleware">Scanning...</div>
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
             <h4 class="mb-3">ç¶²è·¯åˆ†æ</h4>
             <div class="card">
                <div class="card-header">Listening Ports <span class="source-badge" id="src-ss">Pending</span></div>
                <div class="card-body">
                    <div class="alert alert-light border small">
                        <strong>Logic:</strong> Tries `ss -tulpn` first, falls back to `netstat -neopa`
                    </div>
                    <div class="console-box" id="net-ss">Searching...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">IP Address <span class="source-badge" id="src-ip">Pending</span></div>
                <div class="card-body"><div class="console-box" id="net-ip">Searching...</div></div>
            </div>
        </div>

        <div id="view-debug" class="content-view hidden">
            <h4>æª”æ¡ˆç´¢å¼•æª¢æ¸¬ (Debug)</h4>
            <p class="text-muted">å¦‚æœè³‡æ–™é¡¯ç¤ºç‚ºç©ºï¼Œè«‹æª¢æŸ¥ä¸‹æ–¹åˆ—è¡¨æ˜¯å¦åŒ…å«è©²æª”æ¡ˆ (éæ¿¾äº† 0 byte çš„æ·å¾‘)ã€‚</p>
            <div class="console-box" id="debug-list"></div>
        </div>

    </div>

    <script>
        const App = {
            files: new Map(),
            filePaths: [],
            cache: {},
            
            // å®šç¾©æ­£è¦è¡¨é”å¼æœå°‹è¦å‰‡
            rules: {
                ps: [/sos_commands\/process\/ps_auxww$/, /ps_aux$/, /ps_auxww$/], 
                ss: [/sos_commands\/networking\/ss_-tulpn$/, /ss_-tulpn$/],
                netstat: [/sos_commands\/networking\/netstat_-W_-neopa$/, /netstat.*neopa$/], // Fallback
                hostname: [/sos_commands\/host\/hostname$/, /hostname$/],
                release: [/etc\/redhat-release$/, /redhat-release$/],
                uptime: [/sos_commands\/host\/uptime$/, /uptime$/],
                uname: [/sos_commands\/kernel\/uname_-a$/, /uname_-a$/], // ä¿®æ­£ v7 éºå¤±çš„éƒ¨åˆ†
                dmidecode: [/sos_commands\/hardware\/dmidecode$/, /dmidecode$/],
                ip: [/sos_commands\/networking\/ip_-o_addr$/, /ip_addr$/]
            }
        };

        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;

            document.getElementById('loader').classList.remove('hidden');
            
            // Reset
            App.files.clear();
            App.filePaths = [];
            App.cache = {};

            // Indexing
            let debugLog = "";
            for (let f of fileList) {
                // æ­£è¦åŒ–è·¯å¾‘
                const parts = f.webkitRelativePath.split('/');
                const relPath = parts.slice(1).join('/'); // ç§»é™¤ç¬¬ä¸€å±¤è³‡æ–™å¤¾
                
                // æ’é™¤ 0 bytes çš„ç¬¦è™Ÿé€£çµ
                if (f.size > 0) {
                    App.files.set(relPath, f);
                    App.filePaths.push(relPath);
                    debugLog += `[LOADED] ${relPath} (${f.size} B)\n`;
                }
            }
            document.getElementById('debug-list').textContent = debugLog;

            try {
                await Promise.all([runDashboard(), runHostInfo(), runNetwork()]);
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("è§£æéŒ¯èª¤: " + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // --- æ ¸å¿ƒæœå°‹å¼•æ“ ---
        async function findAndRead(ruleKey) {
            const regexList = App.rules[ruleKey];
            if (!regexList) return { content: null, path: null };

            let foundPath = null;

            // å˜—è©¦åŒ¹é…
            for (let regex of regexList) {
                const match = App.filePaths.find(p => regex.test(p));
                if (match) {
                    foundPath = match;
                    break;
                }
            }

            if (foundPath) {
                console.log(`Matched [${ruleKey}] -> ${foundPath}`);
                if (!App.cache[foundPath]) {
                    App.cache[foundPath] = await App.files.get(foundPath).text();
                }
                return { content: App.cache[foundPath], path: foundPath };
            }
            return { content: null, path: null };
        }

        function showSrc(id, path) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = path ? `SRC: .../${path.split('/').pop()}` : 'Not Found';
                el.classList.toggle('text-danger', !path);
            }
        }

        // --- è§£æé‚è¼¯ ---

        async function runDashboard() {
            // Hostname
            const h = await findAndRead('hostname');
            if(h.content) document.getElementById('dash-hostname').textContent = h.content.trim();

            // Release
            const r = await findAndRead('release');
            if(r.content) document.getElementById('dash-release').textContent = r.content.split('\n')[0];

            // Uptime
            const u = await findAndRead('uptime');
            if(u.content) document.getElementById('dash-uptime').textContent = u.content.trim();

            // Kernel (Fix: Explicitly check uname)
            const k = await findAndRead('uname');
            if (k.content) {
                // uname -a output: Linux hostname 4.18.0-xxx ...
                const parts = k.content.split(' ');
                // é€šå¸¸ç¬¬ä¸‰å€‹æ¬„ä½æ˜¯ kernel version
                if (parts.length >= 3) document.getElementById('dash-kernel').textContent = parts[2];
                else document.getElementById('dash-kernel').textContent = k.content;
            } else {
                document.getElementById('dash-kernel').textContent = "uname file not found";
            }
        }

        async function runHostInfo() {
            // PS List
            const ps = await findAndRead('ps');
            showSrc('src-ps-dash', ps.path);
            showSrc('src-ps-mid', ps.path);

            if (ps.content) {
                const lines = ps.content.split('\n');
                
                // Smart Parse: å°‹æ‰¾æ¨™é ­è¡Œ (åŒ…å« PID å’Œ MEM çš„è¡Œ)
                let headerIndex = -1;
                for(let i=0; i < Math.min(50, lines.length); i++) {
                    if (lines[i].includes('PID') && lines[i].includes('%MEM')) {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex !== -1) {
                    const dataLines = lines.slice(headerIndex + 1);
                    const parsed = [];
                    
                    dataLines.forEach(line => {
                        const parts = line.trim().split(/\s+/);
                        if (parts.length < 10) return;
                        
                        // æ¨™æº– ps aux æ¬„ä½: USER(0) PID(1) %CPU(2) %MEM(3)
                        const mem = parseFloat(parts[3]);
                        const cpu = parseFloat(parts[2]);
                        const cmd = parts.slice(10).join(' '); // åˆä½µæŒ‡ä»¤

                        if (!isNaN(mem)) {
                            parsed.push({ user: parts[0], pid: parts[1], mem, cpu, cmd });
                        }
                    });

                    // Sort
                    const top5 = parsed.sort((a, b) => b.mem - a.mem).slice(0, 5);
                    document.getElementById('mem-table-body').innerHTML = top5.map(p => 
                        `<tr><td>${p.pid}</td><td>${p.user}</td><td>${p.mem}%</td><td>${p.cpu}%</td><td class="text-truncate" style="max-width:200px" title="${p.cmd}">${p.cmd}</td></tr>`
                    ).join('');

                    // Middleware
                    const mw = parsed.filter(p => p.cmd.match(/java|python|node|httpd|nginx|mysql|postgres|docker|kube/i) && !p.cmd.includes(' grep '));
                    document.getElementById('info-middleware').textContent = mw.length ? mw.map(p => `${p.user} (${p.pid}): ${p.cmd}`).join('\n') : "No middleware found";
                } else {
                    document.getElementById('mem-table-body').innerHTML = "<tr><td colspan='5'>Cannot find PID/MEM header in ps file</td></tr>";
                }
            }

            // DMI
            const dmi = await findAndRead('dmidecode');
            showSrc('src-dmi', dmi.path);
            if(dmi.content) {
                const prod = (dmi.content.match(/Product Name:\s*(.+)/) || [])[1];
                const vend = (dmi.content.match(/Manufacturer:\s*(.+)/) || [])[1];
                const bios = (dmi.content.match(/Version:\s*(.+)/) || [])[1];
                
                if(prod) document.getElementById('info-model').textContent = prod;
                if(vend) document.getElementById('info-vendor').textContent = vend;
                if(bios) document.getElementById('info-bios').textContent = bios;
            }
        }

        async function runNetwork() {
            // Logic: Try SS -> Fail -> Try Netstat
            let netFile = await findAndRead('ss');
            let type = 'ss';
            
            if (!netFile.content) {
                console.log("SS not found, trying Netstat...");
                netFile = await findAndRead('netstat');
                type = 'netstat';
            }

            showSrc('src-ss', netFile.path);
            
            if (netFile.content) {
                let text = netFile.content;
                // Netstat cleanup: remove first 2 lines usually
                if (type === 'netstat' && text.includes('Active Internet connections')) {
                    // ç°¡å–®éæ¿¾ä¸€ä¸‹ï¼Œåªé¡¯ç¤º LISTEN ç‹€æ…‹
                    const lines = text.split('\n');
                    const listenLines = lines.filter(l => l.includes('LISTEN') || l.includes('Proto'));
                    document.getElementById('net-ss').textContent = listenLines.join('\n');
                } else {
                    document.getElementById('net-ss').textContent = text;
                }
            } else {
                document.getElementById('net-ss').textContent = "Neither 'ss -tulpn' nor 'netstat' found.";
            }

            // IP
            const ip = await findAndRead('ip');
            showSrc('src-ip', ip.path);
            if(ip.content) document.getElementById('net-ip').textContent = ip.content;
        }

        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            // Fuzzy match active nav
            const navs = document.querySelectorAll('.nav-link');
            for(let n of navs) {
                if(n.getAttribute('onclick').includes(id)) n.classList.add('active');
            }
        }
    </script>
</body>
</html>