<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v7 (Smart Parse)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --bg-dark: #1e1e2f; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: #0d6efd; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .source-badge { font-size: 0.7rem; color: #999; font-weight: normal; font-family: monospace; }
        
        .console-box { background: #2d2d3b; color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .upload-box { border: 2px dashed #ccc; padding: 40px; border-radius: 12px; background: #fff; text-align: center; cursor: pointer; width: 500px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-3 fw-bold border-bottom border-secondary">RHEL SOS Analyzer v7</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">üìä Á∏ΩË¶Ω (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">üñ•Ô∏è Á≥ªÁµ±Ê∑±Â∫¶Ë©ï‰º∞</a>
            <a class="nav-link" onclick="switchTab('network')">üåê Á∂≤Ë∑ØÁãÄÊÖã</a>
            <a class="nav-link" onclick="switchTab('debug')">üêû Ê™îÊ°àÈô§ÈåØ</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="loader" class="alert alert-info hidden">Ëß£Êûê‰∏≠...</div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="fs-1 mb-2">üìÇ</div>
                <h4>‰∏äÂÇ≥ SOS Report</h4>
                <p class="text-muted small">ÈÅ∏ÊìáËß£Â£ìÁ∏ÆÂæåÁöÑË≥áÊñôÂ§æ</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">Á≥ªÁµ±Ê¶ÇËßÄ</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold text-primary" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            Top Memory Processes
                            <span class="source-badge" id="src-ps-dash"></span>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>CPU%</th><th>COMMAND</th></tr></thead>
                                <tbody id="mem-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">Á°¨È´îËàáÁ≥ªÁµ±Ê∑±Â∫¶Ë≥áË®ä</h4>
            
            <div class="card">
                <div class="card-header">Middleware Processes <span class="source-badge" id="src-ps-mid"></span></div>
                <div class="card-body">
                    <div class="console-box" id="info-middleware">Scanning...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Hardware & BIOS <span class="source-badge" id="src-dmi"></span></div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">Product: <strong id="info-model">-</strong></li>
                        <li class="list-group-item">Vendor: <strong id="info-vendor">-</strong></li>
                        <li class="list-group-item">BIOS: <strong id="info-bios">-</strong></li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
             <h4 class="mb-3">Á∂≤Ë∑ØÂàÜÊûê</h4>
             <div class="card">
                <div class="card-header">Listening Ports (ss -tulpn) <span class="source-badge" id="src-ss"></span></div>
                <div class="card-body"><div class="console-box" id="net-ss">Searching...</div></div>
            </div>
            <div class="card">
                <div class="card-header">IP Address <span class="source-badge" id="src-ip"></span></div>
                <div class="card-body"><div class="console-box" id="net-ip">Searching...</div></div>
            </div>
        </div>

        <div id="view-debug" class="content-view hidden">
            <h4>File Index Debugger</h4>
            <div class="console-box" id="debug-list"></div>
        </div>

    </div>

    <script>
        const App = {
            files: new Map(),
            filePaths: [], // ÂÑ≤Â≠òÂ≠ó‰∏≤Èô£ÂàóÔºåÁî®ÊñºÊêúÂ∞ã
            cache: {},
            
            // Regex Search Rules (Êõ¥ÂØ¨È¨ÜÁöÑÂåπÈÖçÁ≠ñÁï•)
            rules: {
                // Âè™Ë¶ÅÂåÖÂê´ ps_aux ‰∏î‰∏çÂåÖÂê´ jpg/gz Á≠âÈùûÊñáÂ≠óÊ™î
                ps: [/ps_auxww$/, /ps_aux$/, /ps$/], 
                // Âè™Ë¶ÅÂåÖÂê´ ss_ ‰∏îÂåÖÂê´ tulpn
                ss: [/ss_.*tulpn/, /netstat.*tulpn/],
                hostname: [/hostname$/],
                release: [/redhat-release$/],
                uptime: [/uptime$/],
                dmidecode: [/dmidecode$/],
                ip: [/ip_.*addr$/]
            }
        };

        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;

            document.getElementById('loader').classList.remove('hidden');
            
            // Reset
            App.files.clear();
            App.filePaths = [];
            App.cache = {};

            // Indexing (Filter out empty symlinks)
            let debugLog = "--- Indexing ---\n";
            for (let f of fileList) {
                // ÂéªÈô§È†ÇÂ±§ÁõÆÈåÑÂêçÁ®±ÔºåÁµ±‰∏ÄÁõ∏Â∞çË∑ØÂæë
                const parts = f.webkitRelativePath.split('/');
                const relPath = parts.slice(1).join('/');
                
                if (f.size > 0) {
                    App.files.set(relPath, f);
                    App.filePaths.push(relPath);
                    debugLog += `[OK] ${relPath} (${f.size} bytes)\n`;
                } else {
                    debugLog += `[SKIP] ${relPath} (0 bytes/Symlink)\n`;
                }
            }
            document.getElementById('debug-list').textContent = debugLog;

            try {
                await Promise.all([runDashboard(), runHostInfo(), runNetwork()]);
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("Ëß£ÊûêÈåØË™§: " + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // --- Core: Fuzzy Finder ---
        async function findAndRead(ruleKey) {
            const regexList = App.rules[ruleKey] || [new RegExp(ruleKey)];
            
            // ÊêúÂ∞ãÁ≠ñÁï•ÔºöÈÅçÊ≠∑ÊâÄÊúâÊ™îÊ°àË∑ØÂæëÔºåÁúãÊòØÂê¶ÊúâÁ¨¶Âêà Regex ÁöÑ
            let foundPath = null;

            for (let regex of regexList) {
                // ÂÑ™ÂÖàÊâæË∑ØÂæëÂåÖÂê´ sos_commands ÁöÑ (ËºÉÂèØËÉΩÊòØÂéüÂßãÂÖßÂÆπ)
                const candidates = App.filePaths.filter(p => regex.test(p));
                
                if (candidates.length > 0) {
                    // ÊéíÂ∫èÂÑ™ÂåñÔºöÂÑ™ÂÖàÈÅ∏Ë∑ØÂæëËºÉÈï∑ÁöÑ (ÈÄöÂ∏∏Ê∑±Â±§Ë∑ØÂæëÊòØÁúüÊ™îÊ°à)Ôºå‰∏îÂåÖÂê´ sos_commands
                    candidates.sort((a, b) => {
                        const scoreA = (a.includes('sos_commands') ? 10 : 0) + a.length;
                        const scoreB = (b.includes('sos_commands') ? 10 : 0) + b.length;
                        return scoreB - scoreA;
                    });
                    foundPath = candidates[0];
                    break;
                }
            }

            if (foundPath) {
                console.log(`Matched [${ruleKey}] -> ${foundPath}`);
                if (!App.cache[foundPath]) {
                    App.cache[foundPath] = await App.files.get(foundPath).text();
                }
                return { content: App.cache[foundPath], path: foundPath };
            }
            return { content: null, path: null };
        }

        function showSrc(id, path) {
            const el = document.getElementById(id);
            if (el) el.textContent = path ? `Source: .../${path.split('/').pop()}` : '(Not Found)';
        }

        // --- Renderers ---

        async function runDashboard() {
            // Basic Info
            const h = await findAndRead('hostname');
            if(h.content) document.getElementById('dash-hostname').textContent = h.content.trim();

            const r = await findAndRead('release');
            if(r.content) document.getElementById('dash-release').textContent = r.content.trim();

            const u = await findAndRead('uptime');
            if(u.content) document.getElementById('dash-uptime').textContent = u.content.trim();
        }

        async function runHostInfo() {
            // 1. Process List (The Smart Parsing Part)
            const psRes = await findAndRead('ps');
            showSrc('src-ps-dash', psRes.path);
            showSrc('src-ps-mid', psRes.path);

            if (psRes.content) {
                const lines = psRes.content.split('\n');
                
                // Smart Parse: Find the header line first
                let headerIndex = -1;
                for(let i=0; i<Math.min(20, lines.length); i++) {
                    if (lines[i].includes('PID') && lines[i].includes('%MEM') && lines[i].includes('COMMAND')) {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex !== -1) {
                    // Extract Data
                    const dataLines = lines.slice(headerIndex + 1);
                    const parsed = [];
                    
                    for (let line of dataLines) {
                        const parts = line.trim().split(/\s+/);
                        // Ê†áÂáÜ ps aux: USER(0) PID(1) %CPU(2) %MEM(3) ... START(8) TIME(9) COMMAND(10...)
                        // ÈúÄË¶ÅÈò≤ÂëÜÔºåÁ¢∫‰øùÊ¨Ñ‰ΩçË∂≥Â§†
                        if (parts.length < 10) continue;
                        
                        const mem = parseFloat(parts[3]);
                        if (isNaN(mem)) continue;

                        // Command ÂèØËÉΩÊòØÂâ©È§òÊâÄÊúâÈÉ®ÂàÜÁöÑÁµÑÂêà
                        const cmd = parts.slice(10).join(' ');

                        parsed.push({
                            pid: parts[1],
                            user: parts[0],
                            mem: mem,
                            cpu: parts[2],
                            cmd: cmd
                        });
                    }

                    // Sort by MEM
                    const topMem = parsed.sort((a, b) => b.mem - a.mem).slice(0, 5);
                    const tbody = document.getElementById('mem-table-body');
                    tbody.innerHTML = topMem.map(p => 
                        `<tr><td>${p.pid}</td><td>${p.user}</td><td>${p.mem}%</td><td>${p.cpu}%</td><td class="text-truncate" style="max-width:200px" title="${p.cmd}">${p.cmd}</td></tr>`
                    ).join('');

                    // Filter Middleware
                    const mwRegex = /java|httpd|nginx|mysql|postgres|oracle|docker|kube|python|node/i;
                    const mwList = parsed.filter(p => mwRegex.test(p.cmd) && !p.cmd.includes(' grep '));
                    
                    const mwBox = document.getElementById('info-middleware');
                    if (mwList.length > 0) {
                        mwBox.textContent = mwList.map(p => `${p.user} (${p.pid}): ${p.cmd}`).join('\n');
                    } else {
                        mwBox.textContent = "No common middleware processes found in ps output.";
                    }

                } else {
                    document.getElementById('info-middleware').textContent = "Error: PS header not found in file.";
                }
            } else {
                 document.getElementById('mem-table-body').innerHTML = '<tr><td colspan="5">PS log not found</td></tr>';
            }

            // 2. DMI
            const dmi = await findAndRead('dmidecode');
            showSrc('src-dmi', dmi.path);
            if (dmi.content) {
                const prod = (dmi.content.match(/Product Name:\s*(.+)/) || [])[1];
                if(prod) document.getElementById('info-model').textContent = prod;
                
                const vend = (dmi.content.match(/Manufacturer:\s*(.+)/) || [])[1];
                if(vend) document.getElementById('info-vendor').textContent = vend;

                const bios = (dmi.content.match(/Version:\s*(.+)/) || [])[1];
                if(bios) document.getElementById('info-bios').textContent = bios;
            }
        }

        async function runNetwork() {
            // SS (Listening Ports)
            const ss = await findAndRead('ss');
            showSrc('src-ss', ss.path);
            if (ss.content) {
                document.getElementById('net-ss').textContent = ss.content;
            } else {
                document.getElementById('net-ss').textContent = "File containing 'ss' and 'tulpn' not found.";
            }

            // IP
            const ip = await findAndRead('ip');
            showSrc('src-ip', ip.path);
            if (ip.content) document.getElementById('net-ip').textContent = ip.content;
        }

        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            // Find nav link roughly
            const navs = document.querySelectorAll('.nav-link');
            for(let n of navs) {
                if(n.getAttribute('onclick').includes(id)) n.classList.add('active');
            }
        }

    </script>
</body>
</html>