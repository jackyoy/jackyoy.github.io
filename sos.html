<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Report Analyzer (Debug Version)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-bg: #f8f9fa; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', monospace; }
        .upload-area { border: 2px dashed #6c757d; border-radius: 10px; padding: 30px; text-align: center; background: white; cursor: pointer; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f1f8ff; }
        .debug-console { background: #212529; color: #00ff00; font-family: 'Consolas', monospace; font-size: 0.85rem; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .log-warn { color: #ffc107; }
        .log-err { color: #ff6b6b; }
        .log-info { color: #81d4fa; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="fw-bold text-center mb-4">SOS Report Analyzer <span class="badge bg-warning text-dark">Debug Mode</span></h3>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <h4>ğŸ“‚ é»æ“Šé¸æ“‡è³‡æ–™å¤¾</h4>
                <p class="text-muted mb-0">è«‹é¸æ“‡è§£å£“ç¸®å¾Œçš„ sosreport è³‡æ–™å¤¾</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between">
                <div>
                    <h5 id="os-hostname" class="mb-0">Hostname: --</h5>
                    <small id="os-release" class="text-muted">OS: --</small>
                </div>
                <div class="text-end">
                    <h5 id="os-uptime" class="mb-0">Uptime: --</h5>
                    <small id="os-kernel" class="text-muted">Kernel: --</small>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Memory</div>
                    <div class="card-body">
                        <canvas id="memChart"></canvas>
                        <div class="text-center mt-2 fw-bold" id="mem-total">--</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">CPU</div>
                    <div class="card-body">
                        <p>Model: <span id="cpu-model" class="fw-bold">--</span></p>
                        <p>Logical Cores: <span id="cpu-logical" class="fw-bold">--</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Network</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-console" id="console">
        <div>> ç­‰å¾…æª”æ¡ˆä¸Šå‚³...</div>
    </div>
</div>

<script>
    let fileIndex = []; // å­˜å„²æ‰€æœ‰æª”æ¡ˆè·¯å¾‘çš„é™£åˆ—
    let fileObjects = {}; // è·¯å¾‘å°æ‡‰æª”æ¡ˆç‰©ä»¶çš„ Map

    function log(msg, type = 'info') {
        const consoleDiv = document.getElementById('console');
        const line = document.createElement('div');
        line.textContent = `> ${msg}`;
        if (type === 'warn') line.className = 'log-warn';
        if (type === 'error') line.className = 'log-err';
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        document.getElementById('console').innerHTML = ''; // Clear log
        document.getElementById('dashboard').style.display = 'none';
        
        log(`æ¥æ”¶åˆ° ${files.length} å€‹æª”æ¡ˆç‰©ä»¶ï¼Œé–‹å§‹å»ºç«‹ç´¢å¼•...`);

        fileIndex = [];
        fileObjects = {};

        // 1. å»ºç«‹ç´¢å¼•èˆ‡æ­£è¦åŒ–
        Array.from(files).forEach(file => {
            // webkitRelativePath ä¾‹å¦‚: "sosreport-server-20231001/proc/meminfo"
            const path = file.webkitRelativePath;
            fileIndex.push(path);
            fileObjects[path] = file;
        });

        // 2. åµæ¸¬æ ¹ç›®éŒ„åç§»é‡
        // sosreport çš„ç‰¹å¾µæ˜¯æœƒæœ‰ proc/meminfo æˆ– proc/version
        // æˆ‘å€‘å°‹æ‰¾é€™å€‹æª”æ¡ˆï¼Œä¸¦ä»¥æ­¤åˆ¤æ–· "root" å‰ç¶´æ˜¯ä»€éº¼
        const anchorFile = fileIndex.find(p => p.endsWith('/proc/meminfo') || p.endsWith('/proc/version'));
        
        if (!anchorFile) {
            log("âŒ åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é—œéµç³»çµ±è·¯å¾‘ (å¦‚ proc/meminfo)ã€‚è«‹ç¢ºèªæ‚¨æ˜¯å¦ä¸Šå‚³äº†æ­£ç¢ºçš„è³‡æ–™å¤¾ã€‚", "error");
            log("åµæ¸¬åˆ°çš„å‰ 5 å€‹æª”æ¡ˆè·¯å¾‘ç¯„ä¾‹ï¼š", "warn");
            fileIndex.slice(0, 5).forEach(f => log(" - " + f, "warn"));
            return;
        }

        // è¨ˆç®— Root Prefix (ä¾‹å¦‚ "Downloads/sosreport-X/")
        // å¦‚æœ anchorFile æ˜¯ "folder/proc/meminfo"ï¼Œprefix å°±æ˜¯ "folder/"
        const splitKey = anchorFile.includes('/proc/meminfo') ? '/proc/meminfo' : '/proc/version';
        const rootPrefix = anchorFile.split(splitKey)[0] + '/';
        
        log(`âœ… åµæ¸¬åˆ°è³‡æ–™å¤¾çµæ§‹æ ¹ç›®éŒ„: "${rootPrefix}"`);
        
        // 3. é–‹å§‹è§£æ
        try {
            await parseOS(rootPrefix);
            await parseMemory(rootPrefix);
            await parseCPU(rootPrefix);
            await parseNetwork(rootPrefix);
            document.getElementById('dashboard').style.display = 'block';
            log("ğŸ‰ è§£æå®Œæˆï¼");
        } catch (e) {
            log(`è§£æéç¨‹ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: ${e.message}`, "error");
            console.error(e);
        }
    }

    // æ ¸å¿ƒè®€å–å‡½å¼ï¼šæ”¯æ´æ¨¡ç³Šæœå°‹
    function readFile(rootPrefix, relativePath) {
        return new Promise((resolve) => {
            // ç­–ç•¥ 1: å˜—è©¦æ¨™æº–è·¯å¾‘ (Root + Relative)
            let targetPath = rootPrefix + relativePath;
            let file = fileObjects[targetPath];

            // ç­–ç•¥ 2: å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦æœå°‹ sos_commands ä¸‹çš„è·¯å¾‘ (å› ç‚ºæœ‰æ™‚å€™ ps åœ¨æ ¹ç›®éŒ„ï¼Œæœ‰æ™‚åœ¨ sos_commands)
            if (!file) {
                 // å˜—è©¦æ¨¡ç³ŠåŒ¹é…ï¼šæ‰¾å‡ºçµå°¾ç¬¦åˆ relativePath çš„æª”æ¡ˆ
                 // é€™å¯ä»¥è§£æ±º sos_commands è·¯å¾‘è®Šç•°çš„å•é¡Œ
                 const foundPath = fileIndex.find(p => p.startsWith(rootPrefix) && p.endsWith(relativePath));
                 if (foundPath) {
                     file = fileObjects[foundPath];
                     // log(`ğŸ” æ¨¡ç³ŠåŒ¹é…æˆåŠŸ: è«‹æ±‚ ${relativePath} -> æ‰¾åˆ° ${foundPath}`, "warn");
                 }
            }

            if (!file) {
                log(`âš ï¸ æ‰¾ä¸åˆ°æª”æ¡ˆ: ${relativePath}`, "warn");
                resolve(null);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => {
                log(`âŒ è®€å–å¤±æ•—: ${relativePath}`, "error");
                resolve(null);
            };
            reader.readAsText(file);
        });
    }

    // --- è§£æé‚è¼¯ ---

    async function parseOS(prefix) {
        log("æ­£åœ¨åˆ†æä½œæ¥­ç³»çµ±è³‡è¨Š...");
        const hostname = await readFile(prefix, 'hostname');
        if (hostname) document.getElementById('os-hostname').textContent = `Hostname: ${hostname.trim()}`;

        const release = await readFile(prefix, 'etc/redhat-release') || await readFile(prefix, 'etc/os-release');
        if (release) {
            // å–ç¬¬ä¸€è¡Œæˆ– PRETTY_NAME
            const line = release.split('\n')[0].replace(/"/g, '');
            document.getElementById('os-release').textContent = `OS: ${line}`;
        }

        const uptime = await readFile(prefix, 'uptime');
        if (uptime) {
             const upMatch = uptime.match(/up\s+([^,]+)/);
             if (upMatch) document.getElementById('os-uptime').textContent = `Uptime: ${upMatch[1]}`;
        }
    }

    async function parseMemory(prefix) {
        log("æ­£åœ¨åˆ†æè¨˜æ†¶é«”...");
        const data = await readFile(prefix, 'proc/meminfo');
        if (!data) return;

        const getVal = (k) => {
            const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm'));
            return m ? parseInt(m[1]) : 0;
        };

        const total = getVal('MemTotal');
        const free = getVal('MemFree');
        const buffers = getVal('Buffers');
        const cached = getVal('Cached');
        const slab = getVal('Slab');
        const used = total - free - buffers - cached - slab;

        document.getElementById('mem-total').textContent = `${(total/1024/1024).toFixed(2)} GB Total`;

        const ctx = document.getElementById('memChart').getContext('2d');
        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buff/Cache', 'Free'],
                datasets: [{
                    data: [used, buffers+cached+slab, free],
                    backgroundColor: ['#dc3545', '#ffc107', '#198754']
                }]
            },
            options: { plugins: { legend: { position: 'right' } } }
        });
    }

    async function parseCPU(prefix) {
        log("æ­£åœ¨åˆ†æ CPU...");
        const data = await readFile(prefix, 'proc/cpuinfo');
        if (!data) return;

        const model = data.match(/model name\s+:\s+(.+)/);
        if (model) document.getElementById('cpu-model').textContent = model[1];

        const count = (data.match(/processor\s+:/g) || []).length;
        document.getElementById('cpu-logical').textContent = count;
    }

    async function parseNetwork(prefix) {
        log("æ­£åœ¨åˆ†æç¶²è·¯ä»‹é¢...");
        // å˜—è©¦å¤šç¨®å¯èƒ½çš„ IP æŒ‡ä»¤è¼¸å‡ºè·¯å¾‘
        let data = await readFile(prefix, 'sos_commands/networking/ip_address');
        if (!data) data = await readFile(prefix, 'ip_addr'); // èˆŠç‰ˆç›¸å®¹
        
        const list = document.getElementById('net-list');
        list.innerHTML = '';

        if (!data) {
            list.innerHTML = '<div class="list-group-item text-muted">ç„¡ç¶²è·¯è³‡æ–™</div>';
            return;
        }

        // ç°¡å–® Regex è§£æ ip addr è¼¸å‡º
        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        let found = 0;
        while ((match = regex.exec(data)) !== null) {
            found++;
            const name = match[1];
            const state = match[2];
            const color = state === 'UP' ? 'bg-success' : 'bg-secondary';
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center p-2">
                    <span>${name}</span>
                    <span class="badge ${color}">${state}</span>
                </div>`;
        }
        log(`æ‰¾åˆ° ${found} å€‹ç¶²è·¯ä»‹é¢`);
    }

</script>
</body>
</html>