<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v7 (Stable)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: #212529; }
        
        /* ä»‹é¢å„ªåŒ– */
        .card { border: 1px solid rgba(0,0,0,.125); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; border-radius: 8px; }
        .card-header { background-color: #fff; border-bottom: 2px solid #f0f0f0; font-weight: 700; color: #495057; padding: 15px; }
        .card-body { padding: 20px; }
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area { border: 2px dashed #ced4da; border-radius: 12px; padding: 40px; text-align: center; background: #fff; cursor: pointer; transition: all 0.2s; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f1f8ff; transform: translateY(-2px); }
        
        /* Debug Console */
        .debug-console { background: #212529; color: #00ff00; font-family: 'Consolas', monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 200px; overflow-y: auto; margin-top: 20px; }
        .log-warn { color: #ffc107; } .log-err { color: #ff6b6b; } .log-debug { color: #adb5bd; }

        /* é‡è¦ï¼šåœ–è¡¨å®¹å™¨é™åˆ¶ (é˜²æ­¢ç„¡é™ä¸‹æ²‰) */
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0">RHEL SOS Analyzer</h2>
            <small class="text-muted">v7.0 Stable (Fix: Chart Crash & Kernel Parsing)</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">æ¸…é™¤é‡ç½®</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">ğŸ“‚</div>
                <h4>é¸æ“‡ sosreport è³‡æ–™å¤¾</h4>
                <p class="text-muted">å·²ä¿®å¾©ç¶²é å´©æ½°å•é¡Œèˆ‡ Kernel æŠ“å–é‚è¼¯</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1 mb-0">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2 mb-0">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 mb-0 text-break">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2 mb-0">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top CPU Processes</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 small">
                                <thead class="table-light"><tr><th>PID</th><th>User</th><th>CPU%</th><th>CMD</th></tr></thead>
                                <tbody id="ps-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h6 class="fw-bold text-secondary">è§£ææ—¥èªŒ (Debug Log)</h6>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];

    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.innerHTML = `> ${msg}`;
        if (type === 'warn') d.className = 'log-warn';
        if (type === 'err') d.className = 'log-err';
        if (type === 'debug') d.className = 'log-debug';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        // UI Reset
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        
        // Chart Cleanup (é—œéµï¼šç¢ºä¿èˆŠçš„åœ–è¡¨å¯¦ä¾‹è¢«éŠ·æ¯€)
        if (window.memChartInstance) {
            window.memChartInstance.destroy();
            window.memChartInstance = null;
        }

        log(`è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆï¼Œå»ºç«‹ç´¢å¼•...`);
        
        fileMap.clear();
        filePaths = [];
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }

        try {
            await parseOS();
            await parseMemory();
            await parseProcess();
            await parseNetwork();
            log("ğŸ‰ è§£æå®Œæˆ", "info");
        } catch (e) {
            log(`âŒ éŒ¯èª¤: ${e.message}`, "err");
            console.error(e);
        }
    }

    async function findFile(keywords, checkContentFn = null) {
        const kwList = Array.isArray(keywords) ? keywords : [keywords];
        
        // 1. å„ªå…ˆæ‰¾ sos_commands ä¸‹çš„æŒ‡ä»¤è¼¸å‡º (é€šå¸¸æ ¼å¼æœ€ä¹¾æ·¨)
        let candidates = filePaths.filter(p => 
            kwList.some(kw => p.endsWith(`/${kw}`) || p.endsWith(kw)) 
            && p.includes('sos_commands')
        );

        // 2. å…¶æ¬¡æ‰¾ /proc æˆ–å…¶ä»–ä½ç½®
        if (candidates.length === 0) {
            candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`)));
        }

        // 3. å¯¬é¬†æœå°‹
        if (candidates.length === 0) {
            candidates = filePaths.filter(p => kwList.some(kw => p.includes(kw) && !p.endsWith('.xz')));
        }

        if (candidates.length === 0) {
            log(`âš ï¸ æ‰¾ä¸åˆ°é—œéµå­— [${kwList}]`, 'warn');
            return null;
        }

        for (const path of candidates) {
            const file = fileMap.get(path);
            const content = await readFileText(file);
            if (!content) continue;
            
            if (checkContentFn) {
                if (checkContentFn(content)) {
                    log(`âœ… è®€å–: ...${path.slice(-40)}`, 'debug');
                    return content;
                }
            } else {
                log(`âœ… è®€å–: ...${path.slice(-40)}`, 'debug');
                return content;
            }
        }
        return null;
    }

    function readFileText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Parsers ---

    async function parseOS() {
        const hostname = await findFile(['hostname']);
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        const release = await findFile(['redhat-release', 'os-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        // Kernel Fix: å„ªå…ˆæ‰¾ uname_-r (åƒ…ç‰ˆæœ¬è™Ÿ) æˆ– uname_-a
        // ä¸¦ä½¿ç”¨ Regex æŠ“å–ç‰ˆæœ¬è™Ÿæ ¼å¼ (æ•¸å­—.æ•¸å­—.æ•¸å­—...)ï¼Œé¿å… split ç©ºç™½å‡ºéŒ¯
        const uname = await findFile(['uname_-r', 'uname_-a', 'uname']);
        if (uname) {
            // Regex è§£é‡‹: æŠ“å– 3.10.0-xxx æˆ– 4.18.0-xxx æˆ– 5.14.0-xxx
            // æ’é™¤é–‹é ­çš„ Linux hostname ç­‰å­—ä¸²
            const kMatch = uname.match(/(\d+\.\d+\.\d+-\S+)/); 
            if (kMatch) {
                document.getElementById('os-kernel').textContent = kMatch[1];
            } else {
                // Fallback: å¦‚æœæ˜¯ç´”ç‰ˆæœ¬è™Ÿ (uname -r)
                if (uname.trim().length < 50) {
                    document.getElementById('os-kernel').textContent = uname.trim();
                } else {
                    // Fallback: uname -a logic
                    const parts = uname.split(/\s+/);
                    if (parts.length > 2) document.getElementById('os-kernel').textContent = parts[2];
                }
            }
        }

        const uptime = await findFile(['uptime', 'date'], (c) => c.includes('up') && c.includes(':'));
        if (uptime) {
            const m = uptime.match(/up\s+([^,]+)/);
            if (m) document.getElementById('os-uptime').textContent = m[1];
        }
    }

    async function parseMemory() {
        const data = await findFile('meminfo');
        if (!data) return;

        const val = (k) => { const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm')); return m ? parseInt(m[1]) : 0; };
        const total = val('MemTotal'), free = val('MemFree'), buff = val('Buffers'), cached = val('Cached'), slab = val('Slab');
        const used = total - free - buff - cached - slab;
        
        document.getElementById('mem-total-badge').textContent = (total/1024/1024).toFixed(1) + " GB";

        const ctx = document.getElementById('memChart').getContext('2d');
        
        // é€™è£¡å†æ¬¡ç¢ºä¿éŠ·æ¯€èˆŠå¯¦ä¾‹
        if (window.memChartInstance) window.memChartInstance.destroy();

        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buff/Cache', 'Free'],
                datasets: [{ 
                    data: [used, buff+cached+slab, free], 
                    backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                    borderWidth: 1 
                }]
            },
            options: { 
                responsive: true,
                maintainAspectRatio: false, // é—œéµï¼šå…è¨±åœ–è¡¨é©æ‡‰æˆ‘å€‘è¨­å®šçš„å›ºå®šé«˜åº¦å®¹å™¨
                plugins: { legend: { position: 'right' } } 
            }
        });
    }

    async function parseNetwork() {
        // ä½¿ç”¨æ›´å¯¬é¬†çš„æœå°‹ä¾†æŠ“å– ip address
        const data = await findFile(['ip_address', 'ip_-d_address', 'ip_addr'], (c) => c.includes('state') || c.includes('mtu'));
        const list = document.getElementById('net-list');
        list.innerHTML = '';
        
        if (!data) {
            list.innerHTML = '<div class="p-3 text-muted text-center">æŸ¥ç„¡ Network è³‡æ–™</div>';
            return;
        }

        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const name = match[1];
            const state = match[2];
            const isUp = state === 'UP';
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${name}</span>
                    <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${state}</span>
                </div>`;
        }
    }

    async function parseProcess() {
        const data = await findFile(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps'], (c) => c.includes('PID'));
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = ''; 

        if (!data) return;

        const lines = data.split('\n');
        let procs = [];
        let map = { user:0, pid:1, cpu:2, cmd:10 }; 
        
        for(let line of lines.slice(0,20)) {
            if(line.includes('PID') && line.includes('CPU')) {
                const parts = line.trim().split(/\s+/);
                map.user = parts.indexOf('USER');
                map.pid = parts.indexOf('PID');
                map.cpu = parts.findIndex(c => c.includes('CPU'));
                map.cmd = parts.indexOf('COMMAND');
                if(map.cmd === -1) map.cmd = parts.indexOf('CMD');
                if(map.cmd === -1) map.cmd = 10;
                break;
            }
        }

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.includes('PID')) continue;
            const p = line.split(/\s+/);
            if (p.length < 10) continue;
            procs.push({
                user: p[map.user],
                pid: p[map.pid],
                cpu: parseFloat(p[map.cpu]) || 0,
                cmd: p.slice(map.cmd).join(' ')
            });
        }

        procs.sort((a,b) => b.cpu - a.cpu).slice(0, 5).forEach(p => {
            const safeCmd = p.cmd.length > 40 ? p.cmd.substring(0, 40) + '...' : p.cmd;
            tbody.innerHTML += `
                <tr>
                    <td><small>${p.pid}</small></td>
                    <td>${p.user}</td>
                    <td class="fw-bold text-danger">${p.cpu}%</td>
                    <td title="${p.cmd}"><small class="text-muted">${safeCmd}</small></td>
                </tr>`;
        });
    }
</script>
</body>
</html>