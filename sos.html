<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v11 (Network Details)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #212529; --accent: #0d6efd; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Roboto, monospace; color: #333; }
        
        /* Âç°ÁâáÂÑ™Âåñ */
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 24px; }
        .card-header { background: #fff; border-bottom: 2px solid #f1f3f5; font-weight: 700; color: #495057; padding: 15px; }
        
        /* ‰∏äÂÇ≥ÂçÄÂ°ä */
        .upload-area { border: 2px dashed #adb5bd; border-radius: 12px; padding: 50px; text-align: center; background: #fff; cursor: pointer; transition: 0.2s; }
        .upload-area:hover { border-color: var(--accent); background-color: #f8fbff; }
        
        /* Log Viewer */
        .log-wrapper { background: var(--bg-dark); border-radius: 6px; height: 500px; display: flex; flex-direction: column; }
        .log-viewer { flex: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 0.85rem; color: #ced4da; white-space: pre-wrap; }
        .log-line { border-bottom: 1px solid #343a40; padding: 2px 0; }
        .log-err { color: #ff8787; font-weight: bold; background: rgba(255,0,0,0.1); }
        .log-warn { color: #ffd43b; font-weight: bold; }
        
        /* Network List */
        .net-item { cursor: pointer; transition: background-color 0.2s; }
        .net-item:hover { background-color: #f8f9fa; }
        .net-item:active { background-color: #e9ecef; }

        /* Modal */
        .modal-body code { color: #d63384; }
        .detail-row { border-bottom: 1px solid #eee; padding: 8px 0; }
        .detail-label { font-weight: bold; color: #555; width: 80px; display: inline-block; }

        /* Debug Console */
        .debug-console { background: #000; color: #20c997; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 6px; height: 150px; overflow-y: auto; margin-top: 20px; }
        .log-d-err { color: #fa5252; } .log-d-warn { color: #fab005; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-0">RHEL SOS Analyzer <span class="badge bg-secondary fs-6 align-middle">v11.0</span></h3>
            <small class="text-muted">Êñ∞Â¢ûÔºöÁ∂≤Ë∑Ø‰ªãÈù¢Ë©≥Á¥∞Ë≥áË®äÊ™¢Ë¶ñÂô®</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">ÈáçÁΩÆ</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">üìÇ</div>
                <h4>ÈÅ∏Êìá sosreport Ë≥áÊñôÂ§æ</h4>
                <p class="text-muted">Êú¨Ê©üËß£ÊûêÔºå‰∏çÈúÄ‰∏äÂÇ≥</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 text-break">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body">
                        <div style="height: 250px; position: relative;">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Top CPU Processes</span>
                        <span class="badge bg-info text-dark">Main Processes Only</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-proc mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="10%">PID</th>
                                        <th width="15%">User</th>
                                        <th width="10%">CPU%</th>
                                        <th width="10%">MEM%</th>
                                        <th width="10%">RSS (MB)</th>
                                        <th width="45%">Command</th>
                                    </tr>
                                </thead>
                                <tbody id="ps-tbody">
                                    <tr><td colspan="6" class="text-center text-muted py-4">Á≠âÂæÖË≥áÊñôËß£Êûê...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces <small class="text-muted fw-normal ms-2">(Click for details)</small></div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
                        <span>System Logs</span>
                        <div class="d-flex gap-2">
                            <select id="log-selector" class="form-select form-select-sm" style="width: 250px;" onchange="renderLog()">
                                <option value="" disabled selected>ÊéÉÊèè‰∏≠...</option>
                            </select>
                            <input type="text" id="log-search" class="form-control form-control-sm" placeholder="ÈóúÈçµÂ≠óÈÅéÊøæ..." style="width: 150px;" onkeyup="filterLog()">
                        </div>
                    </div>
                    <div class="card-body p-0 bg-dark">
                        <div class="log-wrapper">
                            <div id="log-viewer" class="log-viewer">
                                <div class="text-center text-muted mt-5 pt-5">Ë´ãÂæû‰∏äÊñπÈÅ∏ÂñÆÈÅ∏Êìá Log Ê™îÊ°à</div>
                            </div>
                            <div class="bg-secondary text-white px-3 py-1 small d-flex justify-content-between">
                                <span id="log-status">Ready</span>
                                <span>Displaying Last 2000 Lines</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <h6 class="fw-bold text-secondary" style="cursor:pointer" onclick="document.getElementById('console').classList.toggle('d-none')">Debug Console (Click to toggle)</h6>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<div class="modal fade" id="netDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modal-title">Interface Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];
    let logCache = {};
    let networkData = {}; // ÂÑ≤Â≠òË©≥Á¥∞Á∂≤Ë∑ØË≥áË®ä

    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.textContent = `> ${msg}`;
        if (type === 'err') d.className = 'log-d-err';
        if (type === 'warn') d.className = 'log-d-warn';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        logCache = {};
        networkData = {};

        log(`Indexing ${files.length} files...`);
        fileMap.clear(); filePaths = [];
        
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }

        try {
            await parseOS();
            await parseMemory();
            await parseProcess(); 
            await parseNetwork(); // ÈáçÈªûÂçáÁ¥ö
            await initLogSystem();
            log("üéâ Ëß£ÊûêÂÆåÁï¢", "info");
        } catch (e) {
            log(`‚ùå ÈåØË™§: ${e.message}`, "err");
            console.error(e);
        }
    }

    // --- Helpers ---
    async function findFile(keywords, checkFn = null, returnPath = false) {
        const kwList = Array.isArray(keywords) ? keywords : [keywords];
        let candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`) || p.endsWith(kw)) && p.includes('sos_commands'));
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`)));
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.includes(kw) && !p.endsWith('.xz')));

        for (const path of candidates) {
            const content = await readFileText(fileMap.get(path));
            if (!content) continue;
            if (checkFn && !checkFn(content)) continue;
            return returnPath ? { content, path } : content;
        }
        return null;
    }

    function findFilesByRegex(regex) {
        return filePaths.filter(p => regex.test(p) && !p.endsWith('.xz') && !p.endsWith('.gz'));
    }

    function readFileText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Parsers ---

    async function parseOS() {
        const hostname = await findFile('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        const release = await findFile(['redhat-release', 'os-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        const uname = await findFile(['uname_-a', 'uname']);
        if (uname) {
            const m = uname.match(/(\d+\.\d+\.\d+-\S+)/); 
            document.getElementById('os-kernel').textContent = m ? m[1] : (uname.split(/\s+/)[2] || uname);
        }

        const uptime = await findFile(['uptime', 'date'], c => c.includes('up'));
        if (uptime) {
            const m = uptime.match(/up\s+([^,]+)/);
            if (m) document.getElementById('os-uptime').textContent = m[1];
        }
    }

    async function parseMemory() {
        const data = await findFile('meminfo');
        if (!data) return;
        const val = (k) => { const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm')); return m ? parseInt(m[1]) : 0; };
        const total = val('MemTotal'), free = val('MemFree'), buff = val('Buffers'), cached = val('Cached'), slab = val('Slab');
        const used = total - free - buff - cached - slab;
        
        document.getElementById('mem-total-badge').textContent = (total/1024/1024).toFixed(1) + " GB";

        if (window.memChartInstance) window.memChartInstance.destroy();
        const ctx = document.getElementById('memChart').getContext('2d');
        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buff/Cache', 'Free'],
                datasets: [{ data: [used, buff+cached+slab, free], backgroundColor: ['#dc3545', '#ffc107', '#198754'], borderWidth: 1 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    async function parseProcess() {
        const data = await findFile(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps'], c => c.includes('PID'));
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = '';

        if (!data) { tbody.innerHTML = '<tr><td colspan="6" class="text-center">No PS Data</td></tr>'; return; }

        const lines = data.split('\n');
        let procs = [];
        let map = { user:0, pid:1, cpu:2, mem:3, rss:5, cmd:10 }; 
        
        for(let i=0; i<Math.min(lines.length, 50); i++) {
            const line = lines[i].trim();
            if(line.includes('PID') && line.includes('CPU')) {
                const parts = line.split(/\s+/);
                map.user = parts.indexOf('USER');
                map.pid = parts.indexOf('PID');
                map.cpu = parts.findIndex(c => c.includes('CPU'));
                map.mem = parts.findIndex(c => c.includes('MEM'));
                map.rss = parts.indexOf('RSS');
                map.cmd = parts.indexOf('COMMAND');
                if (map.cmd === -1) map.cmd = parts.indexOf('CMD');
                if (map.cmd === -1) map.cmd = 10; 
                break;
            }
        }

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.startsWith('USER') || line.includes('PID')) continue;
            const parts = line.split(/\s+/);
            if (parts.length < 8) continue;
            
            const pid = parts[map.pid];
            if (pid === '-') continue; // Filter threads

            const cpu = parseFloat(parts[map.cpu]);
            const mem = parseFloat(parts[map.mem]);
            const rss = parseInt(parts[map.rss]); 
            const cmd = parts.slice(map.cmd).join(' ');

            if (!isNaN(cpu)) procs.push({ user: parts[map.user], pid, cpu, mem, rss, cmd });
        }

        procs.sort((a,b) => b.cpu - a.cpu).slice(0, 8).forEach(p => {
            const row = document.createElement('tr');
            const rssMB = (p.rss / 1024).toFixed(1);
            row.innerHTML = `
                <td><span class="badge bg-light text-dark border">${p.pid}</span></td>
                <td>${p.user}</td>
                <td class="fw-bold text-danger">${p.cpu}%</td>
                <td>${p.mem}%</td>
                <td>${rssMB}</td>
                <td class="cmd-col" title="${p.cmd}">${p.cmd}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // --- Á∂≤Ë∑ØÂçáÁ¥öÔºöÂçÄÂ°äËß£ÊûêËàá‰∫íÂãï ---
    async function parseNetwork() {
        const data = await findFile(['ip_address', 'ip_addr', 'ip_-d_address'], c => c.includes('state'));
        const list = document.getElementById('net-list');
        list.innerHTML = '';
        
        if (!data) return;

        // Âà©Áî®Ê≠£Ë¶èË°®ÈÅîÂºèÂ∞áÊØèÂÄã‰ªãÈù¢ÂàáÂàÜÊàêÁç®Á´ãÂçÄÂ°ä
        // ^\d+: ÂåπÈÖçË°åÈ¶ñÁöÑ "1: lo: ..."
        const interfaces = data.split(/^\d+:\s+/m).filter(Boolean);
        
        interfaces.forEach((block, index) => {
            // Á¨¨‰∏ÄË°åÈÄöÂ∏∏ÂåÖÂê´ Name, Flags, MTU, State
            const lines = block.split('\n');
            const header = lines[0];
            
            const nameMatch = header.match(/^([^:]+):/);
            const name = nameMatch ? nameMatch[1].trim() : `iface-${index}`;
            
            // Ëß£Êûê State
            const stateMatch = header.match(/state\s+(\w+)/);
            const state = stateMatch ? stateMatch[1] : 'UNKNOWN';
            
            // Ëß£Êûê MTU
            const mtuMatch = header.match(/mtu\s+(\d+)/);
            const mtu = mtuMatch ? mtuMatch[1] : 'N/A';

            // Ëß£Êûê MAC
            const macMatch = block.match(/link\/ether\s+([0-9a-f:]{17})/);
            const mac = macMatch ? macMatch[1] : 'N/A';

            // Ëß£Êûê IPs (IPv4 & IPv6)
            const ipv4s = [...block.matchAll(/inet\s+([0-9./]+)/g)].map(m => m[1]);
            const ipv6s = [...block.matchAll(/inet6\s+([0-9a-f:/]+)/g)].map(m => m[1]);

            // Ëß£Êûê Flags (<BROADCAST,MULTICAST...>)
            const flagsMatch = header.match(/<([^>]+)>/);
            const flags = flagsMatch ? flagsMatch[1] : '';

            // ÂÑ≤Â≠òËá≥ÂÖ®ÂüüÁâ©‰ª∂‰ª•‰æø Modal ‰ΩøÁî®
            networkData[name] = { state, mtu, mac, ipv4s, ipv6s, flags };

            // Render List Item
            const isUp = state === 'UP';
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center net-item px-3 py-2';
            item.onclick = () => showNetDetail(name);
            item.innerHTML = `
                <div>
                    <span class="fw-bold">${name}</span>
                    <small class="text-muted d-block" style="font-size: 0.75rem">${mac}</small>
                </div>
                <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${state}</span>
            `;
            list.appendChild(item);
        });
    }

    function showNetDetail(name) {
        const data = networkData[name];
        if (!data) return;

        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        modalTitle.textContent = `${name} Details`;
        
        let ipHtml = '';
        if (data.ipv4s.length > 0) ipHtml += data.ipv4s.map(ip => `<div><code>${ip}</code> (IPv4)</div>`).join('');
        if (data.ipv6s.length > 0) ipHtml += data.ipv6s.map(ip => `<div><code>${ip}</code> (IPv6)</div>`).join('');
        if (ipHtml === '') ipHtml = '<span class="text-muted">No IP Address assigned</span>';

        modalBody.innerHTML = `
            <div class="detail-row"><span class="detail-label">State:</span> <span class="badge ${data.state==='UP'?'bg-success':'bg-secondary'}">${data.state}</span></div>
            <div class="detail-row"><span class="detail-label">MAC:</span> <code>${data.mac}</code></div>
            <div class="detail-row"><span class="detail-label">MTU:</span> ${data.mtu}</div>
            <div class="detail-row"><span class="detail-label">Flags:</span> <small class="text-muted">${data.flags}</small></div>
            <div class="mt-3">
                <span class="detail-label mb-2 d-block">IP Addresses:</span>
                <div class="ps-2 border-start border-3">${ipHtml}</div>
            </div>
        `;

        new bootstrap.Modal(document.getElementById('netDetailModal')).show();
    }

    // --- Log System ---
    async function initLogSystem() {
        const selector = document.getElementById('log-selector');
        selector.innerHTML = '<option value="" disabled selected>ÈÅ∏Êìá Log Ê™îÊ°à...</option>';

        const logPaths = findFilesByRegex(/.*\/(messages|dmesg|secure|cron|boot\.log|yum\.log|dnf\.log)([-\.]\d+)?$/);
        
        if (logPaths.length === 0) {
            log("Êú™ÊâæÂà∞Á≥ªÁµ±Êó•Ë™åÊ™î", "warn");
            return;
        }

        logPaths.sort(); 

        logPaths.forEach(path => {
            const fileName = path.split('/').pop();
            const opt = document.createElement('option');
            opt.value = path;
            opt.textContent = fileName;
            selector.appendChild(opt);
        });
    }

    async function renderLog() {
        const path = document.getElementById('log-selector').value;
        if (!path) return;

        document.getElementById('log-status').textContent = "ËÆÄÂèñ‰∏≠...";
        const viewer = document.getElementById('log-viewer');
        viewer.innerHTML = '';

        let content = logCache[path];
        if (!content) {
            const file = fileMap.get(path);
            content = await readFileText(file);
            logCache[path] = content;
        }

        const lines = content.split('\n');
        const tail = lines.slice(-2000); 
        
        let html = '';
        tail.forEach(line => {
            if (!line.trim()) return;
            let cls = 'log-line';
            if (line.match(/error|fail|panic|critical|denied/i)) cls += ' log-err';
            else if (line.match(/warn|alert/i)) cls += ' log-warn';
            
            const safeLine = line.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            html += `<div class="${cls}">${safeLine}</div>`;
        });

        viewer.innerHTML = html;
        viewer.scrollTop = viewer.scrollHeight;
        document.getElementById('log-status').textContent = `Loaded ${path.split('/').pop()} (${lines.length} lines)`;
    }

    function filterLog() {
        const keyword = document.getElementById('log-search').value.toLowerCase();
        const lines = document.querySelectorAll('.log-line');
        lines.forEach(div => {
            div.style.display = div.textContent.toLowerCase().includes(keyword) ? 'block' : 'none';
        });
    }

</script>
</body>
</html>