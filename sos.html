<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Report Analyzer (Frontend)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-bg: #f8f9fa; --card-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .upload-area { border: 2px dashed #ced4da; border-radius: 10px; padding: 40px; text-align: center; background: white; transition: 0.3s; cursor: pointer; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f1f8ff; }
        .card { border: none; shadow: var(--card-shadow); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid #eee; font-weight: 600; color: #495057; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .metric-label { font-size: 0.875rem; color: #6c757d; }
        #loading { display: none; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="fw-bold">SOS Report Analyzer</h2>
            <p class="text-muted">ç´”å‰ç«¯è§£æ RHEL ç³»çµ±æ—¥èªŒ</p>
        </div>
    </div>

    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="mb-3">ğŸ“‚</div>
                <h5>é»æ“Šé¸æ“‡ sosreport è§£å£“å¾Œçš„è³‡æ–™å¤¾</h5>
                <p class="text-muted small">æ”¯æ´ webkitdirectory (è«‹é¸æ“‡è§£å£“å¾Œçš„æ ¹ç›®éŒ„)</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="loading" class="text-center mb-4">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2">æ­£åœ¨åˆ†ææª”æ¡ˆçµæ§‹èˆ‡å…§å®¹...</div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="row mb-3">
            <div class="col-12">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 id="os-hostname" class="mb-1">Unknown Host</h4>
                            <span id="os-release" class="badge bg-primary">Linux</span>
                            <span id="os-kernel" class="badge bg-secondary">Kernel</span>
                        </div>
                        <div class="text-end">
                            <div class="metric-label">Uptime</div>
                            <div id="os-uptime" class="fw-bold">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">CPU Information</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="metric-label">Model</div>
                            <div id="cpu-model" class="fw-bold small">Detecting...</div>
                        </div>
                        <div class="row text-center">
                            <div class="col-6">
                                <div id="cpu-physical" class="metric-value">0</div>
                                <div class="metric-label">Physical</div>
                            </div>
                            <div class="col-6">
                                <div id="cpu-logical" class="metric-value">0</div>
                                <div class="metric-label">Logical</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Memory Usage</div>
                    <div class="card-body">
                        <canvas id="memChart"></canvas>
                        <div class="mt-3 text-center small">
                            Total: <span id="mem-total" class="fw-bold">0 GB</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="net-list" style="max-height: 250px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
             <div class="col-12">
                <div class="card">
                    <div class="card-header">Process & Load (Top Consumers)</div>
                    <div class="card-body">
                         <p class="text-muted small">æ¨¡æ“¬ xsos çš„ PSCHECK åŠŸèƒ½ (éœ€ç¢ºä¿ sosreport åŒ…å« ps aux è¼¸å‡º)</p>
                         <table class="table table-sm table-hover" id="ps-table">
                             <thead>
                                 <tr><th>User</th><th>PID</th><th>%CPU</th><th>%MEM</th><th>Command</th></tr>
                             </thead>
                             <tbody></tbody>
                         </table>
                    </div>
                </div>
             </div>
        </div>

    </div>
</div>

<script>
    // --- æ ¸å¿ƒé‚è¼¯å€ ---

    // æ¨¡æ“¬çš„æª”æ¡ˆç³»çµ±æ˜ å°„ { 'proc/meminfo': FileObject, ... }
    let fileMap = {};

    async function handleFiles(files) {
        if (files.length === 0) return;

        document.getElementById('loading').style.display = 'block';
        document.getElementById('dashboard').style.display = 'none';
        fileMap = {};

        // 1. å»ºç«‹æª”æ¡ˆç´¢å¼• (Virtual File System)
        // sosreport é€šå¸¸çµæ§‹ç‚º: sosreport-hostname-date/proc/meminfo
        // æˆ‘å€‘éœ€è¦å¿½ç•¥æœ€å¤–å±¤çš„è³‡æ–™å¤¾åç¨±ï¼Œå»ºç«‹ç›¸å°è·¯å¾‘ç´¢å¼•
        Array.from(files).forEach(file => {
            // ç§»é™¤ç¬¬ä¸€å±¤ç›®éŒ„åç¨±ï¼Œæ­£è¦åŒ–è·¯å¾‘
            const relativePath = file.webkitRelativePath.split('/').slice(1).join('/');
            fileMap[relativePath] = file;
        });

        console.log(`Indexed ${Object.keys(fileMap).length} files.`);

        try {
            // 2. åŸ·è¡Œå„å€‹è§£ææ¨¡çµ„ (éåŒæ­¥è®€å–)
            await Promise.all([
                parseOS(),
                parseCPU(),
                parseMemory(),
                parseNetwork(),
                parseProcess()
            ]);
            
            // 3. é¡¯ç¤ºå„€è¡¨æ¿
            document.getElementById('dashboard').style.display = 'block';
        } catch (e) {
            console.error(e);
            alert("è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦ä¸Šå‚³äº†æ­£ç¢ºçš„ sosreport è³‡æ–™å¤¾ã€‚");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // è¼”åŠ©ï¼šè®€å–æª”æ¡ˆå…§å®¹ç‚ºæ–‡å­—
    function readFile(path) {
        return new Promise((resolve, reject) => {
            // æ¨¡ç³Šæœå°‹ï¼šå› ç‚ºæœ‰äº› sosreport æœƒæ”¾åœ¨ sos_commands/ ä¸‹ï¼Œæœ‰äº›åœ¨ proc/ ä¸‹
            // é€™è£¡åšä¸€å€‹ç°¡å–®çš„å„ªå…ˆé †åºæœå°‹
            let targetFile = fileMap[path];
            
            // å¦‚æœç›´æ¥è·¯å¾‘æ‰¾ä¸åˆ°ï¼Œå˜—è©¦æœå°‹ç‰¹å®šé—œéµå­— (æ¨¡æ“¬ xsos çš„æœå°‹é‚è¼¯)
            if (!targetFile) {
                const keys = Object.keys(fileMap);
                const foundKey = keys.find(k => k.endsWith(path));
                if (foundKey) targetFile = fileMap[foundKey];
            }

            if (!targetFile) {
                console.warn(`File not found: ${path}`);
                resolve(null); // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“å…¶ä»–éƒ¨åˆ†ç¹¼çºŒåŸ·è¡Œ
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(targetFile);
        });
    }

    // --- è§£ææ¨¡çµ„ (æ¨¡æ“¬ xsos é‚è¼¯) ---

    // 1. OS Info
    async function parseOS() {
        const hostnameData = await readFile('hostname');
        const releaseData = await readFile('etc/redhat-release') || await readFile('etc/os-release');
        const uptimeData = await readFile('uptime');
        const unameData = await readFile('uname');

        if (hostnameData) document.getElementById('os-hostname').textContent = hostnameData.trim();
        
        if (releaseData) {
            // ç°¡å–®è™•ç†ï¼Œå¦‚æœæ˜¯ os-release æ‰¾ PRETTY_NAME
            let release = releaseData.trim();
            const prettyMatch = releaseData.match(/PRETTY_NAME="([^"]+)"/);
            if (prettyMatch) release = prettyMatch[1];
            document.getElementById('os-release').textContent = release;
        }

        if (unameData) {
             // é€šå¸¸ uname è¼¸å‡º: Linux hostname 3.10.0... x86_64
             const parts = unameData.split(' ');
             if (parts.length >= 3) document.getElementById('os-kernel').textContent = parts[2];
        }

        if (uptimeData) {
            // ç°¡å–®æå– up æ™‚é–“
            const match = uptimeData.match(/up\s+([^,]+),/);
            if (match) document.getElementById('os-uptime').textContent = match[1];
        }
    }

    // 2. CPU Info (/proc/cpuinfo)
    async function parseCPU() {
        const data = await readFile('proc/cpuinfo');
        if (!data) return;

        // Model name
        const modelMatch = data.match(/model name\s+:\s+(.+)/);
        if (modelMatch) document.getElementById('cpu-model').textContent = modelMatch[1];

        // Logical Count
        const logical = (data.match(/processor\s+:/g) || []).length;
        document.getElementById('cpu-logical').textContent = logical;

        // Physical Count (physical id)
        const physicalIds = new Set();
        const lines = data.split('\n');
        lines.forEach(line => {
            const match = line.match(/physical id\s+:\s+(\d+)/);
            if (match) physicalIds.add(match[1]);
        });
        // è‹¥æ‰¾ä¸åˆ° physical id (å¦‚ VM)ï¼Œé€šå¸¸è¦–ç‚º 1 æˆ–èˆ‡ logical ç›¸åŒï¼Œé€™è£¡é¡¯ç¤º set size
        document.getElementById('cpu-physical').textContent = physicalIds.size || 1;
    }

    // 3. Memory Info (/proc/meminfo)
    async function parseMemory() {
        const data = await readFile('proc/meminfo');
        if (!data) return;

        const parseVal = (key) => {
            const regex = new RegExp(`^${key}:\\s+(\\d+)`, 'm');
            const match = data.match(regex);
            return match ? parseInt(match[1], 10) : 0; // unit usually kB
        };

        const total = parseVal('MemTotal');
        const free = parseVal('MemFree');
        const buffers = parseVal('Buffers');
        const cached = parseVal('Cached');
        const slab = parseVal('Slab');
        
        // xsos logic: Used = Total - Free
        // xsos logic: UsedNoBC = Used - Buffers - Cached ( - Slab usually considered used but actionable)
        // ç‚ºäº†åœ–è¡¨ç°¡å–®ï¼Œæˆ‘å€‘è¨ˆç®—ï¼šUsed (App), Buffers/Cache, Free
        
        const used = total - free - buffers - cached - slab;
        const buffCache = buffers + cached + slab;

        document.getElementById('mem-total').textContent = (total / 1024 / 1024).toFixed(2) + ' GB';

        // Render Chart
        const ctx = document.getElementById('memChart').getContext('2d');
        if (window.myMemChart) window.myMemChart.destroy(); // Redraw safety

        window.myMemChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['App Used', 'Buff/Cache', 'Free'],
                datasets: [{
                    data: [used, buffCache, free],
                    backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // 4. Network Interfaces (ip addr)
    async function parseNetwork() {
        // å˜—è©¦è®€å– ip address è¼¸å‡º
        const data = await readFile('sos_commands/networking/ip_address') || await readFile('ip_addr');
        const container = document.getElementById('net-list');
        container.innerHTML = '';

        if (!data) {
            container.innerHTML = '<div class="list-group-item">No network data found</div>';
            return;
        }

        // ç°¡å–®è§£æï¼šå°‹æ‰¾æ•¸å­—é–‹é ­çš„ä»‹é¢å€å¡Š
        // 1: lo: <LOOPBACK...>
        const lines = data.split('\n');
        lines.forEach(line => {
            // Regex: 1: eth0: <BROADCAST...>
            const match = line.match(/^\d+:\s+([^:]+):.*state\s+(\w+)/);
            if (match) {
                const iface = match[1];
                const state = match[2]; // UP or DOWN
                
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const badgeClass = (state === 'UP') ? 'bg-success' : 'bg-danger';
                
                item.innerHTML = `
                    <span>${iface}</span>
                    <span class="badge ${badgeClass}">${state}</span>
                `;
                container.appendChild(item);
            }
        });
    }

    // 5. Process Check (ps aux)
    async function parseProcess() {
        // å°‹æ‰¾ ps aux è¼¸å‡º
        let data = await readFile('ps'); // å¸¸è¦‹æ–¼ sosreport æ ¹ç›®éŒ„
        if (!data) data = await readFile('sos_commands/process/ps_aux'); // æˆ–åœ¨å­ç›®éŒ„

        const tbody = document.querySelector('#ps-table tbody');
        tbody.innerHTML = '';

        if (!data) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ps output not found</td></tr>';
            return;
        }

        const lines = data.split('\n');
        // ç§»é™¤ header
        const processes = [];
        
        // è§£ææ¯ä¸€è¡Œ
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            // ps aux columns: USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND
            // ä½¿ç”¨ç©ºç™½åˆ†å‰²ï¼Œä½†åœ¨ COMMAND éƒ¨åˆ†è¦åˆä½µ
            const parts = line.split(/\s+/);
            if (parts.length < 11) continue;

            processes.push({
                user: parts[0],
                pid: parts[1],
                cpu: parseFloat(parts[2]),
                mem: parseFloat(parts[3]),
                cmd: parts.slice(10).join(' ') // åˆä½µ command åŠå…¶åƒæ•¸
            });
        }

        // æ’åºï¼šä¾æ“š CPU ä½¿ç”¨ç‡ (Desc)
        processes.sort((a, b) => b.cpu - a.cpu);

        // å–å‰ 5 å
        processes.slice(0, 5).forEach(p => {
            const row = `<tr>
                <td>${p.user}</td>
                <td>${p.pid}</td>
                <td class="text-danger fw-bold">${p.cpu}%</td>
                <td>${p.mem}%</td>
                <td class="text-truncate" style="max-width: 200px;" title="${p.cmd}">${p.cmd}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

</script>
</body>
</html>