<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v6 (Deep Scan)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --bg-dark: #1e1e2f; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: #0d6efd; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; }
        .console-box { background: #2d2d3b; color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .upload-box { border: 2px dashed #ccc; padding: 40px; border-radius: 12px; background: #fff; text-align: center; cursor: pointer; width: 500px; }
        .upload-box:hover { border-color: #0d6efd; background: #f8fbff; }

        /* Logs */
        .log-container { display: flex; height: calc(100vh - 120px); gap: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; overflow: hidden; }
        .log-tree { width: 30%; background: #f8f9fa; border-right: 1px solid #ddd; overflow-y: auto; font-size: 0.9rem; }
        .log-viewer { width: 70%; background: #1e1e1e; color: #ccc; font-family: monospace; padding: 15px; overflow-y: auto; white-space: pre; font-size: 0.85rem; }
        .log-group { padding: 8px 15px; font-weight: bold; background: #e9ecef; border-bottom: 1px solid #dee2e6; font-size: 0.8rem; text-transform: uppercase; color: #555; }
        .log-item { padding: 6px 20px; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
        .log-item:hover { background: #e2e6ea; color: #0d6efd; }
        .log-item.active { background: #0d6efd; color: #fff; }

        .hidden { display: none !important; }
        .badge-path { font-size: 0.65rem; opacity: 0.7; font-weight: normal; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-3 fw-bold border-bottom border-secondary">RHEL SOS Analyzer v6</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ“Š ç¸½è¦½ (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">ğŸ–¥ï¸ ç³»çµ±æ·±åº¦è©•ä¼°</a>
            <a class="nav-link" onclick="switchTab('logs')">ğŸ“ æ—¥èªŒç€è¦½å™¨</a>
            <a class="nav-link" onclick="switchTab('network')">ğŸŒ ç¶²è·¯ç‹€æ…‹</a>
            <a class="nav-link" onclick="switchTab('debug')">ğŸ é™¤éŒ¯è³‡è¨Š (Files)</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="loader" class="alert alert-info hidden">æ­£åœ¨è§£ææª”æ¡ˆ... <span id="load-count"></span></div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="fs-1 mb-2">ğŸ“‚</div>
                <h4>ä¸Šå‚³ SOS Report è³‡æ–™å¤¾</h4>
                <p class="text-muted small">è«‹ä¸Šå‚³è§£å£“ç¸®å¾Œçš„ç›®éŒ„<br>(è‡ªå‹•éæ¿¾ç„¡æ•ˆæ·å¾‘)</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ¦‚è§€</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold text-primary" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-7">
                    <div class="card">
                        <div class="card-header">Top Memory Processes</div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>COMMAND</th></tr></thead>
                                <tbody id="mem-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card h-100">
                        <div class="card-header">Last Boot Messages (dmesg)</div>
                        <div class="card-body bg-dark text-light p-2" style="font-family:monospace; font-size:0.75rem; overflow:hidden;">
                            <div id="dash-dmesg-preview">Waiting for data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">ç¡¬é«”èˆ‡ç³»çµ±æ·±åº¦è³‡è¨Š</h4>
            <div class="card">
                <div class="card-header">Hardware & BIOS (dmidecode)</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between"><span>Product:</span> <strong id="info-model">-</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>Vendor:</span> <strong id="info-vendor">-</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>BIOS Ver:</span> <strong id="info-bios">-</strong></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                             <h6>PCI Storage/Network</h6>
                             <div class="console-box" id="info-pci" style="height:120px">Pending...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Kernel & Security</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>SELinux:</strong> <span id="info-selinux">-</span><br>
                            <strong>Tainted:</strong> <span id="info-tainted">-</span>
                        </div>
                        <div class="col-md-8">
                            <div id="sysctl-box" class="small text-muted border p-2 bg-light">Scanning...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Middleware Processes</div>
                <div class="card-body">
                    <div class="console-box" id="info-middleware">Scanning...</div>
                </div>
            </div>
        </div>

        <div id="view-logs" class="content-view hidden">
            <h4 class="mb-3">æ—¥èªŒç€è¦½å™¨ (Log Explorer)</h4>
            <div class="log-container">
                <div class="log-tree" id="log-tree"></div>
                <div class="log-viewer" id="log-viewer">Select a file...</div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
             <h4 class="mb-3">ç¶²è·¯åˆ†æ</h4>
             <div class="card">
                <div class="card-header">Listening Ports (ss -tulpn)</div>
                <div class="card-body"><div class="console-box" id="net-ss">Pending...</div></div>
            </div>
            <div class="card">
                <div class="card-header">IP Address (ip addr)</div>
                <div class="card-body"><div class="console-box" id="net-ip">Pending...</div></div>
            </div>
        </div>

        <div id="view-debug" class="content-view hidden">
            <h4>Loaded Files Index</h4>
            <p>å¦‚æœè³‡æ–™é¡¯ç¤ºä¸å‡ºä¾†ï¼Œè«‹æª¢æŸ¥é€™è£¡æ˜¯å¦æœ‰æ‰¾åˆ°å°æ‡‰çš„æª”æ¡ˆ (å¿½ç•¥ 0 bytes çš„æ·å¾‘)ã€‚</p>
            <div class="console-box" id="debug-list" style="max-height:80vh"></div>
        </div>

    </div>

    <script>
        const App = {
            files: new Map(),
            paths: [],
            cache: {},
            
            // é—œéµï¼šå®šç¾©å„ªå…ˆæœå°‹é †åºã€‚å„ªå…ˆæ‰¾æ·±å±¤ç›®éŒ„ (Content)ï¼Œæœ€å¾Œæ‰æ‰¾æ ¹ç›®éŒ„ (Symlink)
            searchRules: {
                hostname: ['sos_commands/host/hostname', 'hostname'],
                release: ['etc/redhat-release', 'sos_commands/general/redhat-release', 'redhat-release'],
                uptime: ['sos_commands/host/uptime', 'uptime'],
                dmidecode: ['sos_commands/hardware/dmidecode', 'dmidecode'],
                lspci: ['sos_commands/pci/lspci_-nnvv', 'lspci'],
                sysctl: ['sos_commands/kernel/sysctl_-a', 'proc/sys/kernel/tainted'],
                ps: ['sos_commands/process/ps_auxww', 'sos_commands/process/ps_aux', 'ps'],
                ip: ['sos_commands/networking/ip_-o_addr', 'sos_commands/networking/ip_addr'],
                ss: ['sos_commands/networking/ss_-tulpn', 'sos_commands/net/ss_-tulpn', 'ss_-tulpn'], // å¢åŠ  net ç›®éŒ„
                dmesg: ['sos_commands/kernel/dmesg', 'var/log/dmesg'],
                sestatus: ['sos_commands/selinux/sestatus']
            }
        };

        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('load-count').textContent = `æ­£åœ¨ç´¢å¼• ${fileList.length} å€‹æª”æ¡ˆ...`;
            
            // 1. Reset
            App.files.clear();
            App.paths = [];
            App.cache = {};

            // 2. Indexing
            let debugHtml = "";
            for (let f of fileList) {
                // æ­£è¦åŒ–è·¯å¾‘ï¼šç§»é™¤æœ€ä¸Šå±¤è³‡æ–™å¤¾åç¨±ï¼Œçµ±ä¸€è®Šæˆ relative path
                // ä¾‹å¦‚: "sosreport-xxx/sos_commands/host/hostname" -> "sos_commands/host/hostname"
                const parts = f.webkitRelativePath.split('/');
                const relPath = parts.slice(1).join('/'); 
                
                // å¿½ç•¥ç©ºæª”æ¡ˆ (é€šå¸¸æ˜¯ç„¡æ•ˆçš„ Symlink)
                if (f.size > 0) {
                    App.files.set(relPath, f);
                    App.paths.push(relPath);
                    debugHtml += `[${f.size} B] ${relPath}\n`;
                } else {
                    debugHtml += `[SKIP 0 B] ${relPath}\n`;
                }
            }
            document.getElementById('debug-list').textContent = debugHtml;

            // 3. Execution
            try {
                await Promise.all([
                    safeRun(renderDashboard),
                    safeRun(renderHostInfo),
                    safeRun(renderNetwork),
                    safeRun(buildLogTree)
                ]);
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("è§£æéç¨‹ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ Console");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // éŒ¯èª¤éš”é›¢åŸ·è¡Œå™¨
        async function safeRun(fn) {
            try { await fn(); } catch (e) { console.error("Module failed:", e); }
        }

        // æ ¸å¿ƒæœå°‹å¼•æ“
        async function fetchContent(key) {
            const candidates = App.searchRules[key] || [key];
            
            for (let pattern of candidates) {
                // 1. ç²¾ç¢ºåŒ¹é…
                if (App.files.has(pattern)) {
                    return await readFile(App.files.get(pattern));
                }
                
                // 2. çµå°¾åŒ¹é… (è™•ç†è·¯å¾‘è®Šç•°)
                // æ‰¾å‡ºæ‰€æœ‰ä»¥ pattern çµå°¾çš„è·¯å¾‘ï¼Œä¸¦å–æœ€çŸ­çš„é‚£å€‹ (é€šå¸¸æœ€æ¥è¿‘æ ¹ç›®éŒ„æˆ–æ¨™æº–è·¯å¾‘)
                const matches = App.paths.filter(p => p.endsWith(pattern));
                if (matches.length > 0) {
                    // é€™è£¡å¯ä»¥åŠ å¼·ï¼šå¦‚æœæœ‰ sos_commands çš„è·¯å¾‘å„ªå…ˆä½¿ç”¨
                    const bestMatch = matches.find(p => p.includes('sos_commands')) || matches[0];
                    return await readFile(App.files.get(bestMatch));
                }
            }
            return null;
        }

        async function readFile(file) {
            if (App.cache[file.name]) return App.cache[file.name];
            const text = await file.text();
            App.cache[file.name] = text;
            return text;
        }

        // --- Renderers ---

        async function renderDashboard() {
            // Hostname
            const h = await fetchContent('hostname');
            setText('dash-hostname', h ? h.trim() : 'Unknown');

            // Release
            const r = await fetchContent('release');
            setText('dash-release', r ? r.trim() : 'Unknown');

            // Uptime
            const u = await fetchContent('uptime');
            setText('dash-uptime', u ? u.trim() : '-');

            // Kernel
            const dmesg = await fetchContent('dmesg');
            if (dmesg) {
                const lines = dmesg.split('\n');
                // å˜—è©¦å¾ dmesg æ‰¾ Kernel version
                const kLine = lines.find(l => l.includes('Linux version'));
                setText('dash-kernel', kLine ? kLine.split('version')[1].trim().split(' ')[0] : '-');
                
                // Preview
                document.getElementById('dash-dmesg-preview').textContent = lines.slice(-20).join('\n');
            } else {
                document.getElementById('dash-dmesg-preview').textContent = "dmesg log not found (checked sos_commands/kernel/dmesg)";
            }
        }

        async function renderHostInfo() {
            // DMI
            const dmi = await fetchContent('dmidecode');
            if (dmi) {
                setText('info-model', (dmi.match(/Product Name:\s*(.+)/) || [])[1] || '-');
                setText('info-vendor', (dmi.match(/Manufacturer:\s*(.+)/) || [])[1] || '-');
                setText('info-bios', (dmi.match(/Version:\s*(.+)/) || [])[1] || '-');
            }

            // Sysctl / Tainted
            const sysctl = await fetchContent('sysctl');
            if (sysctl) {
                const t = sysctl.match(/kernel.tainted\s*=\s*(\d+)/);
                setText('info-tainted', t ? (t[1] == '0' ? '0 (Not Tainted)' : t[1] + ' (Tainted)') : '-');
                
                // Show key params
                const keys = ['vm.swappiness', 'net.ipv4.ip_forward', 'fs.file-max'];
                let html = '';
                keys.forEach(k => {
                    const m = sysctl.match(new RegExp(k.replace(/\./g, '\\.') + "\\s*=\\s*(.+)"));
                    if(m) html += `<span class="me-3">${k}=${m[1]}</span>`;
                });
                document.getElementById('sysctl-box').innerHTML = html;
            }

            // SELinux
            const se = await fetchContent('sestatus');
            if (se) setText('info-selinux', (se.match(/Current mode:\s*(.+)/) || [])[1] || 'Unknown');

            // Middleware (PS)
            const ps = await fetchContent('ps');
            if (ps) {
                const lines = ps.split('\n');
                // Dashboard Table
                const procs = lines.slice(1).map(l => {
                    const parts = l.trim().split(/\s+/);
                    if (parts.length < 5) return null;
                    return { pid: parts[1], user: parts[0], mem: parseFloat(parts[3]), cmd: parts.slice(10).join(' ') };
                }).filter(x => x && !isNaN(x.mem)).sort((a,b) => b.mem - a.mem).slice(0,5);

                const tbody = document.getElementById('mem-table-body');
                tbody.innerHTML = procs.map(p => `<tr><td>${p.pid}</td><td>${p.user}</td><td>${p.mem}%</td><td class="text-truncate" style="max-width:150px">${p.cmd}</td></tr>`).join('');
                
                // Middleware Text
                const mw = lines.filter(l => l.match(/java|httpd|nginx|mysql|postgres|docker|kube/i) && !l.includes(' grep '));
                setText('info-middleware', mw.length ? mw.slice(0,20).join('\n') : "No common middleware found.");
            }

            // PCI
            const pci = await fetchContent('lspci');
            if(pci) {
                 const interesting = pci.split('\n').filter(l => l.match(/RAID|Ethernet|Fibre|VGA/)).join('\n');
                 setText('info-pci', interesting);
            }
        }

        async function renderNetwork() {
            const ip = await fetchContent('ip');
            setText('net-ip', ip || 'Not found');
            const ss = await fetchContent('ss');
            setText('net-ss', ss || 'Not found');
        }

        // --- Log Tree ---
        function buildLogTree() {
            const tree = document.getElementById('log-tree');
            tree.innerHTML = '';
            
            // Filters
            const groups = {
                "System": [/\/var\/log\/messages/, /dmesg/, /\/var\/log\/boot/],
                "Security": [/\/var\/log\/secure/, /\/var\/log\/audit\/audit/],
                "Package": [/\/var\/log\/dnf/, /\/var\/log\/yum/],
                "Cron": [/\/var\/log\/cron/],
                "Other": [/\/var\/log\//]
            };

            const found = { "System": [], "Security": [], "Package": [], "Cron": [], "Other": [] };

            App.paths.forEach(p => {
                // Basic filter for log-like files
                if (!p.includes('var/log') && !p.includes('sos_commands/logs') && !p.includes('dmesg')) return;
                if (p.endsWith('.gz') || p.endsWith('lastlog') || p.endsWith('wtmp')) return;

                let added = false;
                for (let g in groups) {
                    if (g === 'Other') continue;
                    if (groups[g].some(rx => rx.test(p))) {
                        found[g].push(p);
                        added = true;
                        break;
                    }
                }
                if (!added && p.includes('var/log')) found['Other'].push(p);
            });

            for (let g in found) {
                if (!found[g].length) continue;
                const title = document.createElement('div');
                title.className = 'log-group';
                title.textContent = g;
                tree.appendChild(title);
                
                found[g].sort().forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'log-item';
                    item.innerHTML = `${p.split('/').pop()} <span class="badge-path">${p}</span>`; // Show filename + small path
                    item.onclick = () => showLog(p, item);
                    tree.appendChild(item);
                });
            }
        }

        async function showLog(path, el) {
            document.querySelectorAll('.log-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            
            const v = document.getElementById('log-viewer');
            v.textContent = "Loading...";
            
            const file = App.files.get(path);
            let text = await readFile(file);
            
            if (text.length > 500000) {
                 text = "File too large, showing last 50KB...\n" + text.slice(-50000);
            }
            v.textContent = text;
            v.scrollTop = v.scrollHeight;
        }

        // --- Utils ---
        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            const nav = Array.from(document.querySelectorAll('.nav-link')).find(e => e.getAttribute('onclick').includes(id));
            if(nav) nav.classList.add('active');
        }

        function setText(id, txt) {
            const el = document.getElementById(id);
            if (el) el.textContent = txt;
        }
    </script>
</body>
</html>