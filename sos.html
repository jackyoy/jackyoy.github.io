<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Report Analyzer - Enterprise Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg-dark: #1e1e2f; 
            --sidebar-width: 280px;
            --accent-color: #0d6efd;
            --code-bg: #2d2d3b;
        }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 700; font-size: 1.2rem; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; border-left: 4px solid transparent; cursor: pointer; }
        .nav-link:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: var(--accent-color); }
        .nav-icon { margin-right: 10px; width: 20px; text-align: center; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        /* Components */
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 24px; background: #fff; }
        .card-header { background: #fff; border-bottom: 1px solid #eee; padding: 15px 20px; font-weight: 600; color: #333; display: flex; justify-content: space-between; align-items: center; }
        
        /* Upload Area */
        .upload-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .upload-box { border: 2px dashed #ccc; padding: 60px; border-radius: 16px; background: #fff; transition: 0.3s; cursor: pointer; max-width: 600px; width: 100%; }
        .upload-box:hover { border-color: var(--accent-color); background: #f8fbff; transform: translateY(-2px); }
        
        /* Data Tables */
        .table-custom th { background-color: #f8f9fa; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #6c757d; }
        .table-custom td { font-size: 0.9rem; vertical-align: middle; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .bg-pass { background-color: #d1e7dd; color: #0f5132; }
        .bg-fail { background-color: #f8d7da; color: #842029; }
        .bg-warn { background-color: #fff3cd; color: #664d03; }
        
        /* Console/Log View */
        .console-box { background: var(--code-bg); color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem; }
        
        /* Loaders */
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: 0.3s; }
        .loading-overlay.active { visibility: visible; opacity: 1; }

        /* Utility */
        .text-mono { font-family: 'Consolas', monospace; color: #d63384; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            RHEL SOS Analyzer
        </div>
        <nav class="nav flex-column mt-3">
            <a class="nav-link active" onclick="switchTab('dashboard')">
                <span class="nav-icon">üìä</span> Á∏ΩË¶Ω (Dashboard)
            </a>
            <a class="nav-link" onclick="switchTab('host-info')">
                <span class="nav-icon">üñ•Ô∏è</span> Á≥ªÁµ±Ë©ï‰º∞ (Host Info)
            </a>
            <a class="nav-link" onclick="switchTab('logs')">
                <span class="nav-icon">üìù</span> Êó•Ë™åÂàÜÊûê (Logs)
            </a>
            <a class="nav-link" onclick="switchTab('network')">
                <span class="nav-icon">üåê</span> Á∂≤Ë∑ØÁãÄÊÖã (Network)
            </a>
        </nav>
        <div class="mt-auto p-3 text-center text-secondary" style="font-size: 0.8rem;">
            v4.1 Full Analyzer<br>Client-side Processing
        </div>
    </div>

    <div class="main-content">
        
        <div id="loader" class="loading-overlay">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-3 fw-bold text-secondary">Ê≠£Âú®Ëß£Êûê SOS Report Ë≥áÊñôÁµêÊßã...</div>
                <div id="parse-status" class="small text-muted mt-1"></div>
            </div>
        </div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="mb-3">üìÇ</div>
                <h4>‰∏äÂÇ≥ SOS Report ÁõÆÈåÑ</h4>
                <p class="text-muted">Ë´ãÈÅ∏ÊìáËß£Â£ìÁ∏ÆÂæåÁöÑ sosreport Ë≥áÊñôÂ§æ<br>(ÊîØÊè¥ webkitdirectory)</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-4">Á≥ªÁµ±Á∏ΩË¶Ω</h4>
            <div class="row">
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="text-secondary small">Hostname</div>
                        <div class="fw-bold fs-5 text-primary" id="dash-hostname">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="text-secondary small">Release</div>
                        <div class="fw-bold fs-5" id="dash-release">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="text-secondary small">Kernel</div>
                        <div class="fw-bold fs-6 text-mono" id="dash-kernel">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="text-secondary small">Uptime</div>
                        <div class="fw-bold fs-5" id="dash-uptime">-</div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Top Memory Processes</div>
                        <div class="card-body p-0">
                            <table class="table table-custom table-hover mb-0" id="dash-mem-table">
                                <thead><tr><th>USER</th><th>PID</th><th>%MEM</th><th>COMMAND</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Critical Issues (Last 30 Days)</div>
                        <div class="card-body">
                            <canvas id="issuesChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-4">Ê∑±Â∫¶Á≥ªÁµ±Ë©ï‰º∞ (Host Info Full)</h4>
            
            <div class="card">
                <div class="card-header">
                    <span>1. Á°¨È´îËàáÈüåÈ´î (Hardware Layer)</span>
                    <span class="badge bg-secondary">dmidecode / lspci</span>
                </div>
                <div class="card-body">
                    <div class="row detail-row mb-3">
                        <div class="col-3 text-secondary">Product Name</div>
                        <div class="col-9 fw-bold" id="info-product">-</div>
                    </div>
                    <div class="row detail-row mb-3">
                        <div class="col-3 text-secondary">BIOS Version</div>
                        <div class="col-9" id="info-bios">-</div>
                    </div>
                    <div class="row detail-row mb-3">
                        <div class="col-3 text-secondary">Vendor</div>
                        <div class="col-9" id="info-vendor">-</div>
                    </div>
                    <hr>
                    <h6>PCI Devices Summary</h6>
                    <div class="console-box" id="info-pci">Waiting for data...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>2. ‰ΩúÊ•≠Á≥ªÁµ±Ê†∏ÂøÉ (OS & Kernel)</span>
                    <span class="badge bg-secondary">sysctl / tainted</span>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th class="bg-light w-25">Kernel Tainted</th>
                                <td id="info-tainted">-</td>
                            </tr>
                            <tr>
                                <th class="bg-light">SELinux Status</th>
                                <td id="info-selinux">-</td>
                            </tr>
                            <tr>
                                <th class="bg-light">Default Target</th>
                                <td id="info-target">-</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h6 class="mt-4">Important Sysctl Parameters</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped small" id="table-sysctl">
                            <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>3. ‰∏≠‰ªãËªüÈ´îËàáÊáâÁî® (Middleware & Processes)</span>
                    <span class="badge bg-secondary">ps / systemd</span>
                </div>
                <div class="card-body">
                    <h6>Detected Middleware Processes (Java/Web/DB)</h6>
                    <div class="console-box mb-3" id="info-middleware">Searching...</div>
                    
                    <h6>Active Systemd Units (Failed/Active)</h6>
                    <div class="console-box" id="info-systemd">Analyzing...</div>
                </div>
            </div>
        </div>

        <div id="view-logs" class="content-view hidden">
            <div class="card h-100">
                <div class="card-header">
                    <div>
                        Á≥ªÁµ±Êó•Ë™å (dmesg / messages)
                        <select class="form-select d-inline-block w-auto ms-2 form-select-sm" id="log-selector">
                            <option value="dmesg">dmesg</option>
                            <option value="messages">var/log/messages (or journal)</option>
                        </select>
                    </div>
                    <input type="text" class="form-control form-control-sm w-25" placeholder="ÈÅéÊøæÈóúÈçµÂ≠ó..." id="log-search" onkeyup="filterLog()">
                </div>
                <div class="console-box" style="flex:1; max-height:none; background:#1e1e1e;" id="log-viewer">
                    Ë´ãÂÖà‰∏äÂÇ≥Ê™îÊ°à...
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
            <div class="card">
                <div class="card-header">Á∂≤Ë∑Ø‰ªãÈù¢ËàáË∑ØÁî±</div>
                <div class="card-body">
                    <pre id="net-ip" class="console-box">Pending...</pre>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Listening Ports (ss -tulpn)</div>
                <div class="card-body">
                    <pre id="net-ports" class="console-box">Pending...</pre>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Ê†∏ÂøÉË≥áÊñôÁµêÊßã ---
        const AppState = {
            files: new Map(), // Â≠òÂÑ≤ path -> File object
            sosRoot: '',      // SOS report ÁöÑÊ†πÁõÆÈåÑÂêçÁ®±
            cache: {},        // Á∑©Â≠òËß£ÊûêÁµêÊûú
            textCache: {}     // Á∑©Â≠òËÆÄÂèñÁöÑÊñáÂ≠óÂÖßÂÆπ
        };

        // --- Ê™îÊ°àËôïÁêÜÈÇèËºØ ---
        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;

            toggleLoader(true);
            AppState.files.clear();
            AppState.textCache = {};
            
            // Âª∫Á´ãÊ™îÊ°àÁ¥¢Âºï‰∏¶Â∞ãÊâæ Root
            let shortestPath = null;
            
            Array.from(fileList).forEach(file => {
                const path = file.webkitRelativePath;
                AppState.files.set(path, file);
                
                // Á∞°ÂñÆÂà§Êñ∑Ê†πÁõÆÈåÑ: ÂèñÁ¨¨‰∏ÄÂÄãÊñúÁ∑öÂâçÁöÑÂ≠ó‰∏≤
                const rootPart = path.split('/')[0];
                if (!AppState.sosRoot) AppState.sosRoot = rootPart;
            });

            console.log(`Loaded ${AppState.files.size} files. Root: ${AppState.sosRoot}`);
            
            try {
                await runAnalysis();
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("Ëß£ÊûêÂ§±Êïó: " + err.message);
            } finally {
                toggleLoader(false);
            }
        });

        // --- Ëß£Êûê‰∏ªÊµÅÁ®ã ---
        async function runAnalysis() {
            updateStatus("Ê≠£Âú®ÂàÜÊûê Hostname ËàáÁâàÊú¨...");
            await parseBasicInfo();
            
            updateStatus("Ê≠£Âú®ÊéÉÊèèÁ°¨È´îË≥áË®ä...");
            await parseHardware();
            
            updateStatus("Ê≠£Âú®ÂàÜÊûêÁ≥ªÁµ±ÂèÉÊï∏...");
            await parseOS();
            
            updateStatus("Ê≠£Âú®ÂàÜÊûêÈÄ≤Á®ãËàáÁ∂≤Ë∑Ø...");
            await parseMiddleware();
            
            updateStatus("ÂÆåÊàê");
        }

        // --- Â∑•ÂÖ∑ÂáΩÂºè: ËÆÄÂèñÊ™îÊ°à ---
        async function readFile(subPath) {
            // ÂòóË©¶Â§öÁ®ÆÂèØËÉΩË∑ØÂæë (Âõ†ÁÇ∫‰∏çÂêåÁâàÊú¨ SOS report ÁµêÊßãÁï•Êúâ‰∏çÂêå)
            const possiblePaths = [
                `${AppState.sosRoot}/${subPath}`,
                `${AppState.sosRoot}/sos_commands/${subPath}`,
                `${AppState.sosRoot}/${subPath.replace(/\//g, '_')}` // ËàäÁâàÊúâÊôÇÊúÉÊâÅÂπ≥Âåñ
            ];

            // Ê®°Á≥äÊêúÂ∞ã Map keys
            let targetKey = null;
            for (let p of possiblePaths) {
                if (AppState.files.has(p)) {
                    targetKey = p;
                    break;
                }
            }
            
            // Â¶ÇÊûúÁ≤æÁ¢∫Ë∑ØÂæëÊâæ‰∏çÂà∞ÔºåÂòóË©¶ Regex ÂåπÈÖçÊ™îÊ°àÂêç
            if (!targetKey) {
                const fileName = subPath.split('/').pop(); // ‰æãÂ¶Ç lspci_-nnvv
                for (let key of AppState.files.keys()) {
                    if (key.includes(fileName)) {
                        targetKey = key;
                        break;
                    }
                }
            }

            if (!targetKey) return null;
            
            if (AppState.textCache[targetKey]) return AppState.textCache[targetKey];

            const file = AppState.files.get(targetKey);
            const text = await file.text();
            AppState.textCache[targetKey] = text;
            return text;
        }

        // --- Ê®°ÁµÑ 1: Âü∫Á§éË≥áË®ä ---
        async function parseBasicInfo() {
            // Hostname
            const hostname = await readFile('hostname') || await readFile('sos_commands/host/hostname');
            setText('dash-hostname', hostname ? hostname.trim() : 'Unknown');

            // Release
            const release = await readFile('etc/redhat-release') || await readFile('sos_commands/general/redhat-release');
            setText('dash-release', release ? release.trim() : 'Unknown');

            // Kernel
            const uname = await readFile('sos_commands/kernel/uname_-a');
            setText('dash-kernel', uname ? uname.trim() : 'Unknown');

            // Uptime
            const uptime = await readFile('uptime') || await readFile('sos_commands/host/uptime');
            setText('dash-uptime', uptime ? uptime.trim() : '-');
        }

        // --- Ê®°ÁµÑ 2: Á°¨È´îÂ±§ ---
        async function parseHardware() {
            const dmidecode = await readFile('sos_commands/hardware/dmidecode');
            if (dmidecode) {
                const product = dmidecode.match(/Product Name:\s*(.+)/);
                const vendor = dmidecode.match(/Manufacturer:\s*(.+)/);
                const bios = dmidecode.match(/Version:\s*(.+)/); // BIOS Section usually first
                
                setText('info-product', product ? product[1] : '-');
                setText('info-vendor', vendor ? vendor[1] : '-');
                setText('info-bios', bios ? bios[1] : '-');
            }

            const lspci = await readFile('sos_commands/pci/lspci_-nnvv') || await readFile('lspci');
            if (lspci) {
                // Á∞°ÂåñÈ°ØÁ§∫ÔºåÂè™È°ØÁ§∫‰∏ªË¶ÅÊéßÂà∂Âô®
                const lines = lspci.split('\n');
                const interesting = lines.filter(l => l.match(/RAID|VGA|Ethernet|Fibre|HBA|NVIDIA/i)).slice(0, 15).join('\n');
                setText('info-pci', interesting + (lines.length > 15 ? '\n... (more)' : ''));
            } else {
                setText('info-pci', 'lspci log not found');
            }
        }

        // --- Ê®°ÁµÑ 3: OS & Kernel ---
        async function parseOS() {
            // Tainted
            // ÂòóË©¶Âæû sysctl Êàñ dmesg Êâæ
            const sysctl = await readFile('sos_commands/kernel/sysctl_-a') || await readFile('sysctl.conf'); // sysctl.conf is static, command is better
            let tainted = 'Unknown';
            if (sysctl) {
                const m = sysctl.match(/kernel.tainted\s*=\s*(\d+)/);
                tainted = m ? (m[1] == '0' ? '0 (Not Tainted)' : `${m[1]} (Tainted)`) : 'Not found in sysctl';
            }
            
            // Re-check detailed tainted if dmesg available
            const dmesg = await readFile('sos_commands/kernel/dmesg');
            if (dmesg && tainted !== '0 (Not Tainted)') {
                if (dmesg.includes('Tainted: G')) tainted += ' (Proprietary Modules Loaded)';
            }
            setText('info-tainted', tainted);

            // SELinux
            const sestatus = await readFile('sos_commands/selinux/sestatus');
            if (sestatus) {
                const mode = sestatus.match(/Current mode:\s*(.+)/);
                setText('info-selinux', mode ? mode[1] : 'Unknown');
            } else {
                // Fallback check config
                const selinuxConf = await readFile('etc/selinux/config');
                const m = selinuxConf ? selinuxConf.match(/^SELINUX=(.+)/m) : null;
                setText('info-selinux', m ? `Configured: ${m[1]}` : 'Unknown');
            }

            // Sysctl Table
            if (sysctl) {
                const keys = ['vm.swappiness', 'net.ipv4.ip_forward', 'kernel.pid_max', 'fs.file-max', 'vm.overcommit_memory'];
                const tbody = document.querySelector('#table-sysctl tbody');
                tbody.innerHTML = '';
                keys.forEach(k => {
                    const regex = new RegExp(`^${k.replace(/\./g, '\\.')}\\s*=\s*(.+)`, 'm');
                    const match = sysctl.match(regex);
                    if (match) {
                        tbody.innerHTML += `<tr><td>${k}</td><td class="text-mono">${match[1]}</td></tr>`;
                    }
                });
            }
        }

        // --- Ê®°ÁµÑ 4: Middleware & App ---
        async function parseMiddleware() {
            // 1. Processes
            const ps = await readFile('sos_commands/process/ps_auxww') || await readFile('ps');
            if (ps) {
                const lines = ps.split('\n');
                // Filter middleware
                const mwRegex = /java|httpd|nginx|mqm|postgres|mysql|oracle|jboss|wildfly|openshift|kube|python/i;
                const mwLines = lines.filter(l => mwRegex.test(l) && !l.includes(' grep '));
                
                setText('info-middleware', mwLines.length > 0 ? mwLines.join('\n') : 'No common middleware processes detected.');

                // Dash Memory Table
                // Assuming ps format: USER PID %CPU %MEM ...
                // Skip header, sort by mem (4th column roughly)
                const sorted = lines.slice(1).map(l => {
                    const parts = l.trim().split(/\s+/);
                    return { user: parts[0], pid: parts[1], mem: parseFloat(parts[3]), cmd: parts.slice(10).join(' ') };
                }).sort((a,b) => b.mem - a.mem).slice(0, 5);

                const memTable = document.querySelector('#dash-mem-table tbody');
                memTable.innerHTML = '';
                sorted.forEach(row => {
                    memTable.innerHTML += `<tr><td>${row.user}</td><td>${row.pid}</td><td>${row.mem}%</td><td class="text-truncate" style="max-width: 150px;">${row.cmd}</td></tr>`;
                });
            }

            // 2. Systemd
            const systemd = await readFile('sos_commands/systemd/systemctl_list-unit-files');
            if (systemd) {
                const failed = (await readFile('sos_commands/systemd/systemctl_list-units_--state_failed') || '').trim();
                let output = "";
                if (failed && !failed.includes('0 loaded units listed')) {
                    output += "!!! FAILED UNITS DETECTED !!!\n" + failed + "\n\n";
                }
                output += "--- Enabled Services Sample ---\n";
                const enabled = systemd.split('\n').filter(l => l.includes('enabled')).slice(0, 10).join('\n');
                output += enabled + "\n...";
                setText('info-systemd', output);
            }

            // 3. Network
            const ipObj = await readFile('sos_commands/networking/ip_-o_addr');
            if (ipObj) setText('net-ip', ipObj);
            
            const ports = await readFile('sos_commands/networking/ss_-tulpn') || await readFile('netstat'); // netstat usually needs args
            if (ports) setText('net-ports', ports);
        }

        // --- Log Viewer Logic ---
        async function loadLog(type) {
            const viewer = document.getElementById('log-viewer');
            viewer.textContent = "Loading...";
            
            let content = null;
            if (type === 'dmesg') content = await readFile('sos_commands/kernel/dmesg');
            else content = await readFile('var/log/messages') || await readFile('sos_commands/logs/journalctl_--no-pager');

            if (!content) {
                viewer.textContent = "Log file not found in report.";
                return;
            }

            // Limit size for browser performance
            const lines = content.split('\n');
            const maxLines = 5000;
            const displayLines = lines.slice(-maxLines);
            
            viewer.textContent = displayLines.join('\n');
            if (lines.length > maxLines) {
                viewer.textContent = `[Displaying last ${maxLines} lines of ${lines.length} lines]\n\n` + viewer.textContent;
            }
        }

        document.getElementById('log-selector').addEventListener('change', (e) => {
            loadLog(e.target.value);
        });

        // --- UI Helpers ---
        function switchTab(tabId) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById('view-' + tabId);
            if (target) target.classList.remove('hidden');
            
            // Highlight nav
            const nav = Array.from(document.querySelectorAll('.nav-link')).find(el => el.getAttribute('onclick').includes(tabId));
            if (nav) nav.classList.add('active');

            if (tabId === 'logs') loadLog(document.getElementById('log-selector').value);
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        function toggleLoader(show) {
            const el = document.getElementById('loader');
            if (show) el.classList.add('active');
            else el.classList.remove('active');
        }

        function updateStatus(msg) {
            document.getElementById('parse-status').innerText = msg;
        }

        function filterLog() {
            const term = document.getElementById('log-search').value.toLowerCase();
            const viewer = document.getElementById('log-viewer');
            if (!viewer._originalText) viewer._originalText = viewer.textContent;
            
            if (!term) {
                viewer.textContent = viewer._originalText;
                return;
            }

            const lines = viewer._originalText.split('\n');
            const filtered = lines.filter(l => l.toLowerCase().includes(term));
            viewer.textContent = filtered.join('\n');
        }

    </script>
</body>
</html>