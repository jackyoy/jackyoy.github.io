<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v6 (Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; color: #333; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 2px solid #f0f0f0; font-weight: 700; color: #495057; }
        .upload-area { border: 2px dashed #adb5bd; border-radius: 12px; padding: 40px; text-align: center; background: #fff; cursor: pointer; transition: all 0.2s; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f8fbff; }
        .debug-console { background: #212529; color: #00ff00; font-family: 'Consolas', monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 250px; overflow-y: auto; margin-top: 20px; }
        .log-warn { color: #ffc107; } .log-err { color: #ff6b6b; } .log-debug { color: #6c757d; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary mb-0">RHEL SOS Analyzer v6</h2>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Ê∏ÖÈô§ÈáçÁΩÆ</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">üìÇ</div>
                <h4>ÈÅ∏Êìá sosreport Ë≥áÊñôÂ§æ</h4>
                <p class="text-muted">Â∑≤‰øÆÂæ© JS ÂáΩÂºèÂëºÂè´ÈåØË™§ÔºåË´ãÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÂ§æ</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1 mb-0">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2 mb-0">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 mb-0">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2 mb-0">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body position-relative">
                        <canvas id="memChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top CPU Processes</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 small">
                                <thead class="table-light"><tr><th>PID</th><th>User</th><th>CPU%</th><th>CMD</th></tr></thead>
                                <tbody id="ps-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h6 class="fw-bold text-secondary">Ëß£ÊûêÊó•Ë™å (Debug Log)</h6>
        <div class="debug-console" id="console"></div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];

    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.innerHTML = `> ${msg}`;
        if (type === 'warn') d.className = 'log-warn';
        if (type === 'err') d.className = 'log-err';
        if (type === 'debug') d.className = 'log-debug';
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        // Reset
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        document.getElementById('ps-tbody').innerHTML = '';
        document.getElementById('net-list').innerHTML = '';

        log(`ËºâÂÖ• ${files.length} ÂÄãÊ™îÊ°àÔºåÂª∫Á´ãÁ¥¢Âºï...`);
        
        fileMap.clear();
        filePaths = [];
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }

        // Áç®Á´ãÂü∑Ë°åÂêÑÊ®°ÁµÑÔºåÈÅøÂÖçÂñÆ‰∏ÄÈåØË™§Âç°Ê≠ªÂÖ®ÈÉ®
        try { await parseOS(); } catch(e) { log(`OSËß£ÊûêÂ§±Êïó: ${e}`, 'err'); }
        try { await parseMemory(); } catch(e) { log(`MemoryËß£ÊûêÂ§±Êïó: ${e}`, 'err'); }
        try { await parseProcess(); } catch(e) { log(`ProcessËß£ÊûêÂ§±Êïó: ${e}`, 'err'); }
        try { await parseNetwork(); } catch(e) { log(`NetworkËß£ÊûêÂ§±Êïó: ${e}`, 'err'); }
        
        log("üéâ ÊâÄÊúâÂ∑•‰ΩúÊéíÁ®ãÂ∑≤ÁµêÊùü", "info");
    }

    // --- Ê†∏ÂøÉÔºöÊ™îÊ°àËÆÄÂèñÂô® ---
    async function findFile(keywords, checkContentFn = null) {
        const kwList = Array.isArray(keywords) ? keywords : [keywords];
        
        // Á≠ñÁï• 1: ÂÑ™ÂÖàÂ∞ãÊâæ sos_commands ‰∏ãÁöÑÊ™îÊ°à
        let candidates = filePaths.filter(p => 
            kwList.some(kw => p.endsWith(`/${kw}`) || p.endsWith(kw)) 
            && p.includes('sos_commands')
        );

        // Á≠ñÁï• 2: ‰∏ÄËà¨ÊêúÂ∞ã
        if (candidates.length === 0) {
            candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`)));
        }

        // Á≠ñÁï• 3: ÂØ¨È¨ÜÊêúÂ∞ã (ÊéíÈô§ .xz)
        if (candidates.length === 0) {
            candidates = filePaths.filter(p => kwList.some(kw => p.includes(kw) && !p.endsWith('.xz')));
        }

        if (candidates.length === 0) {
            log(`‚ö†Ô∏è Êâæ‰∏çÂà∞ÈóúÈçµÂ≠ó [${kwList}]`, 'warn');
            return null;
        }

        // ÈÄê‰∏ÄÂòóË©¶ËÆÄÂèñÔºåÁõ¥Âà∞ÂÖßÂÆπÁ¨¶Âêà
        for (const path of candidates) {
            const file = fileMap.get(path);
            const content = await readFileText(file);
            
            if (!content) continue;

            if (checkContentFn) {
                if (checkContentFn(content)) {
                    log(`‚úÖ ËÆÄÂèñÊàêÂäü: ...${path.slice(-40)}`, 'debug');
                    return content;
                }
            } else {
                log(`‚úÖ ËÆÄÂèñÊàêÂäü: ...${path.slice(-40)}`, 'debug');
                return content;
            }
        }
        
        log(`‚ùå ÊâæÂà∞Ê™îÊ°à‰ΩÜÂÖßÂÆπÊ†ºÂºè‰∏çÁ¨¶ [${kwList}]`, 'err');
        return null;
    }

    function readFileText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Ëß£ÊûêÂô® ---

    async function parseOS() {
        // Hostname
        const hostname = await findFile('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        // Release (RHEL Ê®ôÊ∫ñ‰ΩçÁΩÆ)
        const release = await findFile(['redhat-release', 'os-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        // Kernel
        const uname = await findFile('uname');
        if (uname) {
            const parts = uname.split(' ');
            if (parts.length > 2) document.getElementById('os-kernel').textContent = parts[2];
        }

        // Uptime (ÈÅéÊøæ /proc/uptime Á¥îÊï∏Â≠óÊ†ºÂºèÔºåÂº∑Âà∂ÊâæÊåá‰ª§Ëº∏Âá∫)
        const uptime = await findFile(['uptime', 'date'], (content) => content.includes('up') && content.includes(':'));
        if (uptime) {
            const m = uptime.match(/up\s+([^,]+)/);
            if (m) document.getElementById('os-uptime').textContent = m[1];
        } else {
            document.getElementById('os-uptime').textContent = "N/A";
        }
    }

    async function parseMemory() {
        // Proc meminfo
        const data = await findFile(['meminfo']);
        if (!data) return;

        const val = (k) => { const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm')); return m ? parseInt(m[1]) : 0; };
        const total = val('MemTotal'), free = val('MemFree'), buff = val('Buffers'), cached = val('Cached'), slab = val('Slab');
        const used = total - free - buff - cached - slab;
        
        document.getElementById('mem-total-badge').textContent = (total/1024/1024).toFixed(1) + " GB";

        new Chart(document.getElementById('memChart'), {
            type: 'doughnut',
            data: {
                labels: ['Used', 'Buff/Cache', 'Free'],
                datasets: [{ 
                    data: [used, buff+cached+slab, free], 
                    backgroundColor: ['#dc3545', '#ffc107', '#198754'] 
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    async function parseNetwork() {
        // RHEL sosreport Ê®ôÊ∫ñË∑ØÂæë: sos_commands/networking/ip_address
        const data = await findFile(['ip_address', 'ip_addr', 'ip_-d_address'], (c) => c.includes('state') || c.includes('mtu'));
        const list = document.getElementById('net-list');
        list.innerHTML = '';
        
        if (!data) {
            list.innerHTML = '<div class="p-3 text-muted text-center">Êü•ÁÑ° Network Ë≥áÊñô</div>';
            return;
        }

        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const name = match[1];
            const state = match[2];
            const isUp = state === 'UP';
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${name}</span>
                    <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${state}</span>
                </div>`;
        }
    }

    async function parseProcess() {
        // ÈáùÂ∞ç RHELÔºåps_auxwwwm ÊòØÊúÄË©≥Á¥∞ÁöÑ„ÄÇ‰πüÂòóË©¶ ps_aux Êàñ ps
        const data = await findFile(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps'], (c) => c.includes('PID'));
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = ''; // Ê∏ÖÁ©∫

        if (!data) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ÁÑ° PS Ë≥áÊñô</td></tr>';
            return;
        }

        const lines = data.split('\n');
        let procs = [];
        let map = { user:0, pid:1, cpu:2, cmd:10 }; 
        
        // Ëá™ÂãïÂÅµÊ∏¨ Header
        for(let line of lines.slice(0,20)) {
            if(line.includes('PID') && line.includes('CPU')) {
                const parts = line.trim().split(/\s+/);
                map.user = parts.indexOf('USER');
                map.pid = parts.indexOf('PID');
                map.cpu = parts.findIndex(c => c.includes('CPU'));
                map.cmd = parts.indexOf('COMMAND');
                if(map.cmd === -1) map.cmd = parts.indexOf('CMD');
                if(map.cmd === -1) map.cmd = 10;
                break;
            }
        }

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.includes('PID')) continue;
            const p = line.split(/\s+/);
            if (p.length < 10) continue;

            procs.push({
                user: p[map.user],
                pid: p[map.pid],
                cpu: parseFloat(p[map.cpu]) || 0,
                cmd: p.slice(map.cmd).join(' ')
            });
        }

        procs.sort((a,b) => b.cpu - a.cpu).slice(0, 5).forEach(p => {
            // Êà™Êñ∑ÈÅéÈï∑ÁöÑÊåá‰ª§
            const safeCmd = p.cmd.length > 50 ? p.cmd.substring(0, 50) + '...' : p.cmd;
            tbody.innerHTML += `
                <tr>
                    <td><small>${p.pid}</small></td>
                    <td>${p.user}</td>
                    <td class="fw-bold text-danger">${p.cpu}%</td>
                    <td title="${p.cmd}"><small class="text-muted">${safeCmd}</small></td>
                </tr>`;
        });
    }
</script>
</body>
</html>