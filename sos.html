<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v8 (Log Analysis)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; color: #212529; }
        
        /* å¡ç‰‡èˆ‡ä½ˆå±€ */
        .card { border: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 8px; margin-bottom: 24px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card-header { background: #fff; border-bottom: 1px solid #eee; font-weight: 700; color: #495057; padding: 15px 20px; }
        
        /* ä¸Šå‚³å€ */
        .upload-area { border: 2px dashed #adb5bd; border-radius: 12px; padding: 50px; text-align: center; background: #fff; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: #0d6efd; background-color: #f8fbff; }
        
        /* Log Viewer æ¨£å¼ */
        .log-viewer { background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; font-size: 0.85rem; height: 400px; overflow-y: auto; padding: 15px; border-radius: 6px; white-space: pre-wrap; line-height: 1.5; }
        .log-line { display: block; border-bottom: 1px solid #333; padding: 2px 0; }
        .log-line:hover { background-color: #2a2d2e; }
        .log-date { color: #569cd6; margin-right: 10px; }
        .log-process { color: #4ec9b0; margin-right: 10px; }
        .log-error { color: #f44336; font-weight: bold; }
        .log-warn { color: #ffc107; font-weight: bold; }

        /* é™¤éŒ¯å€ */
        .debug-console { background: #000; color: #0f0; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 4px; height: 150px; overflow-y: auto; margin-top: 10px; }
        
        /* Chart Container */
        .chart-container { position: relative; height: 220px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-0">RHEL SOS Analyzer</h3>
            <small class="text-muted">v8.0 (Logs + Process Fix)</small>
        </div>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">æ¸…é™¤é‡ç½®</button>
    </div>

    <div class="row justify-content-center" id="upload-section">
        <div class="col-md-8">
            <div class="upload-area" onclick="document.getElementById('folderInput').click()">
                <div class="display-4 mb-3">ğŸ“‚</div>
                <h4>è¼‰å…¥ sosreport è³‡æ–™å¤¾</h4>
                <p class="text-muted">æœ¬æ©Ÿé‹ç®—ï¼Œæ”¯æ´ Log åˆ†æèˆ‡ Process è©³ç´°åˆ—è¡¨</p>
                <input type="file" id="folderInput" webkitdirectory multiple style="display: none" onchange="handleFiles(this.files)">
            </div>
        </div>
    </div>

    <div id="dashboard" style="display: none;">
        
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">HOSTNAME</small>
                        <h4 id="os-hostname" class="text-primary mt-1">--</h4>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">RELEASE</small>
                        <h5 id="os-release" class="mt-2">--</h5>
                    </div>
                    <div class="col-md-3 border-end">
                        <small class="text-muted fw-bold">KERNEL</small>
                        <h5 id="os-kernel" class="mt-2 text-break">--</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted fw-bold">UPTIME</small>
                        <h5 id="os-uptime" class="mt-2">--</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between">
                        <span>Memory Usage</span>
                        <span id="mem-total-badge" class="badge bg-secondary">-- GB</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="memChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top CPU Processes</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 small" style="table-layout: fixed;">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 20%">PID</th>
                                        <th style="width: 25%">User</th>
                                        <th style="width: 20%">CPU%</th>
                                        <th style="width: 35%">Command</th>
                                    </tr>
                                </thead>
                                <tbody id="ps-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-header">Network Interfaces</div>
                    <div class="card-body p-0">
                        <div id="net-list" class="list-group list-group-flush" style="max-height: 260px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>System Logs Analysis (Last 1000 lines)</span>
                        <div class="d-flex gap-2">
                            <select id="log-selector" class="form-select form-select-sm" style="width: 200px;" onchange="renderLog()">
                                <option value="" disabled selected>é¸æ“‡ Log æª”æ¡ˆ...</option>
                            </select>
                            <input type="text" id="log-search" class="form-control form-control-sm" placeholder="éæ¿¾é—œéµå­— (å¦‚: error)..." style="width: 200px;" onkeyup="filterLog()">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-viewer" class="log-viewer">
                            <div class="text-center text-muted mt-5">è«‹å¾å³ä¸Šè§’é¸æ“‡è¦æª¢è¦–çš„ Log æª”æ¡ˆ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-2">
        <small class="text-muted" onclick="document.getElementById('console').style.display='block'" style="cursor:pointer">Show Debug Log</small>
        <div class="debug-console" id="console" style="display:none;"></div>
    </div>
</div>

<script>
    let fileMap = new Map();
    let filePaths = [];
    let loadedLogs = {}; // Cache logs

    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const d = document.createElement('div');
        d.textContent = `> ${msg}`;
        if (type === 'err') d.style.color = '#ff6b6b';
        if (type === 'debug') d.style.color = '#888';
        c.appendChild(d);
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        // UI Reset
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('console').innerHTML = '';
        
        if (window.memChartInstance) { window.memChartInstance.destroy(); window.memChartInstance = null; }

        log(`Indexing ${files.length} files...`);
        fileMap.clear(); filePaths = []; loadedLogs = {};
        
        for (let i = 0; i < files.length; i++) {
            const path = files[i].webkitRelativePath;
            fileMap.set(path, files[i]);
            filePaths.push(path);
        }

        // Parallel Execution
        await Promise.all([
            safeRun(parseOS, 'OS'),
            safeRun(parseMemory, 'Memory'),
            safeRun(parseProcess, 'Process'), // Fixed Process Parser
            safeRun(parseNetwork, 'Network'),
            safeRun(initLogSystem, 'Logs')    // New Log System
        ]);
        
        log("All tasks completed.", "info");
    }

    async function safeRun(fn, name) {
        try { await fn(); } catch(e) { log(`${name} Error: ${e.message}`, 'err'); }
    }

    // --- Optimized Finder ---
    async function findFile(keywords, checkContentFn = null, returnPath = false) {
        const kwList = Array.isArray(keywords) ? keywords : [keywords];
        
        // Priority: sos_commands > regular path > fuzzy
        let candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`) || p.endsWith(kw)) && p.includes('sos_commands'));
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.endsWith(`/${kw}`)));
        if (candidates.length === 0) candidates = filePaths.filter(p => kwList.some(kw => p.includes(kw) && !p.endsWith('.xz')));

        for (const path of candidates) {
            const file = fileMap.get(path);
            const content = await readFileText(file);
            if (!content) continue;
            
            // Validate Content
            if (checkContentFn && !checkContentFn(content)) continue;

            return returnPath ? { content, path } : content;
        }
        return null;
    }

    function readFileText(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
        });
    }

    // --- Parsers ---

    async function parseOS() {
        const hostname = await findFile('hostname');
        if (hostname) document.getElementById('os-hostname').textContent = hostname.trim();

        const release = await findFile(['redhat-release', 'os-release']);
        if (release) {
            const m = release.match(/PRETTY_NAME="([^"]+)"/);
            document.getElementById('os-release').textContent = m ? m[1] : release.split('\n')[0];
        }

        const uname = await findFile(['uname_-a', 'uname']);
        if (uname) {
            const m = uname.match(/(\d+\.\d+\.\d+-\S+)/); 
            document.getElementById('os-kernel').textContent = m ? m[1] : (uname.split(/\s+/)[2] || uname);
        }

        const uptime = await findFile(['uptime', 'date'], c => c.includes('up'));
        if (uptime) {
            const m = uptime.match(/up\s+([^,]+)/);
            if (m) document.getElementById('os-uptime').textContent = m[1];
        }
    }

    async function parseMemory() {
        const data = await findFile('meminfo');
        if (!data) return;
        const val = (k) => { const m = data.match(new RegExp(`^${k}:\\s+(\\d+)`, 'm')); return m ? parseInt(m[1]) : 0; };
        const total = val('MemTotal'), free = val('MemFree'), buff = val('Buffers'), cached = val('Cached'), slab = val('Slab');
        const used = total - free - buff - cached - slab;
        
        document.getElementById('mem-total-badge').textContent = (total/1024/1024).toFixed(1) + " GB";

        const ctx = document.getElementById('memChart').getContext('2d');
        window.memChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Used', 'Buff/Cache', 'Free'],
                datasets: [{ data: [used, buff+cached+slab, free], backgroundColor: ['#dc3545', '#ffc107', '#198754'], borderWidth: 1 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    // Fixed PS Parser
    async function parseProcess() {
        const data = await findFile(['ps_auxwwwm', 'ps_auxww', 'ps_aux', 'ps'], c => c.includes('PID'));
        const tbody = document.getElementById('ps-tbody');
        tbody.innerHTML = ''; 

        if (!data) return;

        const lines = data.split('\n');
        let procs = [];
        let map = { user:0, pid:1, cpu:2, cmd:10 }; 
        
        // Smart Header Detection
        for(let line of lines.slice(0,20)) {
            if(line.includes('PID') && line.includes('CPU')) {
                const parts = line.trim().split(/\s+/);
                map.user = parts.indexOf('USER');
                map.pid = parts.indexOf('PID');
                map.cpu = parts.findIndex(c => c.includes('CPU'));
                map.cmd = parts.indexOf('COMMAND');
                if(map.cmd === -1) map.cmd = parts.indexOf('CMD');
                if(map.cmd === -1) map.cmd = 10;
                break;
            }
        }

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.includes('PID')) continue;
            const p = line.split(/\s+/);
            if (p.length < 10) continue;

            // Safe Command Extraction
            const cmd = p.slice(map.cmd).join(' ');
            
            procs.push({
                user: p[map.user],
                pid: p[map.pid],
                cpu: parseFloat(p[map.cpu]) || 0,
                cmd: cmd
            });
        }

        // Render TOP 5 safely
        procs.sort((a,b) => b.cpu - a.cpu).slice(0, 5).forEach(p => {
            const row = document.createElement('tr');
            
            // å®‰å…¨æ’å…¥æ–‡å­—ï¼Œé˜²æ­¢ HTML Injection æˆ–æ¸²æŸ“ä¸­æ–·
            row.innerHTML = `
                <td><small>${p.pid}</small></td>
                <td>${p.user}</td>
                <td class="fw-bold text-danger">${p.cpu}%</td>
                <td class="text-truncate" style="max-width: 150px;"></td>
            `;
            // Command ä½¿ç”¨ textContent è³¦å€¼ï¼Œé¿å…ç‰¹æ®Šç¬¦è™Ÿç ´å£ HTML
            row.querySelector('.text-truncate').textContent = p.cmd;
            tbody.appendChild(row);
        });
    }

    async function parseNetwork() {
        const data = await findFile(['ip_address', 'ip_addr', 'ip_-d_address'], c => c.includes('state'));
        const list = document.getElementById('net-list');
        list.innerHTML = '';
        if (!data) return;

        const regex = /^\d+:\s+([^:]+):.*state\s+(\w+)/gm;
        let match;
        while ((match = regex.exec(data)) !== null) {
            const isUp = match[2] === 'UP';
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${match[1]}</span>
                    <span class="badge ${isUp ? 'bg-success' : 'bg-secondary'}">${match[2]}</span>
                </div>`;
        }
    }

    // --- New: Log System ---
    
    async function initLogSystem() {
        const logFiles = ['messages', 'dmesg', 'secure', 'cron', 'boot.log', 'yum.log', 'dnf.log'];
        const select = document.getElementById('log-selector');
        select.innerHTML = '<option value="" disabled selected>é¸æ“‡ Log æª”æ¡ˆ...</option>';
        
        let foundAny = false;

        // æœå°‹é€™äº› Log æª”æ¡ˆ
        for (const logName of logFiles) {
            // å˜—è©¦å°‹æ‰¾ä¸¦è¿”å›è·¯å¾‘ç‰©ä»¶
            const result = await findFile([logName], null, true); // true = return object {content, path}
            
            if (result) {
                foundAny = true;
                // Store in memory
                loadedLogs[logName] = result.content;
                
                // Add to dropdown
                const opt = document.createElement('option');
                opt.value = logName;
                opt.textContent = `${logName} (${result.path.split('/').slice(-2).join('/')})`;
                select.appendChild(opt);
            }
        }

        if (foundAny) {
            log(`å·²ç´¢å¼•ç³»çµ± Logsï¼Œè«‹ä½¿ç”¨ä¸‹æ‹‰é¸å–®æª¢è¦–ã€‚`, 'info');
        } else {
            document.getElementById('log-viewer').innerHTML = '<div class="text-center text-muted mt-5">æœªæ‰¾åˆ°æ¨™æº– Log æª”æ¡ˆ (messages/dmesg)</div>';
        }
    }

    function renderLog() {
        const logName = document.getElementById('log-selector').value;
        const viewer = document.getElementById('log-viewer');
        const filterText = document.getElementById('log-search').value.toLowerCase();
        
        if (!logName || !loadedLogs[logName]) return;

        const content = loadedLogs[logName];
        const lines = content.split('\n');
        
        // æ•ˆèƒ½å„ªåŒ–ï¼šåªå–æœ€å¾Œ 1000 è¡Œ
        const tailLines = lines.slice(-1000);
        
        viewer.innerHTML = '';
        let htmlBuffer = '';

        tailLines.forEach(line => {
            if (filterText && !line.toLowerCase().includes(filterText)) return;
            if (!line.trim()) return;

            // Highlight Keywords
            let cssClass = 'log-line';
            if (line.match(/error|fail|panic|critical/i)) cssClass += ' log-error';
            else if (line.match(/warn|alert/i)) cssClass += ' log-warn';

            // Simple formatting (Timestamp detection is hard generally, skipping for speed)
            htmlBuffer += `<div class="${cssClass}">${escapeHtml(line)}</div>`;
        });

        viewer.innerHTML = htmlBuffer;
        viewer.scrollTop = viewer.scrollHeight; // Scroll to bottom
    }

    function filterLog() {
        // Debounce could be added here, but direct call is fine for 1000 lines
        renderLog();
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

</script>
</body>
</html>