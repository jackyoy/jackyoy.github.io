<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHEL SOS Analyzer v9 (Final Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --sidebar-width: 260px; --bg-dark: #1e1e2f; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        .sidebar { width: var(--sidebar-width); background: var(--bg-dark); color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-link { color: rgba(255,255,255,0.7); padding: 12px 20px; cursor: pointer; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-left-color: #0d6efd; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { font-weight: 600; background: #fff; border-bottom: 1px solid #eee; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .source-badge { font-size: 0.75rem; color: #fff; background-color: #6c757d; padding: 2px 8px; border-radius: 4px; font-weight: normal; font-family: monospace; }
        
        .console-box { background: #2d2d3b; color: #e0e0e0; font-family: 'Consolas', monospace; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; max-height: 400px; overflow-y: auto; }
        
        .upload-wrapper { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .upload-box { border: 2px dashed #ccc; padding: 40px; border-radius: 12px; background: #fff; text-align: center; cursor: pointer; width: 500px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-3 fw-bold border-bottom border-secondary">RHEL SOS Analyzer v9</div>
        <nav class="nav flex-column mt-2">
            <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ“Š ç¸½è¦½ (Dashboard)</a>
            <a class="nav-link" onclick="switchTab('host-info')">ğŸ–¥ï¸ ç³»çµ±æ·±åº¦è©•ä¼°</a>
            <a class="nav-link" onclick="switchTab('network')">ğŸŒ ç¶²è·¯ç‹€æ…‹</a>
            <a class="nav-link" onclick="switchTab('debug')">ğŸ æª”æ¡ˆæª¢æ¸¬</a>
        </nav>
    </div>

    <div class="main-content">
        <div id="loader" class="alert alert-info hidden">æ­£åœ¨è§£ææª”æ¡ˆçµæ§‹...</div>

        <div id="view-upload" class="upload-wrapper">
            <div class="upload-box" onclick="document.getElementById('dir-input').click()">
                <div class="fs-1 mb-2">ğŸ“‚</div>
                <h4>ä¸Šå‚³ SOS Report è³‡æ–™å¤¾</h4>
                <p class="text-muted small">è«‹é¸æ“‡è§£å£“ç¸®å¾Œçš„è³‡æ–™å¤¾</p>
                <input type="file" id="dir-input" webkitdirectory directory multiple class="d-none">
            </div>
        </div>

        <div id="view-dashboard" class="content-view hidden">
            <h4 class="mb-3">ç³»çµ±æ¦‚è§€</h4>
            <div class="row g-3">
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Hostname</small><div class="fw-bold text-primary" id="dash-hostname">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Release</small><div class="fw-bold" id="dash-release">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Kernel</small><div class="fw-bold small text-truncate" id="dash-kernel">-</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><small class="text-muted">Uptime</small><div class="fw-bold" id="dash-uptime">-</div></div></div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            Top Memory Processes
                            <span class="source-badge" id="src-ps-dash">Pending</span>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size:0.9rem">
                                <thead class="table-light"><tr><th>PID</th><th>USER</th><th>MEM%</th><th>CPU%</th><th>COMMAND</th></tr></thead>
                                <tbody id="mem-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-host-info" class="content-view hidden">
            <h4 class="mb-3">ç¡¬é«”èˆ‡ç³»çµ±æ·±åº¦è³‡è¨Š</h4>
            
            <div class="card">
                <div class="card-header">Middleware Processes <span class="source-badge" id="src-ps-mid">Pending</span></div>
                <div class="card-body">
                    <div class="console-box" id="info-middleware">Scanning...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Hardware & BIOS <span class="source-badge" id="src-dmi">Pending</span></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4"><strong>Model:</strong> <span id="info-model">-</span></div>
                        <div class="col-md-4"><strong>Vendor:</strong> <span id="info-vendor">-</span></div>
                        <div class="col-md-4"><strong>BIOS:</strong> <span id="info-bios">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-network" class="content-view hidden">
             <h4 class="mb-3">ç¶²è·¯åˆ†æ</h4>
             <div class="card">
                <div class="card-header">Listening Ports (Netstat/SS) <span class="source-badge" id="src-ss">Pending</span></div>
                <div class="card-body">
                    <div class="console-box" id="net-ss">Searching...</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">IP Address <span class="source-badge" id="src-ip">Pending</span></div>
                <div class="card-body"><div class="console-box" id="net-ip">Searching...</div></div>
            </div>
        </div>

        <div id="view-debug" class="content-view hidden">
            <h4>æª”æ¡ˆç´¢å¼•æª¢æ¸¬ (Debug)</h4>
            <div class="console-box" id="debug-list"></div>
        </div>

    </div>

    <script>
        const App = {
            files: new Map(),
            filePaths: [],
            cache: {},
            
            // ä¿®æ­£å¾Œçš„è¦å‰‡ï¼šåŒ…å«æ‚¨çš„ç‰¹å®šæª”å ps_auxwwwm å’Œ netstat
            rules: {
                ps: [/ps_aux.*$/, /ps_auxwwwm$/], // å¯¬é¬†åŒ¹é…æ‰€æœ‰ aux é–‹é ­ï¼ŒåŒ…å« m
                netstat: [/netstat.*neopa$/, /netstat.*-W.*$/, /netstat$/], // åŒ¹é… netstat ç›¸é—œ
                ss: [/ss_-tulpn$/],
                hostname: [/hostname$/],
                release: [/redhat-release$/],
                uptime: [/uptime$/],
                uname: [/uname_-a$/],
                dmidecode: [/dmidecode$/],
                ip: [/ip_.*addr$/]
            }
        };

        document.getElementById('dir-input').addEventListener('change', async (e) => {
            const fileList = e.target.files;
            if (!fileList.length) return;

            document.getElementById('loader').classList.remove('hidden');
            
            App.files.clear();
            App.filePaths = [];
            App.cache = {};

            let debugLog = "";
            for (let f of fileList) {
                const parts = f.webkitRelativePath.split('/');
                const relPath = parts.slice(1).join('/'); 
                if (f.size > 0) {
                    App.files.set(relPath, f);
                    App.filePaths.push(relPath);
                    debugLog += `${relPath} (${f.size} B)\n`;
                }
            }
            document.getElementById('debug-list').textContent = debugLog;

            try {
                await Promise.all([runDashboard(), runHostInfo(), runNetwork()]);
                document.getElementById('view-upload').classList.add('hidden');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                alert("è§£æéŒ¯èª¤: " + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        async function findAndRead(ruleKey) {
            const regexList = App.rules[ruleKey];
            if (!regexList) return { content: null, path: null };

            let foundPath = null;
            // å„ªå…ˆæ‰¾è·¯å¾‘è¼ƒé•·ä¸”åŒ…å« sos_commands çš„ (é€šå¸¸æ˜¯çœŸèº«)
            const matches = App.filePaths.filter(p => regexList.some(r => r.test(p)));
            if (matches.length > 0) {
                matches.sort((a, b) => b.length - a.length); // Longest path first
                // Prefer sos_commands
                const best = matches.find(m => m.includes('sos_commands')) || matches[0];
                foundPath = best;
            }

            if (foundPath) {
                if (!App.cache[foundPath]) {
                    App.cache[foundPath] = await App.files.get(foundPath).text();
                }
                return { content: App.cache[foundPath], path: foundPath };
            }
            return { content: null, path: null };
        }

        function showSrc(id, path) {
            const el = document.getElementById(id);
            if (el) el.textContent = path ? `SRC: .../${path.split('/').pop()}` : 'Not Found';
        }

        async function runDashboard() {
            const h = await findAndRead('hostname');
            if(h.content) document.getElementById('dash-hostname').textContent = h.content.trim();

            const r = await findAndRead('release');
            if(r.content) document.getElementById('dash-release').textContent = r.content.split('\n')[0];

            const u = await findAndRead('uptime');
            if(u.content) document.getElementById('dash-uptime').textContent = u.content.trim();

            const k = await findAndRead('uname');
            if (k.content) {
                const parts = k.content.split(' ');
                if (parts.length >= 3) document.getElementById('dash-kernel').textContent = parts[2];
                else document.getElementById('dash-kernel').textContent = k.content;
            }
        }

        async function runHostInfo() {
            // PS è§£æ (é‡å°æ‚¨çš„ ps_auxwwwm æ ¼å¼)
            const ps = await findAndRead('ps');
            showSrc('src-ps-dash', ps.path);
            showSrc('src-ps-mid', ps.path);

            if (ps.content) {
                const lines = ps.content.split('\n');
                let headerIndex = -1;
                // æ‰¾ Header
                for(let i=0; i<Math.min(50, lines.length); i++) {
                    if (lines[i].includes('PID') && lines[i].includes('%MEM') && lines[i].includes('COMMAND')) {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex !== -1) {
                    const parsed = [];
                    // è§£æ Header å¾Œçš„æ¯ä¸€è¡Œ
                    for (let i = headerIndex + 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const parts = line.split(/\s+/);
                        
                        // ps auxwwwm æ ¼å¼: USER PID %CPU %MEM ...
                        // æ‚¨çš„æª”æ¡ˆä¸­æœ‰ PID ç‚º '-' çš„è¡Œï¼Œå¿…é ˆéæ¿¾æ‰
                        const pidStr = parts[1];
                        if (pidStr === '-' || isNaN(parseInt(pidStr))) continue;

                        if (parts.length < 10) continue;

                        const mem = parseFloat(parts[3]);
                        const cpu = parseFloat(parts[2]);
                        const cmd = parts.slice(10).join(' ');

                        if (!isNaN(mem)) {
                            parsed.push({ user: parts[0], pid: pidStr, mem, cpu, cmd });
                        }
                    }

                    // Top 5 Memory
                    const top5 = parsed.sort((a, b) => b.mem - a.mem).slice(0, 5);
                    document.getElementById('mem-table-body').innerHTML = top5.map(p => 
                        `<tr><td>${p.pid}</td><td>${p.user}</td><td>${p.mem}%</td><td>${p.cpu}%</td><td class="text-truncate" style="max-width:200px" title="${p.cmd}">${p.cmd}</td></tr>`
                    ).join('');

                    // Middleware
                    const mwRegex = /java|python|node|httpd|nginx|mysql|postgres|docker|kube/i;
                    const mw = parsed.filter(p => mwRegex.test(p.cmd) && !p.cmd.includes(' grep '));
                    document.getElementById('info-middleware').textContent = mw.length ? mw.map(p => `${p.user} (${p.pid}): ${p.cmd}`).join('\n') : "No common middleware found.";
                } else {
                    document.getElementById('mem-table-body').innerHTML = "<tr><td colspan='5'>Header not found in PS file</td></tr>";
                }
            }

            // DMI
            const dmi = await findAndRead('dmidecode');
            showSrc('src-dmi', dmi.path);
            if(dmi.content) {
                const prod = (dmi.content.match(/Product Name:\s*(.+)/) || [])[1];
                const vend = (dmi.content.match(/Manufacturer:\s*(.+)/) || [])[1];
                const bios = (dmi.content.match(/Version:\s*(.+)/) || [])[1];
                if(prod) document.getElementById('info-model').textContent = prod;
                if(vend) document.getElementById('info-vendor').textContent = vend;
                if(bios) document.getElementById('info-bios').textContent = bios;
            }
        }

        async function runNetwork() {
            // å„ªå…ˆæ‰¾ Netstat (å› ç‚ºæ‚¨çš„å ±å‘Šä¸­ä¸»è¦æ˜¯é€™å€‹)
            let net = await findAndRead('netstat');
            let source = "netstat";
            
            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œæ‰è©¦è©¦çœ‹ SS
            if (!net.content) {
                net = await findAndRead('ss');
                source = "ss";
            }

            showSrc('src-ss', net.path);

            if (net.content) {
                const lines = net.content.split('\n');
                let output = "";
                
                if (source === 'netstat') {
                    // Netstat è§£æï¼šåªé¡¯ç¤º LISTEN
                    // æ ¼å¼ï¼šProto Recv-Q Send-Q Local Address ... State ... PID/Program
                    output = lines.filter(l => l.includes('Proto') || l.includes('LISTEN')).join('\n');
                } else {
                    // SS è§£æ
                    output = lines.filter(l => l.includes('State') || l.includes('LISTEN')).join('\n');
                }
                
                document.getElementById('net-ss').textContent = output || "No LISTEN ports found.";
            } else {
                document.getElementById('net-ss').textContent = "Netstat/SS log not found.";
            }

            const ip = await findAndRead('ip');
            showSrc('src-ip', ip.path);
            if(ip.content) document.getElementById('net-ip').textContent = ip.content;
        }

        function switchTab(id) {
            document.querySelectorAll('.content-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
            const navs = document.querySelectorAll('.nav-link');
            for(let n of navs) {
                if(n.getAttribute('onclick').includes(id)) n.classList.add('active');
            }
        }
    </script>
</body>
</html>