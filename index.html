<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¨ºæ–·æ—¥èªŒè½‰æ›å™¨</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ (è½‰æ›å™¨ä»‹é¢) --- */
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 450px; width: 90%; }
        h1 { color: #2d3748; margin-bottom: 0.5rem; font-size: 1.5rem; }
        p { color: #718096; margin-bottom: 2rem; font-size: 0.95rem; }
        
        .upload-area { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 2rem; cursor: pointer; transition: 0.2s; margin-bottom: 1.5rem; }
        .upload-area:hover { border-color: #4299e1; background-color: #ebf8ff; }
        .upload-icon { font-size: 2rem; color: #4299e1; margin-bottom: 0.5rem; }
        
        button { background-color: #4299e1; color: white; border: none; padding: 0.8rem 2rem; border-radius: 6px; font-size: 1rem; cursor: pointer; transition: 0.2s; width: 100%; font-weight: 600; }
        button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #3182ce; }
        button.download { background-color: #48bb78; }
        button.download:hover { background-color: #38a169; }

        #status { margin-top: 1rem; font-size: 0.9rem; color: #4a5568; min-height: 1.5em; }
    </style>
</head>
<body>

    <div class="card">
        <h1>ç³»çµ±æ—¥èªŒè¦–è¦ºåŒ–å·¥å…·</h1>
        <p>å°‡ç´”æ–‡å­—çš„ FULL_DIAG æª”æ¡ˆè½‰æ›ç‚ºå¥½è®€çš„ HTML å ±å‘Šã€‚</p>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">ğŸ“‚</div>
            <div id="fileName">é»æ“Šä¸Šå‚³ .txt æª”æ¡ˆ</div>
            <input type="file" id="fileInput" accept=".txt" style="display: none;">
        </div>

        <button id="actionBtn" disabled>é–‹å§‹è½‰æ›</button>
        <div id="status"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const actionBtn = document.getElementById('actionBtn');
        const statusDiv = document.getElementById('status');
        const fileNameDiv = document.getElementById('fileName');
        let selectedFile = null;
        let downloadUrl = null;

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                fileNameDiv.textContent = selectedFile.name;
                fileNameDiv.style.color = "#2d3748";
                actionBtn.disabled = false;
                actionBtn.textContent = "é–‹å§‹è½‰æ›";
                actionBtn.className = ""; 
                if (downloadUrl) URL.revokeObjectURL(downloadUrl);
            }
        });

        actionBtn.addEventListener('click', () => {
            if (actionBtn.classList.contains('download')) {
                // ä¸‹è¼‰æ¨¡å¼
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = selectedFile.name.replace('.txt', '_report.html');
                a.click();
            } else {
                // è½‰æ›æ¨¡å¼
                processFile();
            }
        });

        function processFile() {
            actionBtn.disabled = true;
            actionBtn.textContent = "è™•ç†ä¸­...";
            statusDiv.textContent = "æ­£åœ¨è§£ææ—¥èªŒçµæ§‹...";

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                
                try {
                    // 1. è§£ææª”æ¡ˆ
                    const sections = parseLog(text);
                    
                    if (sections.length === 0) {
                        throw new Error("ç„¡æ³•è­˜åˆ¥æª”æ¡ˆæ ¼å¼ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºæ¨™æº– DIAG æª”æ¡ˆã€‚");
                    }

                    // 2. ç”Ÿæˆ HTML å ±å‘Šå­—ä¸²
                    const reportHtml = generateReportHtml(selectedFile.name, sections);

                    // 3. å»ºç«‹ Blob ä¸‹è¼‰é€£çµ
                    const blob = new Blob([reportHtml], { type: 'text/html' });
                    downloadUrl = URL.createObjectURL(blob);

                    // 4. æ›´æ–° UI
                    actionBtn.textContent = "ä¸‹è¼‰ HTML å ±å‘Š";
                    actionBtn.classList.add('download');
                    actionBtn.disabled = false;
                    statusDiv.textContent = `æˆåŠŸè§£æ ${sections.length} å€‹å€å¡Šï¼`;

                } catch (err) {
                    statusDiv.textContent = "éŒ¯èª¤: " + err.message;
                    statusDiv.style.color = "red";
                    actionBtn.textContent = "é‡è©¦";
                    actionBtn.disabled = false;
                }
            };
            reader.readAsText(selectedFile);
        }

        // --- æ ¸å¿ƒè§£æé‚è¼¯ ---
        function parseLog(text) {
            // å®šç¾©åˆ†éš”ç·šæ­£å‰‡è¡¨é”å¼ï¼š80å€‹ç­‰è™Ÿï¼Œæ›è¡Œï¼Œ[ SECTION ] æ¨™é¡Œï¼Œå†æ›è¡Œï¼Œ80å€‹ç­‰è™Ÿ
            // ä½¿ç”¨ capturing group ( ) ä¾†ä¿ç•™æ¨™é¡Œ
            const regex = /={50,}\n\s*\[ SECTION \] (.*?)\n={50,}\n/g;
            
            const sections = [];
            let lastIndex = 0;
            let match;

            // å¦‚æœæª”æ¡ˆé–‹é ­æ²’æœ‰åˆ†éš”ç·šï¼Œå°‡é–‹é ­è¦–ç‚º "Preamble"
            // æˆ‘å€‘ä½¿ç”¨ exec å¾ªç’°å°‹æ‰¾æ‰€æœ‰æ¨™é¡Œ
            while ((match = regex.exec(text)) !== null) {
                const title = match[1].trim(); // æ¨™é¡Œ
                const startIndex = match.index;
                const endIndex = regex.lastIndex;

                // æ•æ‰å‰ä¸€æ®µå…§å®¹ (å¦‚æœæ˜¯ç¬¬ä¸€æ®µï¼Œå°±æ˜¯ header ä¹‹å‰çš„å…§å®¹)
                if (startIndex > lastIndex) {
                    const content = text.substring(lastIndex, startIndex).trim();
                    if (content) {
                        // åªæœ‰ç•¶é€™ä¸æ˜¯ç¬¬ä¸€æ®µæˆ–è€…æœ‰å…§å®¹æ™‚æ‰æ·»åŠ 
                        if (sections.length > 0) {
                            sections[sections.length - 1].content = content;
                        } else {
                            // é€™æ˜¯æª”æ¡ˆæœ€é–‹é ­çš„è³‡è¨Š (å¦‚æœæœ‰)
                            sections.push({ title: "File Header / Meta", content: content, id: "header" });
                        }
                    }
                }

                // æº–å‚™æ–°çš„å€å¡Šï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç’°å¡«å…¥ content
                // ç”¢ç”Ÿä¸€å€‹å®‰å…¨çš„ ID ç”¨æ–¼éŒ¨é»
                const safeId = "sec-" + Math.random().toString(36).substr(2, 9);
                sections.push({ title: title, content: "", id: safeId });
                
                lastIndex = endIndex;
            }

            // æ•æ‰æœ€å¾Œä¸€æ®µå…§å®¹
            if (lastIndex < text.length) {
                const content = text.substring(lastIndex).trim();
                if (sections.length > 0) {
                    sections[sections.length - 1].content = content;
                }
            }

            return sections;
        }

        // --- HTML å ±å‘Šç”Ÿæˆå™¨ (å…§åµŒ CSS/JS) ---
        function generateReportHtml(filename, sections) {
            const dateStr = new Date().toLocaleString();
            
            // ç”Ÿæˆå°èˆªé¸å–® HTML
            const navHtml = sections.map(sec => 
                `<a href="#${sec.id}" class="nav-link">${sec.title}</a>`
            ).join('');

            // ç”Ÿæˆä¸»è¦å…§å®¹ HTML
            const contentHtml = sections.map(sec => `
                <div id="${sec.id}" class="section-card">
                    <div class="section-header">
                        <h2>${sec.title}</h2>
                        <button class="copy-btn" onclick="copyToClipboard('${sec.id}')">è¤‡è£½å…§å®¹</button>
                    </div>
                    <div class="section-body">
                        <pre id="pre-${sec.id}">${escapeHtml(sec.content)}</pre>
                    </div>
                </div>
            `).join('');

            return `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å ±å‘Š: ${filename}</title>
    <style>
        :root { --sidebar-width: 280px; --primary: #2b6cb0; --bg: #f7fafc; --text: #2d3748; }
        body { margin: 0; display: flex; height: 100vh; font-family: Consolas, Monaco, "Courier New", monospace; color: var(--text); background: var(--bg); overflow: hidden; }
        
        /* å´é‚Šå°èˆª */
        aside { width: var(--sidebar-width); background: #1a202c; color: #e2e8f0; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-header { padding: 1.5rem; background: #2d3748; border-bottom: 1px solid #4a5568; }
        .nav-header h3 { margin: 0; font-size: 1rem; color: white; word-break: break-all; }
        .nav-header span { font-size: 0.75rem; color: #a0aec0; }
        .nav-list { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-link { display: block; padding: 0.75rem 1.5rem; color: #cbd5e0; text-decoration: none; font-size: 0.85rem; border-left: 3px solid transparent; transition: 0.2s; }
        .nav-link:hover { background: #2d3748; color: white; }
        .nav-link:focus { outline: none; background: #2d3748; }
        
        /* ä¸»è¦å…§å®¹å€ */
        main { flex: 1; overflow-y: auto; padding: 2rem; scroll-behavior: smooth; position: relative; }
        
        .section-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 2rem; border: 1px solid #e2e8f0; overflow: hidden; }
        .section-header { background: #edf2f7; padding: 0.75rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .section-header h2 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        .copy-btn { background: white; border: 1px solid #cbd5e0; padding: 4px 12px; font-size: 0.75rem; border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { background: #ebf8ff; color: var(--primary); border-color: var(--primary); }
        
        .section-body { padding: 0; overflow-x: auto; }
        pre { margin: 0; padding: 1.5rem; font-size: 0.85rem; line-height: 1.5; color: #1a202c; }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { width: 100%; height: 200px; }
        }
    </style>
</head>
<body>
    <aside>
        <div class="nav-header">
            <h3>${filename}</h3>
            <span>ç”Ÿæˆæ–¼: ${dateStr}</span>
        </div>
        <nav class="nav-list">
            ${navHtml}
        </nav>
    </aside>
    <main>
        ${contentHtml}
        <div style="text-align: center; color: #a0aec0; padding: 2rem;">End of Report</div>
    </main>
    <script>
        function copyToClipboard(id) {
            const text = document.getElementById('pre-' + id).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('å…§å®¹å·²è¤‡è£½');
            });
        }
    </script>
</body>
</html>`;
        }

        // è¼”åŠ©å‡½å¼ï¼šè·³è„« HTML ç‰¹æ®Šå­—å…ƒé˜²æ­¢ XSS
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>