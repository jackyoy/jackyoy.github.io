<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitor Log Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 30px; background: #f8f9fa; }
        .container { max-width: 1100px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .controls { margin-bottom: 25px; display: flex; gap: 12px; }
        #canvas-container { background: #fff; padding: 10px; border: 1px solid #eee; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 6px; background: #2c3e50; color: white; font-weight: 600; transition: 0.2s; }
        button:hover { background: #34495e; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        input[type="file"] { border: 1px solid #ddd; padding: 7px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="container" id="report-area">
    <div class="header">
        <h2>設備效能監控報告</h2>
    </div>
    
    <div class="controls">
        <input type="file" id="fileInput" accept=".log,.txt">
        <button id="exportBtn" disabled>下載 PDF 報告</button>
    </div>

    <div id="canvas-container">
        <canvas id="monitorChart"></canvas>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const exportBtn = document.getElementById('exportBtn');
    let chartInstance = null;

    fileInput.addEventListener('change', handleFile);
    exportBtn.addEventListener('click', exportToPDF);

    async function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const text = await file.text();
        const data = parseLog(text);

        if (data.labels.length > 0) {
            renderChart(data);
            exportBtn.disabled = false;
        } else {
            alert('解析失敗：未找到符合格式的日誌數據。');
        }
    }

    function parseLog(content) {
        const labels = [];
        const cpuValues = [];
        const ramValues = [];
        
        // 分別匹配時間、CPU、RAM
        const timeRegex = /\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/g;
        const cpuRegex = /CPU Load \(1min\):\s*([\d.]+)/g;
        const ramRegex = /RAM Used:\s*([\d.]+)/g;
        
        let t, c, r;
        // 循環提取每一組數據
        while ((t = timeRegex.exec(content)) !== null && 
               (c = cpuRegex.exec(content)) !== null && 
               (r = ramRegex.exec(content)) !== null) {
            labels.push(t[1]);
            cpuValues.push(parseFloat(c[1]));
            ramValues.push(parseFloat(r[1]));
        }

        return { labels, cpuValues, ramValues };
    }

    function renderChart(data) {
        const ctx = document.getElementById('monitorChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'CPU Load (%)',
                        data: data.cpuValues,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        yAxisID: 'y',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2
                    },
                    {
                        label: 'RAM Used (GiB)',
                        data: data.ramValues,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        yAxisID: 'y1',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'CPU 負載 (%)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: '記憶體使用 (GiB)' }
                    }
                }
            }
        });
    }

    async function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById('report-area');
        const controls = document.querySelector('.controls');
        
        controls.style.visibility = 'hidden';

        const canvas = await html2canvas(element, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        
        const pdf = new jsPDF('l', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 10, pdfWidth, pdfHeight);
        pdf.save('System_Performance_Report.pdf');
        
        controls.style.visibility = 'visible';
    }
</script>

</body>
</html>