<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>System Monitor Interactive Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 30px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .info { color: #666; font-size: 0.9em; margin-top: 10px; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; margin-right: 10px; }
        .btn-upload { background: #007bff; color: white; }
        .btn-download { background: #28a745; color: white; }
        canvas { max-height: 600px; }
    </style>
</head>
<body>

<div class="container">
    <h2>設備效能互動式報告</h2>
    <div class="controls" id="ui-controls">
        <input type="file" id="fileInput" accept=".log,.txt">
        <button class="btn-download" id="saveHtmlBtn" style="display:none;">儲存為互動 HTML 報告</button>
        <p class="info">提示：上傳 Log 後即可預覽並導出互動式報告檔。</p>
    </div>
    <canvas id="monitorChart"></canvas>
</div>

<script>
    let chartInstance = null;
    let lastData = null;

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const text = await file.text();
        lastData = parseLog(text);
        renderChart(lastData);
        document.getElementById('saveHtmlBtn').style.display = 'inline-block';
    });

    document.getElementById('saveHtmlBtn').addEventListener('click', () => {
        generateStandaloneHtml();
    });

    function parseLog(content) {
        const labels = [], cpu = [], ram = [];
        const tRegex = /\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/g;
        const cRegex = /CPU Load \(1min\):\s*([\d.]+)/g;
        const rRegex = /RAM Used:\s*([\d.]+)/g;
        let t, c, r;
        while ((t = tRegex.exec(content)) && (c = cRegex.exec(content)) && (r = rRegex.exec(content))) {
            labels.push(t[1]); cpu.push(parseFloat(c[1])); ram.push(parseFloat(r[1]));
        }
        return { labels, cpu, ram };
    }

    function renderChart(data) {
        const ctx = document.getElementById('monitorChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'CPU Load (%)', data: data.cpu, borderColor: '#e74c3c', yAxisID: 'y', pointRadius: 2 },
                    { label: 'RAM Used (GiB)', data: data.ram, borderColor: '#3498db', yAxisID: 'y1', pointRadius: 2 }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'CPU (%)' } },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'RAM (GiB)' }, grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    function generateStandaloneHtml() {
        // 取得當前 HTML 並注入已解析的數據
        const dataJson = JSON.stringify(lastData);
        const reportHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Report - Generated</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h2>系統效能歷史報告 (${new Date().toLocaleString()})</h2>
        <canvas id="c"></canvas>
    </div>
    <script>
        const data = ${dataJson};
        const ctx = document.getElementById('c').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'CPU (%)', data: data.cpu, borderColor: '#e74c3c', yAxisID: 'y' },
                    { label: 'RAM (GiB)', data: data.ram, borderColor: '#3498db', yAxisID: 'y1' }
                ]
            },
            options: { 
                interaction: { mode: 'index', intersect: false },
                scales: { 
                    y: { position: 'left' }, 
                    y1: { position: 'right', grid: { drawOnChartArea: false } } 
                } 
            }
        });
    <\/script>
</body>
</html>`;

        const blob = new Blob([reportHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Performance_Report_${Date.now()}.html`;
        a.click();
    }
</script>
</body>
</html>